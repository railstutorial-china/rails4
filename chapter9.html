<!doctype html>
<html lang="zh_CN">
<head>
	<meta charset="utf-8" />
	<title>第 9 章 更新、显示和删除用户</title>
    <meta name="author" content="Andor Chen" />
    <link rel="stylesheet" href="assets/styles/style.css" />
    <script type="text/javascript" src="http://cdn.staticfile.org/jquery/1.8.2/jquery.min.js"></script>
    <script type="text/javascript" src="assets/js/global.js"></script>
</head>

<body>
	<div class="wrapper">
		<div class="header">
            <h1 class="logo"><a class="ir" href="http://railstutorial-china.org/rails4">Ruby on Rails 教程</a></h1>
            <p class="subtitle">Ruby on Rails Tutorial 原书第 2 版（涵盖 Rails 4）</p>
        </div>
        <div class="content">
			
<div class="item chapter">
	<h1 id="chapter-9"><span>第 9 章</span> 更新、显示和删除用户</h1>
	<ol class="toc">          <li class="level-2">
            <a href="#section-9-1">9.1 更新用户</a>
          </li>
          <li class="level-3">
            <a href="#section-9-1-1">9.1.1 编辑表单</a>
          </li>
          <li class="level-3">
            <a href="#section-9-1-2">9.1.2 编辑失败</a>
          </li>
          <li class="level-3">
            <a href="#section-9-1-3">9.1.3 编辑成功</a>
          </li>
          <li class="level-2">
            <a href="#section-9-2">9.2 权限限制</a>
          </li>
          <li class="level-3">
            <a href="#section-9-2-1">9.2.1 必须先登录</a>
          </li>
          <li class="level-3">
            <a href="#section-9-2-2">9.2.2 用户只能编辑自己的资料</a>
          </li>
          <li class="level-3">
            <a href="#section-9-2-3">9.2.3 更友好的转向</a>
          </li>
          <li class="level-2">
            <a href="#section-9-3">9.3 列出所有用户</a>
          </li>
          <li class="level-3">
            <a href="#section-9-3-1">9.3.1 用户列表</a>
          </li>
          <li class="level-3">
            <a href="#section-9-3-2">9.3.2 示例用户</a>
          </li>
          <li class="level-3">
            <a href="#section-9-3-3">9.3.3 分页</a>
          </li>
          <li class="level-3">
            <a href="#section-9-3-4">9.3.4 视图重构</a>
          </li>
          <li class="level-2">
            <a href="#section-9-4">9.4 删除用户</a>
          </li>
          <li class="level-3">
            <a href="#section-9-4-1">9.4.1 管理员</a>
          </li>
          <li class="level-3">
            <a href="#section-9-4-2">9.4.2 destroy 动作</a>
          </li>
          <li class="level-2">
            <a href="#section-9-5">9.5 小结</a>
          </li>
          <li class="level-2">
            <a href="#section-9-6">9.6 练习</a>
          </li>
</ol>
  	<div class="main">
  		<p>本章我们要完成<a href="chapter7.html#table-7-1">表格 7.1</a>所示的Users 资源，添加 <code>edit</code>、<code>update</code>、<code>index</code> 和 <code>destroy</code> 动作。首先我们要实现更新用户个人资料的功能，实现这样的功能自然要依靠安全验证系统（基于<a href="chapter8.html">第 8 章</a>中实现的权限限制））。然后要创建一个页面列出所有的用户（也需要权限限制），期间会介绍示例数据和分页功能。最后，我们还要实现删除用户的功能，从数据库中删除用户记录。我们不会为所有用户都提供这种强大的权限，而是会创建管理员，授权他们来删除用户。</p>

<p>在开始之前，我们要新建 <code>updating-users</code> 分支：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>git checkout -b updating-users
</pre></div>
</div>
<h2 id='section-9-1'><span>9.1</span> 更新用户</h2>


<p>编辑用户信息的方法和创建新用户差不多（参见<a href="chapter7.html">第 7 章</a>），创建新用户的页面是在 <code>new</code> 动作中处理的，而编辑用户的页面则是在 <code>edit</code> 动作中；创建用户的过程是在 <code>create</code> 动作中处理了 <code>POST</code> 请求，而编辑用户要在 <code>update</code> 动作中处理 <code>PATCH</code> 请求（HTTP 请求参见<a href="chapter3.html#aside-3-3">旁注 3.3</a>）。二者之间最大的区别是，任何人都可以注册，但只有当前用户才能更新他自己的信息。所以我们就要限制访问，只有授权的用户才能编辑更新资料，我们可以利用<a href="chapter8.html">第 8 章</a>实现的身份验证机制，使用”事前过滤器（before filter）“实现访问限制。</p>

<h3 id='section-9-1-1'><span>9.1.1</span> 编辑表单</h3>


<p>我们先来创建编辑表单，其构思图如图 9.1 所示。<sup class="footnote" id="fnref-9-1"><a href="#fn-9-1" rel="footnote">1</a></sup>和之前一样，我们要先编写测试。注意构思图中修改 Gravatar 头像的链接，如果你浏览过 Gravatar 的网站，可能就知道上传和编辑头像的地址是 http://gravatar.com/emails，我们就来测试编辑页面中有没有一个链接指向了这个地址。<sup class="footnote" id="fnref-9-2"><a href="#fn-9-2" rel="footnote">2</a></sup></p>

<p>对编辑用户表单的测试和第七章练习中的代码 7.31 类似，同样也测试了提交不合法数据后是否会显示错误提示信息，如代码 9.1 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-1"><p class="caption"><span>代码 9.1：</span>用户编辑页面的测试</p><p class="file"><code>spec/requests/user_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">describe</span> <span class="s2">"edit"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"page"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s2">"Update your profile"</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Edit user"</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="ss">href: </span><span class="s1">'http://gravatar.com/emails'</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"with invalid information"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Save changes"</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'error'</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="figure" id="figure-9-1">
  <img src="figures/edit_user_mockup_bootstrap.png" alt="edit user mockup bootstrap" />
  <p class="caption"><span>图 9.1：</span>编辑用户页面的构思图</p>
</div>
<p>程序所需的代码要放在 <code>edit</code> 动作中，我们在<a href="chapter7.html#table-7-1">表格 7.1</a>中列出了，用户编辑页面的地址是 /users/1/edit（假设用户的 id 是 1）。我们介绍过用户的 id 是保存在 <code>params[:id]</code> 中的，所以我们可以按照代码 9.2 所示的方法查找用户。</p>

<div class="codeblock has-caption" id="codeblock-9-2"><p class="caption"><span>代码 9.2：</span>Users 控制器的 <code>edit</code> 方法</p><p class="file"><code>app/controllers/users_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">edit</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>要让测试通过，我们就要编写编辑用户页面的视图，如代码 9.3 所示。仔细观察一下视图代码，它和代码 7.17 中创建新用户页面的视图代码很相似，这就暗示我们要进行重构，把重复的代码移入局部视图。重构会留作练习，详情参见 <a href="chapter9.html#section-9-6">9.6 节</a>。</p>

<div class="codeblock has-caption" id="codeblock-9-3"><p class="caption"><span>代码 9.3：</span>编辑用户页面的视图</p><p class="file"><code>app/views/users/edit.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Edit user"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Update your profile<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span6 offset3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirm Password"</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Save changes"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://gravatar.com/emails"</span><span class="nt">&gt;</span>change<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p>在这段代码中我们再次使用了 <a href="chapter7.html#section-7-3-3">7.3.3 节</a>中创建的 <code>error_messages</code> 局部视图。</p>

<p>添加了视图代码，再加上代码 9.2 中定义的 <code>@user</code> 变量，代码 9.1 中的“编辑页面”测试应该就可以通过了：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb -e <span class="s2">"edit page"</span>
</pre></div>
</div>
<p>编辑用户页面如图 9.2 所示，我们看到 Rails 会自动读取 <code>@user</code> 变量，预先填好了名字和 Email 地址字段。</p>

<div class="figure" id="figure-9-2">
  <img src="figures/edit_page_bootstrap.png" alt="edit page bootstrap" />
  <p class="caption"><span>图 9.2：</span>编辑用户页面，名字和 Email 地址字段已经自动填好了</p>
</div>
<p>查看一下编辑用户页面的源码，我们可以发现的确生成了一个 <code>form</code> 元素，参见代码 9.4。</p>

<div class="codeblock has-caption" id="codeblock-9-4"><p class="caption"><span>代码 9.4：</span>编辑表单的 HTML</p><div class="highlight type-html"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/users/1"</span> <span class="na">class=</span><span class="s">"edit_user"</span> <span class="na">id=</span><span class="s">"edit_user_1"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"_method"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"patch"</span> <span class="nt">/&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<p>留意一下其中的一个隐藏字段：</p>

<div class="codeblock"><div class="highlight type-html"><pre><span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"_method"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"patch"</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<p>因为浏览器本身并不支持发送 <code>PATCH</code> 请求（<a href="chapter7.html#table-7-1">表格 7.1</a>中列出的 REST 动作要用），所以 Rails 就在 <code>POST</code> 请求中使用这个隐藏字段伪造了一个 <code>PATCH</code> 请求。<sup class="footnote" id="fnref-9-3"><a href="#fn-9-3" rel="footnote">3</a></sup></p>

<p>还有一个细节需要注意一下，代码 9.3 和代码 7.17 都使用了相同的 <code>form_for(@user)</code> 来构建表单，那么 Rails 是怎么知道创建新用户要发送 <code>POST</code> 请求，而编辑用户时要发送 <code>PATCH</code> 请求的呢？这个问题的答案是，通过 Active Record 提供的 <code>new_record?</code> 方法可以检测用户是新创建的还是已经存在于数据库中的：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>rails console
<span class="gp">&gt;&gt; </span>User.new.new_record?
<span class="gp">=&gt; </span><span class="nb">true</span>
<span class="gp">&gt;&gt; </span>User.first.new_record?
<span class="gp">=&gt; </span><span class="nb">false</span>
</pre></div>
</div>
<p>所以在使用 <code>form_for(@user)</code> 构建表单时，如果 <code>@user.new_record?</code> 返回 <code>true</code> 则发送 <code>POST</code> 请求，否则就发送 <code>PATCH</code> 请求。</p>

<p>最后，我们还要在导航中添加一个指向编辑用户页面的链接（“设置（Settings）”）。因为只有登录之后才会显示这个页面，所以对“设置”链接的测试要和其他的身份验证测试放在一起，如代码 9.5 所示。（如果能再测试一下没登录时不会显示“设置”链接就更完美了，这会留作练习，参见 <a href="chapter9.html#section-9-6">9.6 节</a>。）</p>

<div class="codeblock has-caption" id="codeblock-9-5"><p class="caption"><span>代码 9.5：</span>添加检测“设置”链接的测试</p><p class="file"><code>spec/requests/authentication_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
    <span class="p">.</span>
    <span class="nf">.</span>
    <span class="p">.</span>
    <span class="nf">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Profile'</span><span class="p">,</span>     <span class="ss">href: </span><span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Settings'</span><span class="p">,</span>    <span class="ss">href: </span><span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign out'</span><span class="p">,</span>    <span class="ss">href: </span><span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">,</span> <span class="ss">href: </span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="p">.</span>
      <span class="nf">.</span>
      <span class="p">.</span>
    <span class="nf">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>为了简化，代码 9.5 中使用 <code>sign_in</code> 帮助方法，这个方法的作用是访问登录页面，提交合法的表单数据，如代码 9.6 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-6"><p class="caption"><span>代码 9.6：</span>用户登录帮助方法</p><p class="file"><code>spec/support/utilities.rb</code></p><div class="highlight type-ruby"><pre><span class="p">.</span>
<span class="nf">.</span>
<span class="p">.</span>
<span class="nf">def</span> <span class="n">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span>
  <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:no_capybara</span><span class="p">]</span>
    <span class="c1"># Sign in when not using Capybara.</span>
    <span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new_remember_token</span>
    <span class="n">cookies</span><span class="p">[</span><span class="ss">:remember_token</span><span class="p">]</span> <span class="o">=</span> <span class="n">remember_token</span>
    <span class="n">user</span><span class="p">.</span><span class="nf">update_attribute</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">,</span> <span class="no">User</span><span class="p">.</span><span class="nf">hash</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
  <span class="k">else</span>
    <span class="n">visit</span> <span class="n">signin_path</span>
    <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span>
    <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with: </span><span class="n">user</span><span class="p">.</span><span class="nf">password</span>
    <span class="n">click_button</span> <span class="s2">"Sign in"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>如上述代码中的注释所说，如果没有使用 Capybara 的话，填写表单的操作是无效的，所以我们提供了 <code>no_capybara: true</code> 选项，跳过默认的登录操作，直接处理 cookie。如果直接使用 HTTP 请求方法就必须要有上面这行代码，具体的用法在代码 9.46 中有介绍。（注意，测试中使用的 <code>cookies</code> 对象和真实的 cookies 对象是有点不一样的，代码 8.19 中使用的 <code>cookies.permanent</code> 方法不能在测试中使用。）你可能已经猜到了，<code>sign_in</code> 在后续的测试中还会用到，而且还可以用来去除重复代码（参见 <a href="chapter9.html#section-9-6">9.6 节</a>）。</p>

<p>在程序中添加“设置”链接很简单，我们就直接使用<a href="chapter7.html#table-7-1">表格 7.1</a> 中列出的 <code>edit_user_path</code> 具名路由，其参数设为代码 8.22 中定义的 <code>current_user</code> 帮助方法：</p>

<div class="codeblock"><div class="highlight type-erb"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>
<p>完整的代码如代码 9.7 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-7"><p class="caption"><span>代码 9.7：</span>添加“设置”链接</p><p class="file"><code>app/views/layouts/_header.html.erb</code></p><div class="highlight type-erb"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-inner"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"logo"</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav pull-right"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"fat-menu"</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
                Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/b&gt;</span>
              <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"divider"</span><span class="nt">&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign out"</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="ss">method: </span><span class="s2">"delete"</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign in"</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div>
<h3 id='section-9-1-2'><span>9.1.2</span> 编辑失败</h3>


<p>本小节我们要处理编辑失败的情况，让代码 9.1 中对错误提示信息的测试通过。我们要在 Users 控制器的 <code>update</code> 动作中使用 <code>update_attributes</code> 方法，传入提交的 <code>params</code> Hash，更新用户记录，如代码 9.8 所示。如果提交了不合法的数据，更新操作会返回 <code>false</code>，交由 <code>else</code> 分支处理，重新渲染编辑用户页面。我们之前用过类似的处理方式，代码结构和第一个版本的 <code>create</code> 动作类似（参见代码 7.21）。</p>

<div class="codeblock has-caption" id="codeblock-9-8"><p class="caption"><span>代码 9.8：</span>还不完整的 <code>update</code> 动作</p><p class="file"><code>app/controllers/users_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">edit</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="c1"># Handle a successful update.</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>注意，在调用 <code>update_attributes</code> 方法时指定的 <code>user_params</code> 参数，这种用法是“健壮参数”（strong parameter），可以避免 mass assignment 漏洞（参见 <a href="chapter7.html#section-7-3-2">7.3.2 节</a>）。</p>

<div class="figure" id="figure-9-3">
  <img src="figures/edit_with_invalid_information_bootstrap.png" alt="edit with invalid information bootstrap" />
  <p class="caption"><span>图 9.3：</span>提交编辑表单后显示的错误提示信息</p>
</div>
<p>提交不合法信息后显示了错误提示信息（如图 9.3），测试就可以通过了，你可以运行测试组件验证一下：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<h3 id='section-9-1-3'><span>9.1.3</span> 编辑成功</h3>


<p>现在我们要让编辑表单能够正常使用了。编辑头像的功能已经实现了，因为我们把上传头像的操作交由 Gravatar 处理了，如需更换头像，点击图 9.2 中的“change”链接就可以了，如图 9.4 所示。下面我们来实现编辑其他信息的功能。</p>

<div class="figure" id="figure-9-4">
  <img src="figures/gravatar_cropper.png" alt="gravatar cropper" />
  <p class="caption"><span>图 9.4：</span>Gravatar 的剪切图片界面，上传了一个帅哥的图片</p>
</div>
<p>对 <code>update</code> 动作的测试和对 <code>create</code> 的测试类似。代码 9.9 介绍了如何使用 Capybara 在表单中填写合法的数据，还介绍了怎么测试提交表单的操作是否正确。测试的代码很多，你可以参考<a href="chapter7.html">第 7 章</a>中的测试，试一下能不能完全理解。</p>

<div class="codeblock has-caption" id="codeblock-9-9"><p class="caption"><span>代码 9.9：</span>测试 Users 控制器的 <code>update</code> 动作</p><p class="file"><code>spec/requests/user_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">describe</span> <span class="s2">"edit"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="p">.</span>
    <span class="nf">.</span>
    <span class="p">.</span>
    <span class="nf">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:new_name</span><span class="p">)</span>  <span class="p">{</span> <span class="s2">"New Name"</span> <span class="p">}</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:new_email</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"new@example.com"</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">"Name"</span><span class="p">,</span>             <span class="ss">with: </span><span class="n">new_name</span>
        <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>            <span class="ss">with: </span><span class="n">new_email</span>
        <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span>         <span class="ss">with: </span><span class="n">user</span><span class="p">.</span><span class="nf">password</span>
        <span class="n">fill_in</span> <span class="s2">"Confirm Password"</span><span class="p">,</span> <span class="ss">with: </span><span class="n">user</span><span class="p">.</span><span class="nf">password</span>
        <span class="n">click_button</span> <span class="s2">"Save changes"</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-success'</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign out'</span><span class="p">,</span> <span class="ss">href: </span><span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">name</span><span class="p">).</span><span class="nf">to</span>  <span class="n">eq</span> <span class="n">new_name</span> <span class="p">}</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">email</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="n">new_email</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>上述代码中出现了一个新的方法 <code>reload</code>，出现在检测用户的属性是否已经更新的测试中：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">name</span><span class="p">).</span><span class="nf">to</span>  <span class="o">==</span> <span class="n">new_name</span> <span class="p">}</span>
<span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">email</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="n">new_email</span> <span class="p">}</span>
</pre></div>
</div>
<p>这两行代码使用 <code>user.reload</code> 从测试数据库中重新加载 <code>user</code> 的数据，然后检测用户的名字和 Email 地址是否更新成了新的值。</p>

<p>要让代码 9.9 中的测试通过，我们可以参照最终版本的 <code>create</code> 动作（代码 8.27）来编写 <code>update</code> 动作，如代码 9.10 所示。我们在代码 9.8 的基础上加入了下面这三行。</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">flash</span><span class="p">[</span><span class="ss">:success</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Profile updated"</span>
<span class="n">sign_in</span> <span class="vi">@user</span>
<span class="n">redirect_to</span> <span class="vi">@user</span>
</pre></div>
</div>
<div class="codeblock has-caption" id="codeblock-9-10"><p class="caption"><span>代码 9.10：</span>Users 控制器的 <code>update</code> 动作</p><p class="file"><code>app/controllers/users_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">flash</span><span class="p">[</span><span class="ss">:success</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Profile updated"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>注意，现在这种实现方式，每次更新数据都要提供密码（填写图 9.2 中那两个空的字段），虽然有点烦人，不过却保证了安全。</p>

<p>添加了本小节的代码之后，编辑用户页面应该可以正常使用了，你可以运行测试组件再确认一下，测试应该是可以通过的：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<h2 id='section-9-2'><span>9.2</span> 权限限制</h2>


<p><a href="chapter8.html">第 8 章</a>中实现的身份验证机制有一个很好的作用，可以实现权限限制。身份验证可以识别用户是否已经注册，而权限限制则可以限制用户可以进行的操作。</p>

<p>虽然 <a href="chapter9.html#section-9-1">9.1 节</a>中已经基本完成了 <code>edit</code> 和 <code>update</code> 动作，但是却有一个安全隐患：任何人（甚至是未登录的用户）都可以访问这两个动作，而且登录后的用户可以更新所有其他用户的资料。本节我们要实现一种安全机制，限制用户必须先登录才能更新自己的资料，而不能更新他人的资料。没有登录的用户如果试图访问这些受保护的页面，会转向登录页面，并显示一个提示信息，构思图如图 9.5 所示。</p>

<h3 id='section-9-2-1'><span>9.2.1</span> 必须先登录</h3>


<p>因为对 <code>edit</code> 和 <code>update</code> 动作所做的安全限制是一样的，所以我们就在同一个 RSpec <code>describe</code> 块中进行测试。我们从要求登录开始，测试代码要检测未登录的用户试图访问这两个动作时是否转向了登录页面，如代码 9.11 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-11"><p class="caption"><span>代码 9.11：</span>测试 <code>edit</code> 和 <code>update</code> 动作是否处于被保护状态</p><p class="file"><code>spec/requests/authentication_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"in the Users controller"</span> <span class="k">do</span>

        <span class="n">describe</span> <span class="s2">"visiting the edit page"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"submitting to the update action"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>代码 9.11 除了使用 Capybara 的 <code>visit</code> 方法之外，还第一次使用了另一种访问控制器动作的方法：如果需要直接发起某种 HTTP 请求，则直接使用 HTTP 动词对应的方法即可，例如本例中的 <code>patch</code> 发起的就是 <code>PATCH</code> 请求：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">describe</span> <span class="s2">"submitting to the update action"</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>
<p>上述代码会向 /users/1 地址发送 <code>PATCH</code> 请求，由 Users 控制器的 <code>update</code> 动作处理（参见<a href="chapter7.html#table-7-1">表格 7.1</a>）。我们必须这么做，因为浏览器无法直接访问 <code>update</code> 动作，必须先提交编辑表单，所以 Capybara 也做不到。访问编辑资料页面只能测试 <code>edit</code> 动作是否有权限继续操作，而不能测试 <code>update</code> 动作的授权情况。所以，如果要测试 <code>update</code> 动作是否有权限进行操作只能直接发送 <code>PATCH</code> 请求。（你可能已经猜到了，除了 <code>patch</code> 方法之外，Rails 中的测试还支持 <code>get</code>、<code>post</code> 和 <code>delete</code> 方法。）</p>

<p>直接发送某种 HTTP 请求时，我们需要处理更底层的 <code>response</code> 对象。和 Capybara 提供的 <code>page</code> 对象不同，我们可以使用 <code>response</code> 测试服务器的响应。本例我们检测了 <code>update</code> 动作的响应是否转向了登录页面：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
<div class="figure" id="figure-9-5">
  <img src="figures/signin_page_protected_mockup_bootstrap.png" alt="signin page protected mockup bootstrap" />
  <p class="caption"><span>图 9.5：</span>访问受保护页面转向后的页面构思图</p>
</div>
<p>我们要使用 <code>before_action</code> 方法实现权限限制，这个方法会在指定的动作执行之前，先运行指定的方法。为了实现要求用户先登录的限制，我们要定义一个名为 <code>signed_in_user</code> 的方法，然后调用 <code>before_action :signed_in_user</code>，如代码 9.12 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-12"><p class="caption"><span>代码 9.12：</span>添加 <code>signed_in_user</code> 事前过滤器</p><p class="file"><code>app/controllers/users_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">signed_in_user</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Before filters</span>

    <span class="k">def</span> <span class="nf">signed_in_user</span>
      <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice: </span><span class="s2">"Please sign in."</span> <span class="k">unless</span> <span class="n">signed_in?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>默认情况下，事前过滤器会应用于控制器中的所有动作，所以在上述代码中我们传入了 <code>:only</code> 参数指定只应用在 <code>edit</code> 和 <code>update</code> 动作上。</p>

<div class="figure" id="figure-9-6">
  <img src="figures/protected_sign_in_bootstrap.png" alt="protected sign in bootstrap" />
  <p class="caption"><span>图 9.6：</span>尝试访问受保护的页面后显示的登录表单</p>
</div>
<p>注意，在代码 9.12 中我们使用了设定 <code>flash[:notice]</code> 的简便方式，把 <code>redirect_to</code> 方法的第二个参数指定为一个 Hash。这段代码等同于：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="k">unless</span> <span class="n">signed_in?</span>
  <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Please sign in."</span>
  <span class="n">redirect_to</span> <span class="n">signin_url</span>
<span class="k">end</span>
</pre></div>
</div>
<p>（<code>flash[:error]</code> 也可以使用上述的简便方式，但 <code>flash[:success]</code> 却不可以。）</p>

<p><code>flash[:notice]</code> 加上 <code>flash[:success]</code> 和 <code>flash[:error]</code> 就是我们要介绍的三种 Flash 消息，Bootstrap 为这三种消息都提供了样式。退出后再尝试访问 /users/1/edit，就会看到如图 9.6 所示的黄色提示框。</p>

<p>现在所有的测试应该都可以通过了：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<h3 id='section-9-2-2'><span>9.2.2</span> 用户只能编辑自己的资料</h3>


<p>当然，要求用户必须先登录还是不够的，用户必须只能编辑自己的资料。我们的测试可以这么编写，用其他用户的身份登录，然后访问 <code>edit</code> 和 <code>update</code> 动作，如代码 9.13 所示。注意，这段测试我们不用 Capybara（<code>no_capybara: true</code>）,而使用 <code>get</code> 和 <code>patch</code> 方法直接访问 <code>edit</code> 和 <code>update</code> 动作。而且，用户不应该尝试编辑其他用户的资料，我们没有转向登录页面，而是转到了网站的首页。</p>

<div class="codeblock has-caption" id="codeblock-9-13"><p class="caption"><span>代码 9.13：</span>测试只有自己才能访问 <code>edit</code> 和 <code>update</code> 动作</p><p class="file"><code>spec/requests/authentication_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>
    <span class="p">.</span>
    <span class="nf">.</span>
    <span class="p">.</span>
    <span class="nf">describe</span> <span class="s2">"as wrong user"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:wrong_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"wrong@example.com"</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span><span class="p">,</span> <span class="ss">no_capybara: </span><span class="kp">true</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"submitting a GET request to the Users#edit action"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">get</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">wrong_user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">).</span><span class="nf">not_to</span> <span class="n">match</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Edit user'</span><span class="p">))</span> <span class="p">}</span>
        <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">"submitting a PATCH request to the Users#update action"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="n">wrong_user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>注意，创建预构件的方法还可以接受第二个参数：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"wrong@example.com"</span><span class="p">)</span>
</pre></div>
</div>
<p>上述代码会用指定的 Email 替换默认值，然后创建用户。我们的测试要确保其他的用户不能访问原来那个用户的 <code>edit</code> 和 <code>update</code> 动作。</p>

<p>我们在控制器中加入了第二个事前过滤器，调用 <code>correct_user</code> 方法，如代码 9.14 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-14"><p class="caption"><span>代码 9.14：</span>保护 <code>edit</code> 和 <code>update</code> 动作的 <code>correct_user</code> 事前过滤器</p><p class="file"><code>app/controllers/users_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">signed_in_user</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">correct_user</span><span class="p">,</span>   <span class="ss">only: </span><span class="p">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">edit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">flash</span><span class="p">[</span><span class="ss">:success</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Profile updated"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Before filters</span>

    <span class="k">def</span> <span class="nf">signed_in_user</span>
      <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice: </span><span class="s2">"Please sign in."</span> <span class="k">unless</span> <span class="n">signed_in?</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>上述代码中的 <code>correct_user</code> 方法使用了 <code>current_user?</code> 方法，我们要在 Sessions 帮助方法模块中定义一下，如代码 9.15。</p>

<div class="codeblock has-caption" id="codeblock-9-15"><p class="caption"><span>代码 9.15：</span>定义 <code>current_user?</code> 方法</p><p class="file"><code>app/helpers/sessions_helper.rb</code></p><div class="highlight type-ruby"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">current_user</span>
    <span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">hash</span><span class="p">(</span><span class="n">cookies</span><span class="p">[</span><span class="ss">:remember_token</span><span class="p">])</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">remember_token: </span><span class="n">remember_token</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>代码 9.14 同时也更新了 <code>edit</code> 和 <code>update</code> 动作的代码。之前在代码 9.2 中，我们是这样写的：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="k">def</span> <span class="nf">edit</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
<span class="k">end</span>
</pre></div>
</div>
<p><code>update</code> 代码类似。既然 <code>correct_user</code> 事前过滤器中已经定义了 <code>@user</code>，这两个动作中就不再需要再定义 <code>@user</code> 变量了。</p>

<p>在继续阅读之前，你应该验证一下测试是否可以通过：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<h3 id='section-9-2-3'><span>9.2.3</span> 更友好的转向</h3>


<p>程序的权限限制基本完成了，但是还有一点小小的不足：不管用户尝试访问的是哪个受保护的页面，登录后都会转向资料页面。也就是说，如果未登录的用户访问了编辑资料页面，会要求先登录，登录转到的页面是 /users/1，而不是 <code>/users/1/edit</code>。如果登录后能转到用户之前想访问的页面就更好了。</p>

<p>针对这种更友好的转向，我们可以这样编写测试，先访问编辑用户资料页面，转向登录页面后，填写正确的登录信息，点击“Sign in”按钮，然后显示的应该是编辑用户资料页面，而不是用户资料页面。相应的测试如代码 9.16 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-16"><p class="caption"><span>代码 9.16：</span>测试更友好的转向</p><p class="file"><code>spec/requests/authentication_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"when attempting to visit a protected page"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
          <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span>
          <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with: </span><span class="n">user</span><span class="p">.</span><span class="nf">password</span>
          <span class="n">click_button</span> <span class="s2">"Sign in"</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"after signing in"</span> <span class="k">do</span>

          <span class="n">it</span> <span class="s2">"should render the desired protected page"</span> <span class="k">do</span>
            <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Edit user'</span><span class="p">)</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="p">.</span>
      <span class="nf">.</span>
      <span class="p">.</span>
    <span class="nf">end</span>
    <span class="p">.</span>
    <span class="nf">.</span>
    <span class="p">.</span>
  <span class="nf">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>下面我们来实现这个设想。<sup class="footnote" id="fnref-9-4"><a href="#fn-9-4" rel="footnote">4</a></sup>要转向用户真正想访问的页面，我们要在某个地方存储这个页面的地址，登录后再转向这个页面。我们要通过两个方法来实现这个过程，<code>store_location</code> 和 <code>redirect_back_or</code>，都在 Sessions 帮助方法模块中定义，如代码 9.17。</p>

<div class="codeblock has-caption" id="codeblock-9-17"><p class="caption"><span>代码 9.17：</span>实现更友好的转向所需的代码</p><p class="file"><code>app/helpers/sessions_helper.rb</code></p><div class="highlight type-ruby"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">redirect_back_or</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
    <span class="n">redirect_to</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="ss">:return_to</span><span class="p">]</span> <span class="o">||</span> <span class="n">default</span><span class="p">)</span>
    <span class="n">session</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="ss">:return_to</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">store_location</span>
    <span class="n">session</span><span class="p">[</span><span class="ss">:return_to</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">fullpath</span> <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">get?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>地址的存储使用了 Rails 提供的 <code>session</code>，<code>session</code> 可以理解成和 <a href="chapter8.html#section-8-2-1">8.2.1 节</a>中介绍的 <code>cookies</code> 是类似的东西，会在浏览器关闭后自动失效。（在 <a href="chapter8.html#section-8-5">8.5 节</a>中介绍过，其实 <code>session</code> 的实现方法正是如此。）我们还使用了 <code>request</code> 对象的 <code>fullpath</code> 方法获取了所请求页面的完整地址。在 <code>store_location</code> 方法中，把完整的请求地址存储在 <code>session[:return_to]</code> 中。但这个方法只能在 <code>GET</code> 请求中使用（<code>if request.get?</code>）。这么做，当未登录的用户提交表单时，不会存储转向地址（这种情况虽然很罕见，但在提交表单前，如果用户手动删除了记忆权标，还是会发生的），那么本来期望接收 <code>POST</code>、<code>PATCH</code> 或 <code>DELETE</code> 请求的动作实际收到的却是 <code>GET</code> 请求，就会产生异常。<sup class="footnote" id="fnref-9-5"><a href="#fn-9-5" rel="footnote">5</a></sup></p>

<p>要使用 <code>store_location</code>，我们要把它加入 <code>signed_in_user</code> 事前过滤器中，如代码 9.18 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-18"><p class="caption"><span>代码 9.18：</span>把 <code>store_location</code> 加入 <code>signed_in_user</code> 事前过滤器</p><p class="file"><code>app/controllers/users_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">signed_in_user</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">correct_user</span><span class="p">,</span>   <span class="ss">only: </span><span class="p">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">edit</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Before filters</span>

    <span class="k">def</span> <span class="nf">signed_in_user</span>
      <span class="k">unless</span> <span class="n">signed_in?</span>
        <span class="n">store_location</span>
        <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice: </span><span class="s2">"Please sign in."</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>实现转向操作，要在 Sessions 控制器的 <code>create</code> 动作中加入 <code>redirect_back_or</code> 方法，用户登录后转到适当的页面，如代码 9.19 所示。如果存储了之前请求的地址，<code>redirect_back_or</code> 方法就会转向这个地址，否则会转向参数中指定的地址。</p>

<div class="codeblock has-caption" id="codeblock-9-19"><p class="caption"><span>代码 9.19：</span>加入友好转向后的 <code>create</code> 动作</p><p class="file"><code>app/controllers/sessions_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">email: </span><span class="n">params</span><span class="p">[</span><span class="ss">:session</span><span class="p">][</span><span class="ss">:email</span><span class="p">].</span><span class="nf">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="p">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:session</span><span class="p">][</span><span class="ss">:password</span><span class="p">])</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">redirect_back_or</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="p">.</span><span class="nf">now</span><span class="p">[</span><span class="ss">:error</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>（如果你做了第 8 章的练习 1，记得把代码 9.19 中的 <code>params</code> Hash 换掉。）</p>

<p><code>redirect_back_or</code> 方法在下面这行代码中使用了“或”操作符 <code>||</code>：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">session</span><span class="p">[</span><span class="ss">:return_to</span><span class="p">]</span> <span class="o">||</span> <span class="n">default</span>
</pre></div>
</div>
<p>如果 <code>session[:return_to]</code> 的值不是 <code>nil</code>，上面这行代码就会返回 <code>session[:return_to]</code> 的值，否则会返回 <code>default</code>。注意，在代码 9.17 中，成功转向后就会删除存储在 session 中的转向地址。如果不删除的话，在关闭浏览器之前，每次登录后都会转到存储的地址上。（对这一过程的测试留作练习，参见 <a href="chapter9.html#section-9-6">9.6 节</a>。）</p>

<p>加入上述代码之后，代码 9.16 中对友好转向的集成测试应该可以通过了。至此，我们也就完成了基本的用户身份验证和页面保护机制。和之前一样，在继续阅读之前，最好确认一下所有的测试是否都可以通过：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<div class="figure" id="figure-9-7">
  <img src="figures/user_index_mockup_bootstrap.png" alt="user index mockup bootstrap" />
  <p class="caption"><span>图 9.7：</span>用户列表页面的构思图，包含了分页链接和“Users”导航链接</p>
</div>
<h2 id='section-9-3'><span>9.3</span> 列出所有用户</h2>


<p>本节我们要添加计划中的倒数第二个用户动作，<code>index</code>。<code>index</code> 动作不会显示某一个用户，而是显示所有的用户。在这个过程中，我们要学习如何在数据库中生成示例用户数据，以及如何分页显示用户列表，显示任意数量的用户。用户列表、分页链接和“所有用户（Users）”导航链接的构思图如图 9.7 所示。<sup class="footnote" id="fnref-9-6"><a href="#fn-9-6" rel="footnote">6</a></sup>在 <a href="chapter9.html#section-9-4">9.4 节</a> 中，我们还会在用户列表中添加删除链接，这样就可以删除有问题的用户了。</p>

<h3 id='section-9-3-1'><span>9.3.1</span> 用户列表</h3>


<p>单个用户的资料页面是对外开放的，不过用户列表页面只有注册用户才能访问。我们先来编写测试。在测试中我们要检测 <code>index</code> 动作是被保护的，如果访问 <code>users_path</code> 会转向登录页面。和其他的权限限制测试一样，我们也会把这个测试放在身份验证的集成测试中，如代码 9.20 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-20"><p class="caption"><span>代码 9.20：</span>测试 <code>index</code> 动作是否是被保护的</p><p class="file"><code>spec/requests/authentication_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="p">.</span>
      <span class="nf">.</span>
      <span class="p">.</span>
      <span class="nf">describe</span> <span class="s2">"in the Users controller"</span> <span class="k">do</span>
        <span class="p">.</span>
        <span class="nf">.</span>
        <span class="p">.</span>
        <span class="nf">describe</span> <span class="s2">"visiting the user index"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">users_path</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="p">.</span>
      <span class="nf">.</span>
      <span class="p">.</span>
    <span class="nf">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>若要这个测试通过，我们要把 <code>index</code> 动作加入 <code>signed_in_user</code> 事前过滤器，如代码 9.21 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-21"><p class="caption"><span>代码 9.21：</span>访问 <code>index</code> 动作必须先登录</p><p class="file"><code>app/controllers/users_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">signed_in_user</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">correct_user</span><span class="p">,</span>   <span class="ss">only: </span><span class="p">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">index</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>接下来，我们要测试用户登录后，用户列表页面要有特定的标题和内容，还要列出网站中所有的用户。为此，我们要创建三个用户预构件，以第一个用户的身份登录，然后检测用户列表页面中是否有一个列表，各用户的名字都包含在一个单独的 <code>li</code> 标签中。注意，我们要为每个用户分配不同的名字，这样列表中的用户才是不一样的，如代码 9.22 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-22"><p class="caption"><span>代码 9.22：</span>用户列表页面的测试</p><p class="file"><code>spec/requests/user_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"index"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
      <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"Bob"</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"bob@example.com"</span><span class="p">)</span>
      <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"Ben"</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"ben@example.com"</span><span class="p">)</span>
      <span class="n">visit</span> <span class="n">users_path</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'All users'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'All users'</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">"should list each user"</span> <span class="k">do</span>
      <span class="no">User</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'li'</span><span class="p">,</span> <span class="ss">text: </span><span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>你可能还记得，我们在演示程序的相关代码中介绍过（参见代码 2.4），在程序中我们可以使用 <code>User.all</code> 从数据库中取回所有的用户，赋值给实例变量 <code>@users</code> 在视图中使用，如代码 9.23 所示。（你可能会觉得一次列出所有的用户不太好，你是对的，我们会在 <a href="chapter9.html#section-9-3-3">9.3.3 节</a>中改进。）</p>

<div class="codeblock has-caption" id="codeblock-9-23"><p class="caption"><span>代码 9.23：</span>Users 控制器的 <code>index</code> 动作</p><p class="file"><code>app/controllers/users_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">signed_in_user</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">index</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>要显示用户列表页面，我们要创建一个视图，遍历所有的用户，把单个用户包含在 <code>li</code> 标签中。我们要使用 <code>each</code> 方法遍历所有用户，显示用户的 Gravatar 头像和名字，然后把所有的用户包含在无序列表 <code>ul</code> 标签中，如代码 9.24 所示。在代码 9.24 中，我们用到了 <a href="chapter7.html#section-7-6">7.6 节</a>练习中代码 7.30 的成果，允许向 Gravatar 帮助方法传入第二个参数，指定头像的大小。如果你之前没有做这个练习题，在继续阅读之前请参照代码 7.30 更新 Users 控制器的帮助方法文件。</p>

<div class="codeblock has-caption" id="codeblock-9-24"><p class="caption"><span>代码 9.24：</span>用户列表页面的视图</p><p class="file"><code>app/views/users/index.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size: </span><span class="mi">52</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</pre></div>
</div>
<p>我们再添加一些 CSS（更确切的说是 SCSS）美化一下，如代码 9.25。</p>

<div class="codeblock has-caption" id="codeblock-9-25"><p class="caption"><span>代码 9.25：</span>用户列表页面的 CSS</p><p class="file"><code>app/assets/stylesheets/custom.css.scss</code></p><div class="highlight type-scss"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="o">/*</span> <span class="nt">Users</span> <span class="nt">index</span> <span class="o">*/</span>

<span class="nc">.users</span> <span class="p">{</span>
  <span class="nl">list-style</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
  <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="nt">li</span> <span class="p">{</span>
    <span class="nl">overflow</span><span class="p">:</span> <span class="nb">auto</span><span class="p">;</span>
    <span class="nl">padding</span><span class="p">:</span> <span class="m">10px</span> <span class="m">0</span><span class="p">;</span>
    <span class="nl">border-top</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:last-child</span> <span class="p">{</span>
      <span class="nl">border-bottom</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>最后，我们还要在头部的导航中加入到用户列表页面的链接，链接的地址为 <code>users_path</code>，这是<a href="chapter7.html#table-7-1">表格 7.1</a>中还没介绍的最后一个具名路由了。相应的测试（代码 9.26）和程序所需的代码（代码 9.27）都很简单。</p>

<div class="codeblock has-caption" id="codeblock-9-26"><p class="caption"><span>代码 9.26：</span>检测“Users”链接的测试</p><p class="file"><code>spec/requests/authentication_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
    <span class="p">.</span>
    <span class="nf">.</span>
    <span class="p">.</span>
    <span class="nf">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Users'</span><span class="p">,</span>       <span class="ss">href: </span><span class="n">users_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Profile'</span><span class="p">,</span>     <span class="ss">href: </span><span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Settings'</span><span class="p">,</span>    <span class="ss">href: </span><span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign out'</span><span class="p">,</span>    <span class="ss">href: </span><span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">,</span> <span class="ss">href: </span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="p">.</span>
      <span class="nf">.</span>
      <span class="p">.</span>
    <span class="nf">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="codeblock has-caption" id="codeblock-9-27"><p class="caption"><span>代码 9.27：</span>添加“Users”链接</p><p class="file"><code>app/views/layouts/_header.html.erb</code></p><div class="highlight type-erb"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-inner"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"logo"</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav pull-right"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span> <span class="n">users_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"fat-menu"</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
                Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/b&gt;</span>
              <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"divider"</span><span class="nt">&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign out"</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="ss">method: </span><span class="s2">"delete"</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign in"</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div>
<p>至此，用户列表页面的功能就实现了，所有的测试也都可以通过了：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<p>不过，如图 9.8 所示，页面中只显示了一个用户，有点孤单单。下面，让我们来改变一下这种悲惨状况。</p>

<h3 id='section-9-3-2'><span>9.3.2</span> 示例用户</h3>


<p>在本小节中，我们要为应用程序添加更多的用户。如果要让用户列表看上去像个列表，我们可以在浏览器中访问注册页面，然后一个一个地注册用户，不过还有更好的方法，让 Ruby 和 Rake 为我们创建用户。</p>

<p>首先，我们要在 <code>Gemfile</code> 中加入 <code>faker</code>（如代码 9.28 所示），使用这个 gem，我们可以使用半真实的名字和 Email 地址创建示例用户。</p>

<div class="codeblock has-caption" id="codeblock-9-28"><p class="caption"><span>代码 9.28：</span>把 faker 加入 <code>Gemfile</code></p><div class="highlight type-ruby"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.4'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-sass'</span><span class="p">,</span> <span class="s1">'2.3.2.0'</span>
<span class="n">gem</span> <span class="s1">'bcrypt-ruby'</span><span class="p">,</span> <span class="s1">'3.0.1'</span>
<span class="n">gem</span> <span class="s1">'faker'</span><span class="p">,</span> <span class="s1">'1.1.2'</span>
<span class="p">.</span>
<span class="nf">.</span>
<span class="o">.</span>
</pre></div>
</div>
<div class="figure" id="figure-9-8">
  <img src="figures/user_index_only_one_bootstrap.png" alt="user index only one bootstrap" />
  <p class="caption"><span>图 9.8：</span>用户列表页面，只有一个用户</p>
</div>
<p>然后和之前一样，运行下面的命令安装：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle install
</pre></div>
</div>
<p>接下来我们要添加一个 Rake 任务创建示例用户。这个 Rake 任务保存在 <code>lib/tasks</code> 文件夹中，而且在 <code>:db</code> 命名空间中定义，如代码 9.29 所示。（代码中涉及到一些高级知识，现在不必深入了解。）</p>

<div class="codeblock has-caption" id="codeblock-9-29"><p class="caption"><span>代码 9.29：</span>在数据库中生成示例用户的 Rake 任务</p><p class="file"><code>lib/tasks/sample_data.rake</code></p><div class="highlight type-ruby"><pre><span class="n">namespace</span> <span class="p">:</span><span class="n">db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">"Fill database with sample data"</span>
  <span class="n">task</span> <span class="ss">populate: :environment</span> <span class="k">do</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Example User"</span><span class="p">,</span>
                 <span class="ss">email: </span><span class="s2">"example@railstutorial.org"</span><span class="p">,</span>
                 <span class="ss">password: </span><span class="s2">"foobar"</span><span class="p">,</span>
                 <span class="ss">password_confirmation: </span><span class="s2">"foobar"</span><span class="p">)</span>
    <span class="mi">99</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
      <span class="nb">name</span>  <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="p">.</span><span class="nf">name</span>
      <span class="n">email</span> <span class="o">=</span> <span class="s2">"example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org"</span>
      <span class="n">password</span>  <span class="o">=</span> <span class="s2">"password"</span>
      <span class="no">User</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">name: </span><span class="nb">name</span><span class="p">,</span>
                   <span class="ss">email: </span><span class="n">email</span><span class="p">,</span>
                   <span class="ss">password: </span><span class="n">password</span><span class="p">,</span>
                   <span class="ss">password_confirmation: </span><span class="n">password</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="figure" id="figure-9-9">
  <img src="figures/user_index_all_bootstrap.png" alt="user index all bootstrap" />
  <p class="caption"><span>图 9.9：</span>显示了 100 个用户的用户列表页面（<a href="http://localhost:3000/users">/users</a>）</p>
</div>
<p>上述代码定义了一个名为 <code>db:populate</code> 的 Rake 任务，先创建一个用户替代之前存在的那个用户，然后还创建了 99 个用户。下面这行代码</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">task</span> <span class="ss">populate: :environment</span> <span class="k">do</span>
</pre></div>
</div>
<p>确保这个 Rake 任务可以获取 Rails 环境的信息，包括 User 模型，所以才能使用 <code>User.create!</code> 方法。<code>create!</code> 方法和 <code>create</code> 方法的作用一样，只不过如果提供的信息不合法不会返回 <code>false</code> 而是会抛出异常（参见 <a href="chapter6.html#section-6-1-4">6.1.4 节</a>），这样如果出错的话就很容易找到错误发生的地方。</p>

<p>这个任务是定义在 <code>:db</code> 命名空间中的，所以我们要按照如下的方式来执行：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$ </span>bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div>
</div>
<p>执行这三个任务之后，我们的应用程序就有 100 个用户了，如图 9.9 所示。（我牺牲了一点个人时间为前几个用户上传了头像，这样就不都会显示默认的 Gravatar 头像了。）</p>

<h3 id='section-9-3-3'><span>9.3.3</span> 分页</h3>


<p>现在，当初的用户不再孤单单了，但是又出现了新的问题：用户太多，全在一个页面中显示。现在的用户数量是 100 个，算是少的了，在真实的网站中，这个数量可能是以千计的。为了避免在一页中显示过多的用户，我们可以使用分页功能，一页只显示 30 个用户。</p>

<p>在 Rails 中有很多实现分页的方法，我们要使用其中一个最简单也最完善的，叫做 will_paginate。我们要使用 <code>will_paginate</code> 和 <code>bootstrap-will_paginate</code> 这两个 gem，<code>bootstrap-will_paginate</code> 的作用是设置 will_paginate 使用 Bootstrap 中的分页样式。修改后的 <code>Gemfile</code> 如代码 9.30 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-30"><p class="caption"><span>代码 9.30：</span>在 <code>Gemfile</code> 中加入 will_paginate</p><div class="highlight type-ruby"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.4'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-sass'</span><span class="p">,</span> <span class="s1">'2.3.2.0'</span>
<span class="n">gem</span> <span class="s1">'bcrypt-ruby'</span><span class="p">,</span> <span class="s1">'3.0.1'</span>
<span class="n">gem</span> <span class="s1">'faker'</span><span class="p">,</span> <span class="s1">'1.1.2'</span>
<span class="n">gem</span> <span class="s1">'will_paginate'</span><span class="p">,</span> <span class="s1">'3.0.4'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-will_paginate'</span><span class="p">,</span> <span class="s1">'0.0.9'</span>
<span class="p">.</span>
<span class="nf">.</span>
<span class="o">.</span>
</pre></div>
</div>
<p>然后执行下面的命令安装：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle install
</pre></div>
</div>
<p>安装后你还要重启 Web 服务器，确保成功加载这两个新 gem。</p>

<p>因为 <code>will_paginate</code> 这个 gem 使用的范围很广，所以我们不必做大量的测试，只需简单的测试一下就可以了。首先我们要检测页面中是否包含一个 CSS class 为 <code>pagination</code> 的 <code>div</code> 元素，这个元素就是由 will_paginate 生成的。然后，我们要检测分页的第一页中是否显示有正确的用户列表。在测试中我们要用到 <code>paginate</code> 方法，稍后会做介绍。</p>

<p>和之前一样，我们要使用 Factory Girl 生成用户，但是我们立马就会遇到一个问题：因为用户的 Email 地址必须是唯一的，那么我们就要手动生成 30 个用户，这可是一件很费事的活儿。而且，在测试用户列表时，用户的名字最好也不一样。幸好 Factory Girl 料事如神，提供了 <code>sequence</code> 方法来解决这种问题。在代码 7.8 中，我们是直接输入名字和 Email 地址来创建预构件的：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="p">:</span><span class="n">user</span> <span class="k">do</span>
    <span class="nb">name</span>     <span class="s2">"Michael Hartl"</span>
    <span class="n">email</span>    <span class="s2">"michael@example.com"</span>
    <span class="n">password</span> <span class="s2">"foobar"</span>
    <span class="n">password_confirmation</span> <span class="s2">"foobar"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>现在我们要使用 <code>sequence</code> 方法自动创建一系列的名字和 Email 地址：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">factory</span> <span class="p">:</span><span class="n">user</span> <span class="k">do</span>
  <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
  <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com"</span><span class="p">}</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="o">.</span>
</pre></div>
</div>
<p><code>sequence</code> 方法可以接受一个 Symbol 类型的参数，对应到属性上（例如 <code>:name</code>），其后还可以跟着块，有一个块参数，我们将其命名为 <code>n</code>。<code>FactoryGirl.create(:user)</code> 方法执行成功后，块参数会自动增加 1。因此，创建的第一个用户名字为“Person 1”，Email 地址为“person_1@example.com”；第二个用户的名字为 <code>Person 2</code>，Email 地址为“person_2@example.com”；依此类推。完整的代码如代码 9.31 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-31"><p class="caption"><span>代码 9.31：</span>定义 Factory Girl 序列</p><p class="file"><code>spec/factories.rb</code></p><div class="highlight type-ruby"><pre><span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="p">:</span><span class="n">user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com"</span><span class="p">}</span>
    <span class="n">password</span> <span class="s2">"foobar"</span>
    <span class="n">password_confirmation</span> <span class="s2">"foobar"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>创建了预构件序列后，在测试中就可以生成 30 个用户了，这 30 个用户就可以产生分页了：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="p">{</span> <span class="mi">30</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
<span class="n">after</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span>  <span class="p">{</span> <span class="no">User</span><span class="p">.</span><span class="nf">delete_all</span> <span class="p">}</span>
</pre></div>
</div>
<p>注意，上述代码使用 <code>before(:all)</code> 确保在块中所有测试执行之前，一次性创建 30 个示例用户。这是对速度做的优化，因为在某些系统中每个测试都创建 30 个用户会很慢。对应的，我们调用 <code>after(:all)</code> 方法，在测试结束后一次性删除所有的用户。</p>

<p>代码 9.32 检测了页面中是否包含正确的 <code>div</code> 元素，以及是否显示了正确的用户。注意，我们把代码 9.22 中的 <code>User.all</code> 换成了 <code>User.paginate(page: 1)</code>，这样我们才能从数据库中取回第一页中要显示的用户。还要注意一下，代码 9.32 中使用的 <code>before(:each)</code> 方法是和 <code>before(:all)</code> 方法相反的操作。</p>

<div class="codeblock has-caption" id="codeblock-9-32"><p class="caption"><span>代码 9.32：</span>测试分页</p><p class="file"><code>spec/requests/user_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"index"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">visit</span> <span class="n">users_path</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'All users'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'All users'</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"pagination"</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="p">{</span> <span class="mi">30</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
      <span class="n">after</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span>  <span class="p">{</span> <span class="no">User</span><span class="p">.</span><span class="nf">delete_all</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.pagination'</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="s2">"should list each user"</span> <span class="k">do</span>
        <span class="no">User</span><span class="p">.</span><span class="nf">paginate</span><span class="p">(</span><span class="ss">page: </span><span class="mi">1</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
          <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'li'</span><span class="p">,</span> <span class="ss">text: </span><span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>要实现分页，我们要在用户列表页面的视图中加入一些代码，告诉 Rails 要分页显示用户，而且要把 <code>index</code> 动作中的 <code>User.all</code> 换成知道如何分页的方法。我们先在视图中加入特殊的 <code>will_paginate</code> 方法，如代码 9.33 所示。稍后我们会看到为什么要在用户列表的前后都加入分页代码。</p>

<div class="codeblock has-caption" id="codeblock-9-33"><p class="caption"><span>代码 9.33：</span>在用户列表视图中加入分页</p><p class="file"><code>app/views/users/index.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size: </span><span class="mi">52</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div>
<p><code>will_paginate</code> 方法有点小神奇，在 Users 控制器的视图中，它会自动寻找名为 <code>@users</code> 的对象，然后显示一个分页导航链接。代码 9.33 所示的视图现在还不能正确显示分页，因为现在 <code>@users</code> 的值是通过 <code>User.all</code> 方法获取的，而 <code>will_paginate</code> 的分页需要调用 <code>paginate</code> 方法：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>rails console
<span class="gp">&gt;&gt; </span>User.paginate<span class="o">(</span>page: 1<span class="o">)</span>
  User Load <span class="o">(</span>1.5ms<span class="o">)</span>  SELECT <span class="s2">"users"</span>.<span class="k">*</span> FROM <span class="s2">"users"</span> LIMIT 30 OFFSET 0
   <span class="o">(</span>1.7ms<span class="o">)</span>  SELECT COUNT<span class="o">(</span><span class="k">*</span><span class="o">)</span> FROM <span class="s2">"users"</span>
<span class="gp">=&gt; </span><span class="c">#&lt;ActiveRecord::Relation [#&lt;User id: 1,...</span>
</pre></div>
</div>
<p><code>paginate</code> 方法可以接受一个 Hash 类型的参数，键 <code>:page</code> 的值指定第几页。<code>User.paginate</code> 方法根据 <code>:page</code> 的值，一次取回一系列的用户（默认为 30 个）。所以，第一页显示的是第 1-30 个用户，第二页显示的是第 31-60 个，等。如果指定的页数不存在，<code>paginate</code> 会显示第一页。</p>

<p>我们可以把 <code>index</code> 动作中的 <code>all</code> 方法换成 <code>paginate</code>，这样页面中就可以显示分页导航了，如代码 9.34 所示。<code>paginate</code> 方法所需的 <code>:page</code> 参数值由 <code>params[:page]</code> 指定，这个 <code>params</code> 元素是由 <code>will_pagenate</code> 自动生成的。</p>

<div class="codeblock has-caption" id="codeblock-9-34"><p class="caption"><span>代码 9.34：</span>在 <code>index</code> 动作中按分页取回用户</p><p class="file"><code>app/controllers/users_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">signed_in_user</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">index</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">paginate</span><span class="p">(</span><span class="ss">page: </span><span class="n">params</span><span class="p">[</span><span class="ss">:page</span><span class="p">])</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>现在，用户列表页面应该可以显示分页了，如图 9.10 所示。（在某些系统中，可能需要重启 Rails 服务器。）因为我们在用户列表前后都加入了 <code>will_paginate</code> 方法，所以这两个地方都会显示分页链接。</p>

<div class="figure" id="figure-9-10">
  <img src="figures/user_index_pagination_rails_3_bootstrap.png" alt="user index pagination rails3 bootstrap" />
  <p class="caption"><span>图 9.10：</span>显示了分页链接的用户列表页面（<a href="http://localhost:3000/users">/users</a>）</p>
</div>
<p>如果点击链接“2”，或者“Next”，就会显示第二页，如图 9.11 所示。</p>

<div class="figure" id="figure-9-11">
  <img src="figures/user_index_page_two_rails_3_bootstrap.png" alt="user index page two rails3 bootstrap" />
  <p class="caption"><span>图 9.11：</span>用户列表的第二页（<a href="http://localhost:3000/users?page=2">/users?page=2</a>）</p>
</div>
<p>你还应该验证一下测试是否可以通过：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<h3 id='section-9-3-4'><span>9.3.4</span> 视图重构</h3>


<p>用户列表页面现在已经可以显示分页了，但是有个改进点我不得不介绍一下。Rails 提供了一些很巧妙的方法可以精简视图的结构，本小节我们就要利用这些方法重构一下用户列表页面。因为我们已经做了很好的测试，所以就可以放手去重构，不用担心会破坏网站的功能。</p>

<p>重构的第一步，要把代码 9.33 中的 <code>li</code> 换成对 <code>render</code> 方法的调用，如代码 9.35 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-35"><p class="caption"><span>代码 9.35：</span>重构用户列表视图的第一步</p><p class="file"><code>app/views/users/index.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div>
<p>在上述代码中，<code>render</code> 的参数不再是指定局部视图的字符串，而是代表 <code>User</code> 类的 <code>user</code> 变量。<sup class="footnote" id="fnref-9-7"><a href="#fn-9-7" rel="footnote">7</a></sup>Rails 会自定寻找一个名为 <code>_user.html.erb</code> 的局部视图，我们要手动创建这个视图，然后写入代码 9.36 中的内容。</p>

<div class="codeblock has-caption" id="codeblock-9-36"><p class="caption"><span>代码 9.36：</span>显示单一用户的局部视图</p><p class="file"><code>app/views/users/_user.html.erb</code></p><div class="highlight type-erb"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size: </span><span class="mi">52</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div>
<p>这个改进很不错，不过我们还可以做的更好。我们可以直接把 <code>@users</code> 变量传递给 <code>render</code> 方法，如代码 9.37 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-37"><p class="caption"><span>代码 9.37：</span>完全重构后的用户列表视图</p><p class="file"><code>app/views/users/index.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div>
<p>Rails 会把 <code>@users</code> 当作一系列的 <code>User</code> 对象，遍历这些对象，然后使用 <code>_user.html.erb</code> 渲染每个对象。所以我们就得到了代码 9.37 这样简洁的代码。每次重构后，你都应该验证一下测试组件是否还是可以通过的：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<h2 id='section-9-4'><span>9.4</span> 删除用户</h2>


<p>至此，用户索引也完成了。符合 REST 架构的Users 资源就只剩下最后一个 <code>destroy</code> 动作了。本节，我们先添加删除用户的链接（构思图如图 9.12 所示），然后再编写适当的 <code>destroy</code> 动作代码完成删除操作。不过，首先我们要先创建管理员级别的用户，并授权这些用户进行删除操作。</p>

<div class="figure" id="figure-9-12">
  <img src="figures/user_index_delete_links_mockup_bootstrap.png" alt="user index delete links mockup bootstrap" />
  <p class="caption"><span>图 9.12：</span>显示有删除链接的用户列表页面构思图</p>
</div>
<h3 id='section-9-4-1'><span>9.4.1</span> 管理员</h3>


<p>我们要通过 User 模型中一个名为 <code>admin</code> 的属性来判断用户是否具有管理员权限。<code>admin</code> 属性的类型为布尔值，Active Record 会自动生成一个 <code>admin?</code> 方法，返回布尔值，判断用户是否为管理员。针对 <code>admin</code> 属性的测试如代码 9.38 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-38"><p class="caption"><span>代码 9.38：</span>测试 <code>admin</code> 属性</p><p class="file"><code>spec/models/user_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_admin</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"with admin attribute set to 'true'"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="p">.</span><span class="nf">save!</span>
      <span class="vi">@user</span><span class="p">.</span><span class="nf">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_admin</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>在上述代码中我们使用 <code>toggle!</code> 方法把 <code>admin</code> 属性的值从 <code>false</code> 转变成 <code>true</code>。<code>it { should be_admin }</code> 这行代码说明用户对象应该可以响应 <code>admin?</code> 方法（这是 RSpec 对布尔值属性的一个约定）。</p>

<p>和之前一样，我们要使用迁移添加 <code>admin</code> 属性，在命令行中指定其类型为 <code>boolean</code>：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>rails generate migration add_admin_to_users admin:boolean
</pre></div>
</div>
<p>这个命令生成的迁移文件（如代码 9.39 所示）会在 users 表中添加 <code>admin</code> 这一列，得到的数据模型如图 9.13 所示。</p>

<div class="figure" id="figure-9-13">
  <img src="figures/user_model_admin_31.png" alt="user model admin 31" />
  <p class="caption"><span>图 9.13：</span>添加了 <code>admin</code> 属性后的 User 模型</p>
</div>
<div class="codeblock has-caption" id="codeblock-9-39"><p class="caption"><span>代码 9.39：</span>为 User 模型添加 <code>admin</code> 属性所用的迁移文件</p><p class="file"><code>db/migrate/[timestamp]_add_admin_to_users.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">AddAdminToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="p">:</span><span class="n">users</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">,</span> <span class="ss">:boolean</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>注意，在代码 9.40 中，我们为 <code>add_column</code> 方法指定了 <code>default: false</code> 参数，添加这个参数后用户默认情况下就不是管理员。（如果没有指定 <code>default: false</code>，<code>admin</code> 的默认值是 <code>nil</code>，也是“假值”，所以严格来说，这个参数不是必须的。不过，指定这个参数，可以更明确地向 Rails 以及代码的阅读者表明这段代码的意图。）</p>

<p>然后，我们要在“开发数据库”中执行迁移操作，还要准备好“测试数据库”：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div>
</div>
<p>和预想的一样，Rails 可以自动识别 <code>admin</code> 属性的类型为布尔值，而且自动生成了 <code>admin?</code> 方法：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>rails console --sandbox
<span class="gp">&gt;&gt; </span>user <span class="o">=</span> User.first
<span class="gp">&gt;&gt; </span>user.admin?
<span class="gp">=&gt; </span><span class="nb">false</span>
<span class="gp">&gt;&gt; </span>user.toggle!<span class="o">(</span>:admin<span class="o">)</span>
<span class="gp">=&gt; </span><span class="nb">true</span>
<span class="gp">&gt;&gt; </span>user.admin?
<span class="gp">=&gt; </span><span class="nb">true</span>
</pre></div>
</div>
<p>执行迁移操作后，针对 <code>admin</code> 属性的测试应该可以通过了：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
</pre></div>
</div>
<p>最后，我们要修改一下生成示例用户的代码，把第一个用户设为管理员，如代码 9.40 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-40"><p class="caption"><span>代码 9.40：</span>生成示例用户的代码，把第一个用户设为管理员</p><p class="file"><code>lib/tasks/sample_data.rake</code></p><div class="highlight type-ruby"><pre><span class="n">namespace</span> <span class="p">:</span><span class="n">db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">"Fill database with sample data"</span>
  <span class="n">task</span> <span class="ss">populate: :environment</span> <span class="k">do</span>
    <span class="n">admin</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Example User"</span><span class="p">,</span>
                         <span class="ss">email: </span><span class="s2">"example@railstutorial.org"</span><span class="p">,</span>
                         <span class="ss">password: </span><span class="s2">"foobar"</span><span class="p">,</span>
                         <span class="ss">password_confirmation: </span><span class="s2">"foobar"</span><span class="p">,</span>
                         <span class="ss">admin: </span><span class="kp">true</span><span class="p">)</span>
    <span class="p">.</span>
    <span class="nf">.</span>
    <span class="p">.</span>
  <span class="nf">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>之后还要还原数据库，并且重新生成示例用户：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$ </span>bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div>
</div>
<h4 id='section-9-4-1-1'><span></span>“健壮参数”再探</h4>


<p>你可能注意到了，在代码 9.40 中，我们在初始化 Hash 参数中指定了 <code>admin: true</code> 把用户设为管理员。这么做的后果是用户对象暴露在网络中了，如果在请求中提供初始化参数，恶意用户就可以发送如下的 <code>PATCH</code> 请求<sup class="footnote" id="fnref-9-8"><a href="#fn-9-8" rel="footnote">8</a></sup>：</p>

<div class="codeblock"><div class="highlight type-shell"><pre>patch /users/17?admin<span class="o">=</span>1
</pre></div>
</div>
<p>这个请求会把 17 号用户设为管理员，这怎么说也是个潜在的安全隐患。</p>

<p>鉴于此，必须只允许传入可安全编辑的属性。我们在 <a href="chapter7.html#section-7-3-2">7.3.2 节</a>中说过，可以使用“健壮参数”，在 <code>params</code> Hash 上调用 <code>require</code> 和 <code>permit</code> 方法：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre>    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
</pre></div>
</div>
<p>注意，<code>admin</code> 不并在允许使用的属性列表中。这样就可以避免用户取得网站的管理权。因为这一步很重要，最好再测试一下各属性是否是可访问的，对 <code>:admin</code> 属性的可访问性测试留作练习，参见 <a href="chapter9.html#section-9-6">9.6 节</a>。</p>

<h3 id='section-9-4-2'><span>9.4.2</span> destroy 动作</h3>


<p>编写完整的 Users 资源还要再添加删除链接和 <code>destroy</code> 动作。我们先在用户列表页面每个用户后面都加入一个删除链接，而且限制只有管理员才能看到这些链接。</p>

<p>编写针对删除功能的测试，最好能有个创建管理员的工厂方法，为此，我们可以在预构件中加入一个名为 <code>:admin</code> 的块，如代码 9.41 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-41"><p class="caption"><span>代码 9.41：</span>添加一个创建管理员的工厂方法</p><p class="file"><code>spec/factories.rb</code></p><div class="highlight type-ruby"><pre><span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="p">:</span><span class="n">user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com"</span><span class="p">}</span>
    <span class="n">password</span> <span class="s2">"foobar"</span>
    <span class="n">password_confirmation</span> <span class="s2">"foobar"</span>

    <span class="n">factory</span> <span class="p">:</span><span class="n">admin</span> <span class="k">do</span>
      <span class="n">admin</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>添加了以上代码之后，我们就可以在测试中调用 <code>FactoryGirl.create(:admin)</code> 创建管理员用户了。</p>

<p>基于安全考虑，普通用户是看不到删除用户链接的，所以：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
<p>只有管理员才能看到删除用户链接，如果管理员点击了删除用户链接，该用户会被删除，用户的数量就会减少 1 个：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">,</span> <span class="ss">href: </span><span class="n">user_path</span><span class="p">(</span><span class="no">User</span><span class="p">.</span><span class="nf">first</span><span class="p">))</span> <span class="p">}</span>
<span class="n">it</span> <span class="s2">"should be able to delete another user"</span> <span class="k">do</span>
  <span class="n">expect</span> <span class="k">do</span>
    <span class="n">click_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">,</span> <span class="ss">match: :first</span><span class="p">)</span>
  <span class="k">end</span><span class="p">.</span><span class="nf">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">).</span><span class="nf">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">,</span> <span class="ss">href: </span><span class="n">user_path</span><span class="p">(</span><span class="n">admin</span><span class="p">))</span> <span class="p">}</span>
</pre></div>
</div>
<p>上述代码中用到了 <code>match: :first</code>，这个参数告知 Capybara，不管是哪个删除链接，只点击第一个看到的。注意，我们还添加了一个测试，确保管理员不会看到删除自己的链接。针对删除用户的完整测试如代码 9.42 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-42"><p class="caption"><span>代码 9.42：</span>测试删除用户功能</p><p class="file"><code>spec/requests/user_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"index"</span> <span class="k">do</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">before</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">visit</span> <span class="n">users_path</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'All users'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'All users'</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"pagination"</span> <span class="k">do</span>
      <span class="p">.</span>
      <span class="nf">.</span>
      <span class="p">.</span>
    <span class="nf">end</span>

    <span class="n">describe</span> <span class="s2">"delete links"</span> <span class="k">do</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"as an admin user"</span> <span class="k">do</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">sign_in</span> <span class="n">admin</span>
          <span class="n">visit</span> <span class="n">users_path</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">,</span> <span class="ss">href: </span><span class="n">user_path</span><span class="p">(</span><span class="no">User</span><span class="p">.</span><span class="nf">first</span><span class="p">))</span> <span class="p">}</span>
        <span class="n">it</span> <span class="s2">"should be able to delete another user"</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">,</span> <span class="ss">match: :first</span><span class="p">)</span>
          <span class="k">end</span><span class="p">.</span><span class="nf">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">).</span><span class="nf">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">,</span> <span class="ss">href: </span><span class="n">user_path</span><span class="p">(</span><span class="n">admin</span><span class="p">))</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>然后在视图中加入代码 9.43。注意链接中的 <code>method: delete</code> 参数，它指明点击链接后发送的是 <code>DELETE</code> 请求。我们还把各链接放在了 <code>if</code> 语句中，这样就只有管理员才能看到删除用户链接。管理员看到的页面如图 9.14 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-43"><p class="caption"><span>代码 9.43：</span>删除用户的链接（只有管理员才能看到）</p><p class="file"><code>app/views/users/_user.html.erb</code></p><div class="highlight type-erb"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size: </span><span class="mi">52</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">admin?</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    | <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="ss">method: :delete</span><span class="p">,</span>
                                  <span class="ss">data: </span><span class="p">{</span> <span class="ss">confirm: </span><span class="s2">"You sure?"</span> <span class="p">}</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div>
<div class="figure" id="figure-9-14">
  <img src="figures/index_delete_links_rails_3_bootstrap.png" alt="index delete links rails3 bootstrap" />
  <p class="caption"><span>图 9.14：</span>显示有删除用户链接的用户列表页面（<a href="http://localhost:3000/users">/users</a>）</p>
</div>
<p>浏览器不能发送 <code>DELETE</code> 请求，Rails 通过 JavaScript 进行模拟的。也就是说，如果用户禁用了 JavaScript，那么删除用户的链接就不可用了。如果必须要支持没有启用 JavaScript 的浏览器，你可以使用一个发送 <code>POST</code> 请求的表单来模拟 <code>DELETE</code> 请求，这样即使浏览器的 JavaScript 被禁用了，删除用户的链接还是可用的，更多细节请观看 RailsCasts 第 77 集《<a href="http://railscasts.com/episodes/77-destroy-without-javascript">Destroy Without JavaScript</a>》。</p>

<p>若要删除用户的链接起作用，我们要定义 <code>destroy</code> 动作（参见<a href="chapter7.html#table-7-1">表格 7.1</a>）。在 <code>destroy</code> 动作中，先找到要删除的用户，使用 Active Record 提供的 <code>destroy</code> 方法删除这个用户，然后再转向用户列表页面，如代码 9.44 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-44"><p class="caption"><span>代码 9.44：</span>加入 <code>destroy</code> 动作</p><p class="file"><code>app/controllers/users_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">signed_in_user</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">]</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">correct_user</span><span class="p">,</span>   <span class="ss">only: </span><span class="p">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">destroy</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]).</span><span class="nf">destroy</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:success</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"User destroyed."</span>
    <span class="n">redirect_to</span> <span class="n">users_url</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>注意上述 <code>destroy</code> 动作中，把 <code>find</code> 方法和 <code>destroy</code> 方法链在一起使用了：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]).</span><span class="nf">destroy</span>
</pre></div>
</div>
<p>理论上，只有管理员才能看到删除用户的链接，所以只有管理员才能删除用户。但实际上，还是存在一个严重的安全隐患：只要攻击者有足够的经验，就可以在命令行中发送 <code>DELETE</code> 请求，删除网站中的用户。为了保证网站的安全，我们还要限制对 <code>destroy</code> 动作的访问，因此我们在测试中不仅要确保只有管理员才能删除用户，还要保证其他用户不能执行删除操作，如代码 9.45 所示。注意，和代码 9.11 中的 <code>put</code> 方法类似，在这段代码中我们使用 <code>delete</code> 方法向指定的地址（<code>user_path</code>，参见<a href="chapter7.html#table-7-1">表格 7.1</a>）发送了一个 <code>DELETE</code> 请求。</p>

<div class="codeblock has-caption" id="codeblock-9-45"><p class="caption"><span>代码 9.45：</span>测试访问受限的 <code>destroy</code> 动作</p><p class="file"><code>spec/requests/authentication_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>
    <span class="p">.</span>
    <span class="nf">.</span>
    <span class="p">.</span>
    <span class="nf">describe</span> <span class="s2">"as non-admin user"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:non_admin</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">non_admin</span><span class="p">,</span> <span class="ss">no_capybara: </span><span class="kp">true</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"submitting a DELETE request to the Users#destroy action"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>理论上来说，网站中还是有一个安全漏洞，管理员可以发送 <code>DELETE</code> 请求删除自己。有些人可能会想，这样的管理员是自作自受。不过作为开发人员，我们最好还是要避免这种情况的发生，具体的实现留作练习，参见 <a href="chapter9.html#section-9-6">9.6 节</a>。</p>

<p>你可能已经知道了，我们要使用一个事前过滤器限制对 <code>destroy</code> 动作的访问，如代码 9.46 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-46"><p class="caption"><span>代码 9.46：</span>限制只有管理员才能访问 <code>destroy</code> 动作的事前过滤器</p><p class="file"><code>app/controllers/users_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">signed_in_user</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">]</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">correct_user</span><span class="p">,</span>   <span class="ss">only: </span><span class="p">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">admin_user</span><span class="p">,</span>     <span class="ss">only: :destroy</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">private</span>
    <span class="p">.</span>
    <span class="nf">.</span>
    <span class="p">.</span>
    <span class="nf">def</span> <span class="n">admin_user</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">admin?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>至此，所有的测试应该都可以通过了，而且 Users 相关的资源，包括控制器、模型和视图，都已经实现了。</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<h2 id='section-9-5'><span>9.5</span> 小结</h2>


<p>我们用了好几章来介绍如何实现 Users 资源，在 <a href="chapter5.html#section-5-4">5.4 节</a>用户还不能注册，而现在不仅可以注册，还可以登录、退出、查看个人资料、修改设置，还能浏览网站中所有的用户列表，某些用户甚至可以删除其他的用户。</p>

<p>本书剩下的内容会以这个 Users 资源为基础（以及相关的权限授权系统），在<a href="chapter10.html">第 10 章</a>中为示例程序加入类似 Twitter 的微博功能，在<a href="chapter11.html">第 11 章</a>中实现关注用户的状态列表。最后这两章会介绍几个 Rails 中最为强大的功能，其中就包括通过 <code>has_many</code> 和 <code>has_many through</code> 实现的数据模型关联。</p>

<p>在继续阅读之前，先把本章所做的改动合并到主分支：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>git add .
<span class="gp">$ </span>git commit -m <span class="s2">"Finish user edit, update, index, and destroy actions"</span>
<span class="gp">$ </span>git checkout master
<span class="gp">$ </span>git merge updating-users
</pre></div>
</div>
<p>你还可以将程序部署到“生产环境”，再生成示例用户（在此之前要使用 <code>pg:reset</code> 命令还原“生产数据库”）：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>git push heroku
<span class="gp">$ </span>heroku pg:reset DATABASE
<span class="gp">$ </span>heroku run rake db:migrate
<span class="gp">$ </span>heroku run rake db:populate
</pre></div>
</div>
<p>若要改动显示出来，可能要在 Heroku 中强制重启应用程序：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>heroku restart
</pre></div>
</div>
<p>还有一点需要注意，本章我们加入了程序所需的最后一个 gem，最终的 <code>Gemfile</code> 如代码 9.47 所示。</p>

<div class="codeblock has-caption" id="codeblock-9-47"><p class="caption"><span>代码 9.47：</span>示例程序所需 <code>Gemfile</code> 的最终版本</p><div class="highlight type-ruby"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.4'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-sass'</span><span class="p">,</span> <span class="s1">'2.3.2.0'</span>
<span class="n">gem</span> <span class="s1">'bcrypt-ruby'</span><span class="p">,</span> <span class="s1">'3.0.1'</span>
<span class="n">gem</span> <span class="s1">'faker'</span><span class="p">,</span> <span class="s1">'1.1.2'</span>
<span class="n">gem</span> <span class="s1">'will_paginate'</span><span class="p">,</span> <span class="s1">'3.0.4'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-will_paginate'</span><span class="p">,</span> <span class="s1">'0.0.9'</span>

<span class="n">group</span> <span class="p">:</span><span class="n">development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sqlite3'</span><span class="p">,</span> <span class="s1">'1.3.8'</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span><span class="p">,</span> <span class="s1">'2.13.1'</span>
  <span class="c1"># The following optional lines are part of the advanced setup.</span>
  <span class="c1"># gem 'guard-rspec', '2.5.0'</span>
  <span class="c1"># gem 'spork-rails', '4.0.0'</span>
  <span class="c1"># gem 'guard-spork', '1.5.0'</span>
  <span class="c1"># gem 'childprocess', '0.3.6'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="p">:</span><span class="nb">test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'selenium-webdriver'</span><span class="p">,</span> <span class="s1">'2.0.0'</span>
  <span class="n">gem</span> <span class="s1">'capybara'</span><span class="p">,</span> <span class="s1">'2.1.0'</span>
  <span class="n">gem</span> <span class="s1">'factory_girl_rails'</span><span class="p">,</span> <span class="s1">'4.2.0'</span>
  <span class="n">gem</span> <span class="s1">'cucumber-rails'</span><span class="p">,</span> <span class="s1">'1.4.0'</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="n">gem</span> <span class="s1">'database_cleaner'</span><span class="p">,</span> <span class="ss">github: </span><span class="s1">'bmabey/database_cleaner'</span>

  <span class="c1"># Uncomment this line on OS X.</span>
  <span class="c1"># gem 'growl', '1.0.3'</span>

  <span class="c1"># Uncomment these lines on Linux.</span>
  <span class="c1"># gem 'libnotify', '0.8.0'</span>

  <span class="c1"># Uncomment these lines on Windows.</span>
  <span class="c1"># gem 'rb-notifu', '0.0.4'</span>
  <span class="c1"># gem 'win32console', '1.3.2'</span>
  <span class="c1"># gem 'wdm', '0.1.0'</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span> <span class="s1">'4.0.1'</span>
<span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span> <span class="s1">'2.1.1'</span>
<span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'4.0.1'</span>
<span class="n">gem</span> <span class="s1">'jquery-rails'</span><span class="p">,</span> <span class="s1">'2.2.1'</span>
<span class="n">gem</span> <span class="s1">'turbolinks'</span><span class="p">,</span> <span class="s1">'1.1.1'</span>
<span class="n">gem</span> <span class="s1">'jbuilder'</span><span class="p">,</span> <span class="s1">'1.0.2'</span>

<span class="n">group</span> <span class="p">:</span><span class="n">doc</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sdoc'</span><span class="p">,</span> <span class="s1">'0.3.20'</span><span class="p">,</span> <span class="ss">require: </span><span class="kp">false</span>
<span class="k">end</span>

<span class="n">group</span> <span class="p">:</span><span class="n">production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'pg'</span><span class="p">,</span> <span class="s1">'0.15.1'</span>
  <span class="n">gem</span> <span class="s1">'rails_12factor'</span><span class="p">,</span> <span class="s1">'0.0.2'</span>
<span class="k">end</span>
</pre></div>
</div>
<h2 id='section-9-6'><span>9.6</span> 练习</h2>


<ol>
  <li>
    <p>参照代码 9.48，直接向 <code>update</code> 动作发起 <code>PATCH</code> 请求，验证一下无法修改 <code>admin</code> 属性。确保测试先是红色的，然后才会变绿。（提示：先要把 <code>admin</code> 加入 <code>user_params</code> 方法的允许访问属性列表中。）</p>
  </li>
  <li>
    <p>把代码 9.3 中修改 Gravatar 头像的链接（“change”），使链接在新窗口（或新标签）中打开。提示：请搜索，你会发现一个很常用的方法，涉及到 <code>_blank</code> 的用法。</p>
  </li>
  <li>
    <p>现在针对身份验证系统的测试会确保用户登录后能看到“Profile”和“Settings”等导航链接。增加一个测试，确保用户未登录时看不到这些导航链接。</p>
  </li>
  <li>
    <p>在测试中尽量多的使用代码 9.6 中的 <code>sign_in</code> 帮助方法。</p>
  </li>
  <li>
    <p>使用代码 9.49 中的代码重构 <code>new.html.erb</code> 和 <code>edit.html.erb</code> 中的表单。注意，你要明确的传入 <code>f</code> 这个表单变量，如代码 9.50 所示。你还要修改相应的测试，因为表单已经不完全一样了。仔细的查找修改前后表单的差异，据此修改测试。</p>
  </li>
  <li>
    <p>已经登录的用户就没必要再访问 Users 控制器的 <code>new</code> 和 <code>create</code> 动作了，修改程序，如果登录后的用户访问这些地址时，转向到网站首页。</p>
  </li>
  <li>
    <p>在网站的布局中插入一些 <a href="http://api.rubyonrails.org/v4.0.0/classes/ActionDispatch/Request.html">Rails API</a>中介绍的方法，了解一下 <code>request</code> 对象。（如果遇到了困难，可以参考代码 7.1。）</p>
  </li>
  <li>
    <p>编写一个测试，确保友好转向只在第一次转向指定的地址，其后再登录的话就转向默认设定的地址（如资料页面）。代码 9.51 是个提示，其实也就是所需的代码。</p>
  </li>
  <li>
    <p>修改 <code>destroy</code> 动作，避免管理员删除自己。（先编写测试。）</p>
  </li>
</ol>

<div class="codeblock has-caption" id="codeblock-9-48"><p class="caption"><span>代码 9.48：</span>测试 <code>admin</code> 属性是否无法修改</p><p class="file"><code>spec/requests/user_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">describe</span> <span class="s2">"edit"</span> <span class="k">do</span>
    <span class="p">.</span>
    <span class="nf">.</span>
    <span class="p">.</span>
    <span class="nf">describe</span> <span class="s2">"forbidden attributes"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:params</span><span class="p">)</span> <span class="k">do</span>
        <span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">admin: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">password: </span><span class="n">user</span><span class="p">.</span><span class="nf">password</span><span class="p">,</span>
                  <span class="ss">password_confirmation: </span><span class="n">user</span><span class="p">.</span><span class="nf">password</span> <span class="p">}</span> <span class="p">}</span>
      <span class="k">end</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="n">params</span> <span class="p">}</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">reload</span><span class="p">).</span><span class="nf">not_to</span> <span class="n">be_admin</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="codeblock has-caption" id="codeblock-9-49"><p class="caption"><span>代码 9.49：</span>注册和编辑表单字段的局部视图</p><p class="file"><code>app/views/users/_fields.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirm Password"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>
</pre></div>
</div>
<div class="codeblock has-caption" id="codeblock-9-50"><p class="caption"><span>代码 9.50：</span>使用局部视图后的注册页面视图</p><p class="file"><code>app/views/users/new.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Sign up'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span6 offset3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'fields'</span><span class="p">,</span> <span class="ss">f: </span><span class="n">f</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Create my account"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<div class="codeblock has-caption" id="codeblock-9-51"><p class="caption"><span>代码 9.51：</span>测试友好的转向后，只能转向到默认的页面</p><p class="file"><code>spec/requests/authentication_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="p">.</span>
      <span class="nf">.</span>
      <span class="p">.</span>
      <span class="nf">describe</span> <span class="s2">"when attempting to visit a protected page"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
          <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span>
          <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with: </span><span class="n">user</span><span class="p">.</span><span class="nf">password</span>
          <span class="n">click_button</span> <span class="s2">"Sign in"</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"after signing in"</span> <span class="k">do</span>

          <span class="n">it</span> <span class="s2">"should render the desired protected page"</span> <span class="k">do</span>
            <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Edit user'</span><span class="p">)</span>
          <span class="k">end</span>

          <span class="n">describe</span> <span class="s2">"when signing in again"</span> <span class="k">do</span>
            <span class="n">before</span> <span class="k">do</span>
              <span class="n">click_link</span> <span class="s1">'Sign out'</span>
              <span class="n">visit</span> <span class="n">signin_path</span>
              <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span>
              <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with: </span><span class="n">user</span><span class="p">.</span><span class="nf">password</span>
              <span class="n">click_button</span> <span class="s2">"Sign in"</span>
            <span class="k">end</span>

            <span class="n">it</span> <span class="s2">"should render the default (profile) page"</span> <span class="k">do</span>
              <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">)</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="p">.</span>
    <span class="nf">.</span>
    <span class="p">.</span>
  <span class="nf">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="footnotes">
  <ol>
    <li id="fn-9-1">
      <p>图片来自 <a href="http://www.flickr.com/photos/sashawolff/4598355045/">http://www.flickr.com/photos/sashawolff/4598355045/</a><a href="#fnref-9-1" rel="reference">↩</a></p>
    </li>
    <li id="fn-9-2">
      <p>Gravatar 会把这个地址转向 http://en.gravatar.com/emails，我去掉了前面的 en，这样选择其他语言的用户就会自动转向相应的页面了。<a href="#fnref-9-2" rel="reference">↩</a></p>
    </li>
    <li id="fn-9-3">
      <p>不要担心实现的细节。具体的实现方式是 Rails 框架的开发者需要关注的，作为 Rails 程序开发者则无需关心。<a href="#fnref-9-3" rel="reference">↩</a></p>
    </li>
    <li id="fn-9-4">
      <p>实现的代码来自 thoughtbot 的 Clearance gem。<a href="#fnref-9-4" rel="reference">↩</a></p>
    </li>
    <li id="fn-9-5">
      <p>感谢读者 Yoel Adler 提出了这个问题，并和我讨论了解决办法。<a href="#fnref-9-5" rel="reference">↩</a></p>
    </li>
    <li id="fn-9-6">
      <p>婴儿的图片来自 <a href="http://www.flickr.com/photos/glasgows/338937124/">http://www.flickr.com/photos/glasgows/338937124/</a><a href="#fnref-9-6" rel="reference">↩</a></p>
    </li>
    <li id="fn-9-7">
      <p>我们并不是一定要使用 <code>user</code>，遍历时如果用的是 <code>@users.each do |foobar|</code>，那么就要用 <code>render foobar</code>。这里的关键是要知道对象的类，也就是 <code>User</code>。<a href="#fnref-9-7" rel="reference">↩</a></p>
    </li>
    <li id="fn-9-8">
      <p>类似 curl 的命令行工具可以发送这种 <code>PATCH</code> 请求。<a href="#fnref-9-8" rel="reference">↩</a></p>
    </li>
  </ol>
</div>

  	</div>
</div>

			
				
				<div class="navigation">
					
						<a class="prev_page" href="chapter8.html">&laquo; 第 8 章登录和退出</a>
					
					
						<a class="next_page" href="chapter10.html">第 10 章用户的微博 &raquo;</a>
					
				</div>
				
			
		</div>
		<div class="footer">
        	<p>&copy;2013 <a href="http://about.ac" title="Andor Chen 的个人网站">Andor Chen</a> 保留部分权力。在线阅读版本基于<a href="http://creativecommons.org/licenses/by-sa/3.0/" title="Creative Commons Attribution-ShareAlike 3.0 Unported License" target="_blank">“CC 3.0 BY-SA 协议”</a>发布</p>
		</div>
	</div>
</body>
</html>
