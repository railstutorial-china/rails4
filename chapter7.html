<!doctype html>
<html lang="zh_CN">
<head>
	<meta charset="utf-8" />
	<title>第 7 章 用户注册</title>
    <meta name="author" content="Andor Chen" />
    <link rel="stylesheet" href="/assets/styles/style.css" />
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/global.js"></script>
</head>

<body>
	<div class="wrapper">
		<div class="header">
            <h1 class="logo"><a class="ir" href="http://railstutorial-china.org">Ruby on Rails 教程</a></h1>
            <p class="subtitle">Ruby on Rails Tutorial 原书第 2 版（涵盖 Rails 4）</p>
        </div>
        <div class="content">
			
<div class="item chapter">
	<h1 id="chapter-7"><span>第 7 章</span> 用户注册</h1>
	<ol class="toc">          <li class="level-2">
            <a href="#section-7-1">7.1 显示用户信息</a>
          </li>
          <li class="level-3">
            <a href="#section-7-1-1">7.1.1 调试信息和 Rails 环境</a>
          </li>
          <li class="level-3">
            <a href="#section-7-1-2">7.1.2 Users 资源</a>
          </li>
          <li class="level-3">
            <a href="#section-7-1-3">7.1.3 使用预构件测试用户资料页面</a>
          </li>
          <li class="level-3">
            <a href="#section-7-1-4">7.1.4 添加 Gravatar 头像和侧边栏</a>
          </li>
          <li class="level-2">
            <a href="#section-7-2">7.2 注册表单</a>
          </li>
          <li class="level-3">
            <a href="#section-7-2-1">7.2.1 测试用户注册功能</a>
          </li>
          <li class="level-3">
            <a href="#section-7-2-2">7.2.2 使用 form_for</a>
          </li>
          <li class="level-3">
            <a href="#section-7-2-3">7.2.3 表单的 HTML</a>
          </li>
          <li class="level-2">
            <a href="#section-7-3">7.3 注册失败</a>
          </li>
          <li class="level-3">
            <a href="#section-7-3-1">7.3.1 可正常使用的表单</a>
          </li>
          <li class="level-3">
            <a href="#section-7-3-2">7.3.2 健壮参数</a>
          </li>
          <li class="level-3">
            <a href="#section-7-3-3">7.3.3 注册时的错误提示信息</a>
          </li>
          <li class="level-2">
            <a href="#section-7-4">7.4 注册成功</a>
          </li>
          <li class="level-3">
            <a href="#section-7-4-1">7.4.1 完整的注册表单</a>
          </li>
          <li class="level-3">
            <a href="#section-7-4-2">7.4.2 Flash 消息</a>
          </li>
          <li class="level-3">
            <a href="#section-7-4-3">7.4.3 首次注册</a>
          </li>
          <li class="level-3">
            <a href="#section-7-4-4">7.4.4 部署到生产环境，并开启 SSL</a>
          </li>
          <li class="level-2">
            <a href="#section-7-5">7.5 小结</a>
          </li>
          <li class="level-2">
            <a href="#section-7-6">7.6 练习</a>
          </li>
</ol>
  	<div class="main">
  		<p>User 模型可以正常使用了，接下来要实现的功能大多数网站都离不开：用户注册。在 <a href="chapter7.html#section-7-2">7.2 节</a>我们会创建一个表单，提交用户注册时填写的信息，然后在 <a href="chapter7.html#section-7-4">7.4 节</a>中使用提交的数据创建新用户，把相应的属性值存入数据库。注册功能实现后，还要创建一个用户资料页面，显示用户的个人信息，这是实现 Users 资源 REST 架构（参见 <a href="chapter2.html#section-2-2-2">2.2.2 节</a>）的第一步。和之前一样，开发的过程中要编写测试，结合 RSpec 和 Capybara 写出简洁有效的集成测试。</p>

<p>创建资料页面之前，数据库中先要有用户记录。这有点类似“先有鸡还是先有蛋”的问题：网站还没实现注册功能，数据库中怎么会有用户记录呢？其实这个问题在 <a href="chapter6.html#section-6-3-5">6.3.5 节</a>中已经解决了，我们在控制台中向数据库中存储了一个用户记录。如果你跳过了那一节，现在赶快往回翻，完成相应的操作。</p>

<p>如果你一直坚持使用版本控制系统，现在要新建一个从分支了：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git checkout -b sign-up
</pre></div>
</div>
<h2 id='section-7-1'><span>7.1</span> 显示用户信息</h2>


<p>本节要实现的用户资料页面是完整页面的一小部分，只显示用户的名字和头像，构思图如图 7.1 所示。<sup class="footnote" id="fnref-7-1"><a href="#fn-7-1" rel="footnote">1</a></sup> 最终完成的用户资料页面会显示用户的头像、基本信息和一些微博，构思图如图 7.2 所示。<sup class="footnote" id="fnref-7-2"><a href="#fn-7-2" rel="footnote">2</a></sup>（在图 7.2 中，我们第一次用到了“lorem ipsum”占位文字，<a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean">这些文字背后的故事</a>很有意思，有空的话你可以了解一下。）整个资料页面会和整个示例程序一起在 <a href="chapter11.html">第 11 章</a>完成。</p>

<h3 id='section-7-1-1'><span>7.1.1</span> 调试信息和 Rails 环境</h3>


<p>本节要实现的用户资料页面是第一个真正意义上的动态页面。虽然视图的代码不会动态改变，不过每个用户资料页面显示的内容却是动态的从数据库中读取的。添加动态页面之前，最好做些准备工作，现在我们能做的就是在网站布局中加入一些调试信息（参见代码 7.1）。代码 7.1 使用 Rails 内置的 <code>debug</code> 方法和 <code>params</code> 变量（<a href="chapter7.html#section-7-1-2">7.1.2 节</a>会详细介绍），在每一页中都显示一些对开发有所帮助的信息。</p>

<div class="codeblock has-caption" id="codeblock-7-1"><p class="caption"><span>代码 7.1：</span>把调试信息加入网站的布局中</p><p class="file"><code>app/views/layouts/application.html.erb</code></p><div class="highlight type-erb"><pre><span class="x">&lt;!DOCTYPE html&gt;</span>
<span class="x">&lt;html&gt;</span>
<span class="x">  .</span>
<span class="x">  .</span>
<span class="x">  .</span>
<span class="x">  &lt;body&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'layouts/header'</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    &lt;div class="container"&gt;</span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'layouts/footer'</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    &lt;/div&gt;</span>
<span class="x">  &lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span>
</pre></div>
</div>
<div class="figure" id="figure-7-1">
  <img src="figures/profile_mockup_profile_name_bootstrap.png" alt="profile mockup profile name bootstrap" /><p class="caption"><span>图 7.1：</span>本节要实现的用户资料页面构思图</p>
</div>
<p>我们要在<a href="chapter5.html">第 5 章</a>中创建的自定义样式表文件中加入一些样式规则（参见代码 7.2），美化一下这些调试信息。</p>

<div class="codeblock has-caption" id="codeblock-7-2"><p class="caption"><span>代码 7.2：</span>添加美化调试信息的样式，使用了一个 Sass mixin</p><p class="file"><code>app/assets/stylesheets/custom.css.scss</code></p><div class="highlight type-scss"><pre><span class="k">@import</span> <span class="s2">"bootstrap"</span><span class="p">;</span>

<span class="cm">/* mixins, variables, etc. */</span>

<span class="nv">$grayMediumLight</span><span class="o">:</span> <span class="mh">#eaeaea</span><span class="p">;</span>

<span class="k">@mixin</span><span class="nf"> box_sizing</span> <span class="p">{</span>
  <span class="na">-moz-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
  <span class="na">-webkit-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
  <span class="na">box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">miscellaneous</span> <span class="o">*/</span>

<span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="na">clear</span><span class="o">:</span> <span class="no">both</span><span class="p">;</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">width</span><span class="o">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">45</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">@include</span><span class="nd"> box_sizing</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>上面的代码用到了 Sass 的 mixin 功能，创建的这个 mixin 名为 <code>box-sizing</code>。mixin 可以打包一系列的样式规则，供多次使用。预处理器处理时，会把</p>

<div class="codeblock"><div class="highlight type-scss"><pre><span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="nc">.</span>
  <span class="nc">.</span>
  <span class="nc">.</span>
  <span class="o">@</span><span class="nt">include</span> <span class="nt">box_sizing</span><span class="o">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>转换成</p>

<div class="codeblock"><div class="highlight type-scss"><pre><span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">-moz-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
  <span class="na">-webkit-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
  <span class="na">box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>在 <a href="chapter7.html#section-7-2-2">7.2.2 节</a>中还会再次用到这个 mixin。美化后的调试信息如图 7.3 所示。</p>

<div class="figure" id="figure-7-2">
  <img src="figures/profile_mockup_bootstrap.png" alt="profile mockup bootstrap" /><p class="caption"><span>图 7.2：</span>最终实现的用户资料页面构思图</p>
</div>
<p>图 7.3 中显示的调试信息给出了当前页面的一些信息：</p>

<div class="codeblock"><div class="highlight type-yaml"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">static_pages</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">home</span>
</pre></div>
</div>
<p>这是 <code>params</code> 变量的 YAML<sup class="footnote" id="fnref-7-3"><a href="#fn-7-3" rel="footnote">3</a></sup>形式，和 Hash 类似，显示了当前页面的控制器名和动作名。在 <a href="chapter7.html#section-7-1-2">7.1.2 节</a>中会介绍其他调试信息的意思。</p>

<p>我们不想让部署后的示例程序显示这个调试信息，所以代码 7.1 中用如下的代码做了限制，只在“开发环境”中显示：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>
</pre></div>
</div>
<div class="figure" id="figure-7-3">
  <img src="figures/home_page_with_debug_4_0.png" alt="home page with debug 40" /><p class="caption"><span>图 7.3：</span>显示有调试信息的示例程序首页（<a href="http://localhost:3000/">/</a>）</p>
</div>
<p>“开发环境”是 Rails 定义的三个环境之一（详细介绍参见<a href="chapter7.html#aside-7-1">旁注 7.1</a>）<sup class="footnote" id="fnref-7-4"><a href="#fn-7-4" rel="footnote">4</a></sup>，只有在“开发环境”中 <code>Rails.env.development?</code> 才会返回 <code>true</code>，所以下面的 ERb 代码</p>

<div class="codeblock"><div class="highlight type-erb"><pre><span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>不会在“生产环境”和“测试环境”中执行。（在“测试环境”中显示调试信息虽然没有坏处，但也没什么好处，所以最好只在“开发环境”中显示。）</p>

          <div class="aside box" id="aside-7-1">
  <h4><span>旁注 7.1：</span>Rails 的三个环境</h4>

  <p>Rails 定义了三个环境，分别是“生产环境”、“开发环境”和“测试环境”。Rails 控制台默认使用的是“开发环境”：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>rails console
Loading development environment
&gt;&gt; Rails.env
<span class="o">=</span>&gt; <span class="s2">"development"</span>
&gt;&gt; Rails.env.development?
<span class="o">=</span>&gt; <span class="nb">true</span>
&gt;&gt; Rails.env.test?
<span class="o">=</span>&gt; <span class="nb">false</span>
</pre></div>
</div>
  <p>如前所示，Rails 对象有一个 <code>env</code> 属性，属性上还可以调用各环境对应的布尔值方法，例如，<code>Rails.env.test?</code>，在“测试环境”中的返回值是 <code>true</code>，而在其他两个环境中的返回值则是 <code>false</code>。</p>

  <p>如果需要在其他环境中使用控制台（例如，在“测试环境”中进行调试），只需把环境名称传递给 <code>console</code> 命令即可：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>rails console <span class="nb">test</span>
Loading <span class="nb">test </span>environment
&gt;&gt; Rails.env
<span class="o">=</span>&gt; <span class="s2">"test"</span>
&gt;&gt; Rails.env.test?
<span class="o">=</span>&gt; <span class="nb">true</span>
</pre></div>
</div>
  <p>Rails 本地服务器和控制台一样，默认使用“开发环境”，不过也可以在其他环境中运行：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>rails server --environment production
</pre></div>
</div>
  <p>如果要在“生产环境”中运行应用程序，先要提供生产环境数据库。在“生产环境”中执行 <code>rake db:migrate</code> 命令可以生成“生产环境”所需的数据库：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake db:migrate <span class="nv">RAILS_ENV</span><span class="o">=</span>production
</pre></div>
</div>
  <p>（我发现在控制台、服务器和迁移命令中指定其他环境的方法不一样，这可能会产生混淆，所以我特意演示了三个命令的用法。）</p>

  <p>顺便说一下，把应用程序部署到 Heroku 后，可以使用如下的命令进入远端的控制台：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>heroku run console
Ruby console <span class="k">for </span>yourapp.herokuapp.com
&gt;&gt; Rails.env
<span class="o">=</span>&gt; <span class="s2">"production"</span>
&gt;&gt; Rails.env.production?
<span class="o">=</span>&gt; <span class="nb">true</span>
</pre></div>
</div>
  <p>Heroku 是用来部署网站的平台，自然会在“生产环境”中运行应用程序。</p>
</div>


<h3 id='section-7-1-2'><span>7.1.2</span> Users 资源</h3>


<p>在<a href="chapter6.html">第 6 章</a>末尾，我们在数据库中存储了一个用户记录，在 <a href="chapter6.html#section-6-3-5">6.3.5 节</a>查看过，用户的 id 是 1，现在我们就来创建一个页面，显示这个用户的信息。我们会遵从 Rails 使用的 REST 架构，把数据视为资源（resource），可以创建、显示、更新和删除，这四个操作分别对应了 HTTP 标准中的 <code>POST</code>、<code>GET</code>、<code>PATCH</code> 和 <code>DELETE</code> 请求方法（参见<a href="chapter3.html#aside-3-3">旁注 3.3</a>）。</p>

<p>按照 REST 约定，资源一般是由资源名加唯一标识符表示的。对 User 而言，我们把它看做一个资源，若要查看 id 为 1 的用户，就要向 /users/1 地址发送一个 <code>GET</code> 请求。REST 架构解析时，会自动把这个 <code>GET</code> 请求分发到 <code>show</code> 动作上，因此这里没必要指明用哪个动作。</p>

<p>在 <a href="chapter2.html#section-2-2-1">2.2.1 节</a>中曾经见过，id 为 1 的用户对应的地址是 /users/1，现在访问这个地址的话会显示错误提示信息（如图 7.4）。</p>

<div class="figure" id="figure-7-4">
  <img src="figures/profile_routing_error.png" alt="profile routing error" /><p class="caption"><span>图 7.4：</span>/users/1 地址显示的错误</p>
</div>
<p>我们只需在路由文件 <code>config/routes.rb</code> 中添加如下的一行代码就可以正常访问 REST 架构对应的 URL 地址了：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">resources</span> <span class="ss">:users</span>
</pre></div>
</div>
<p>修改后的路由文件如代码 7.3 所示。</p>

<div class="codeblock has-caption" id="codeblock-7-3"><p class="caption"><span>代码 7.3：</span>在路由文件中添加 Users 资源设置</p><p class="file"><code>config/routes.rb</code></p><div class="highlight type-ruby"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">root</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#home'</span>
  <span class="n">match</span> <span class="s1">'/signup'</span><span class="p">,</span>  <span class="ss">to</span><span class="p">:</span> <span class="s1">'users#new'</span><span class="p">,</span>            <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<p>你可能发现了，我们把下面这行在代码 5.33 中出现的代码删掉了：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">get</span> <span class="s2">"users/new"</span>
</pre></div>
</div>
<p>这是因为 <code>resources :users</code> 不仅使 /users/1 地址可以访问了，而且还为示例程序的 Users 资源提供了符合 REST 架构的一系列动作<sup class="footnote" id="fnref-7-5"><a href="#fn-7-5" rel="footnote">5</a></sup>，以及用来获取相应 URL 地址的具名路由（named route，参见 <a href="chapter5.html#section-5-3-3">5.3.3 节</a>）。最终得到的 URI、动作和具名路由的对应关系如<a href="chapter7.html#table-7-1">表格 7.1</a> 所示（可以和<a href="chapter2.html#table-2-2">表格 2.2</a> 对比一下）。接下来的三章会介绍 <code>show</code> 之外的所有动作，并不断完善，把 Users 打造成完全符合 REST 架构的资源。</p>

<div class="table has-caption" id="table-7-1">
  <p class="caption"><span>表格 7.1：</span>Users 资源对应的路由</p>
  <table><thead><tr><th>HTTP 请求</th>
      <th>URL</th>
      <th>动作</th>
      <th>具名路由</th>
      <th>作用</th>
    </tr></thead><tbody><tr><td><code>GET</code></td>
      <td>/users</td>
      <td><code>index</code></td>
      <td><code>users_path</code></td>
      <td>显示所有用户的页面</td>
    </tr><tr><td><code>GET</code></td>
      <td>/users/1</td>
      <td><code>show</code></td>
      <td><code>user_path(user)</code></td>
      <td>显示某个用户的页面</td>
    </tr><tr><td><code>GET</code></td>
      <td>/users/new</td>
      <td><code>new</code></td>
      <td><code>new_user_path</code></td>
      <td>创建（注册）新用户的页面</td>
    </tr><tr><td><code>POST</code></td>
      <td>/users</td>
      <td><code>create</code></td>
      <td><code>users_path</code></td>
      <td>创建新用户</td>
    </tr><tr><td><code>GET</code></td>
      <td>/users/1/edit</td>
      <td><code>edit</code></td>
      <td><code>edit_user_path(user)</code></td>
      <td>编辑 id 为 1 的用户页面</td>
    </tr><tr><td><code>PATCH</code></td>
      <td>/users/1</td>
      <td><code>update</code></td>
      <td><code>user_path(user)</code></td>
      <td>更新用户信息</td>
    </tr><tr><td><code>DELETE</code></td>
      <td>/users/1</td>
      <td><code>destroy</code></td>
      <td><code>user_path(user)</code></td>
      <td>删除用户</td>
    </tr></tbody></table></div>
<p>添加代码 7.3 之后，路由就生效了，但是页面还不存在（如图 7.5）。下面我们就来为页面添加一些内容，<a href="chapter7.html#section-7-1-4">7.1.4 节</a>还会添加更多的内容。</p>

<p>用户资料页面的视图存放在应用程序特定的目录中，即 <code>app/views/users/show.html.erb</code>。这个视图和自动生成的 <code>new.html.erb</code>（参见代码 5.29）不同，现在不存在，要手动创建。新建 <code>show</code> 视图后请写入代码 7.4 中的代码。</p>

<div class="figure" id="figure-7-5">
  <img src="figures/user_show_unknown_action_31.png" alt="user show unknown action 31" /><p class="caption"><span>图 7.5：</span>/users/1 地址生效了，但是页面不存在</p>
</div>
<div class="codeblock has-caption" id="codeblock-7-4"><p class="caption"><span>代码 7.4：</span>用户资料页面的临时视图</p><p class="file"><code>app/views/users/show.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="x">, </span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>在上面的代码中，我们假设 <code>@user</code> 变量是存在的，使用 ERb 代码显示用户的名字和 Email 地址。这和最终实现的视图有点不一样，在最终的视图中不会公开显示用户的 Email 地址。</p>

<p>我们要在 Users 控制器的 <code>show</code> 动作中定义 <code>@user</code> 变量，用户资料页面才能正常渲染。你可能猜到了，我们要在 User 模型上调用 <code>find</code> 方法，从数据库中取出用户记录，如代码 7.5 所示。</p>

<div class="codeblock has-caption" id="codeblock-7-5"><p class="caption"><span>代码 7.5：</span>含有 <code>show</code> 动作的 Users 控制器</p><p class="file"><code>app/controllers/users_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>在上面的代码中，我们使用 <code>params</code> 获取用户的 id。当我们向 Users 控制器发送请求时，<code>params[:id]</code> 会返回用户的 id，即 1，所以这就和 <a href="chapter6.html#section-6-1-4">6.1.4 节</a>中直接调用 <code>User.find(1)</code> 的效果一样。（严格来说，<code>params[:id]</code> 返回的是字符串 <code>"1"</code>，<code>find</code> 方法会自动将其转换成整数形式。）</p>

<p>定义了视图和动作之后，/users/1 地址就可以正常显示了（如图 7.6）。留意一下调试信息，其内容证实了 <code>params[:id]</code> 的值和前面分析的一样：</p>

<div class="codeblock"><div class="highlight type-yaml"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">show</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>
<span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="s">'1'</span>
</pre></div>
</div>
<p>所以，代码 7.5 中的 <code>User.find(params[:id])</code> 才会取回 id 为 1 的用户记录。</p>

<div class="figure" id="figure-7-6">
  <img src="figures/user_show_bootstrap.png" alt="user show bootstrap" /><p class="caption"><span>图 7.6：</span>设置 Users 资源后的用户资料页面 <a href="http://localhost:3000/users/1">/users/1</a></p>
</div>
<h3 id='section-7-1-3'><span>7.1.3</span> 使用预构件测试用户资料页面</h3>


<p>至此，用户资料页面已经可以正常访问了，接下来我们要实现图 7.1 所示的构思了。与创建静态页面和 User 模型一样，开发的过程会践行 TDD 思想。</p>

<p>在 <a href="chapter5.html#section-5-4-2">5.4.2 节</a>中，我们使用集成测试对 Users 资源相关的页面进行了测试，以“注册”页面为例，测试先访问 <code>signup_path</code>，然后检测页面中 <code>h1</code> 和 <code>title</code> 标签的内容是否正确。代码 7.6 是对代码 5.32 的补充。（注意，我们删除了 <a href="chapter5.html#section-5-3-4">5.3.4 节</a>用到的 <code>full_title</code> 帮助方法，因为标题已经测试过了。）</p>

<div class="codeblock has-caption" id="codeblock-7-6"><p class="caption"><span>代码 7.6：</span>补充用户相关页面的测试</p><p class="file"><code>spec/requests/user_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"signup page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sign up'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Sign up'</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>为了测试用户资料页面，先要有一个 User 模型对象，代码 7.5 中的 <code>show</code> 动作才能执行查询操作：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">describe</span> <span class="s2">"profile page"</span> <span class="k">do</span>
  <span class="c1"># Replace with code to make a user variable</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>
<p>我们要把上面代码中的注释换成相关的代码才行。在注释后面，调用 <code>user_path</code> 具名路由（参见<a href="chapter7.html#table-7-1">表格 7.1</a>）访问用户资料页面的地址，然后检测页面内容和标题是否都包含用户的名字。</p>

<p>一般情况下，创建 User 模型需要调用 Active Record 提供的 <code>User.create</code> 方法，不过经验告诉我们，使用预构件（factory）创建用户对象更方便，存入数据库也更容易。</p>

<p>我们要使用 <a href="http://github.com/thoughtbot/factory_girl">Factory Girl</a> 来生成预构件，这个 gem 是由 thoughtbot 公司的达人开发的。和 RSpec 类似，Factory Girl 也定义了一套领域专属语言（Domain-specific Language, DSL），用来生成 Active Record 对象。Factory Girl 的句法很简单，使用块和方法定义对象的属性值。本章还没有显出预构件的优势，不过后续的内容会多次使用预构件的高级更能，到时你就可以看到它的强大之处了。例如，在 <a href="chapter9.html#section-9-3-3">9.3.3 节</a>中，需要生成一批 Email 地址各不相同的用户对象，用预构件就可以很轻松的完成这种操作。</p>

<p>和其他的 gem 一样，我们要在 Bundler 的 <code>Gemfile</code> 中加入如代码 7.7 所示的代码来安装 Factory Girl。（因为只有测试时才会用到 Factory Girl，所以把它归入测试组中。）</p>

<div class="codeblock has-caption" id="codeblock-7-7"><p class="caption"><span>代码 7.7：</span>把 Factory Girl 加入 <code>Gemfile</code></p><div class="highlight type-ruby"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">gem</span> <span class="s1">'factory_girl_rails'</span><span class="p">,</span> <span class="s1">'4.2.1'</span>
<span class="k">end</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div>
<p>然后和往常一样，运行以下命令安装：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>bundle install
</pre></div>
</div>
<p>Factory Girl 生成的预构件都保存在 <code>spec/factories.rb</code> 中，RSpec 会自动加载这个文件。用户相关的预构件如代码 7.8 所示。</p>

<div class="codeblock has-caption" id="codeblock-7-8"><p class="caption"><span>代码 7.8：</span>模拟 User 模型对象的预构件</p><p class="file"><code>spec/factories.rb</code></p><div class="highlight type-ruby"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="nb">name</span>     <span class="s2">"Michael Hartl"</span>
    <span class="n">email</span>    <span class="s2">"michael@example.com"</span>
    <span class="n">password</span> <span class="s2">"foobar"</span>
    <span class="n">password_confirmation</span> <span class="s2">"foobar"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p><code>factory</code> 方法的 <code>:user</code> 参数说明，块中的代码定义了一个 User 模型对象。</p>

<p>加入代码 7.8 之后，就可以在测试中使用 <code>let</code> 方法（参见<a href="chapter6.html#aside-6-3">旁注 6.3</a>）和 Factory Girl 提供的 <code>FactoryGirl</code> 方法来生成 User 对象：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
<p>修改后的测试如代码 7.9 所示。</p>

<div class="codeblock has-caption" id="codeblock-7-9"><p class="caption"><span>代码 7.9：</span>用户资料页面的测试</p><p class="file"><code>spec/requests/user_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"profile page"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"signup page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sign up'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Sign up'</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>现在你应该看一下测试是否是失败的（红色）：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<p>加入代码 7.10 之后，测试就可以通过了（绿色）。</p>

<div class="codeblock has-caption" id="codeblock-7-10"><p class="caption"><span>代码 7.10：</span>在用户资料页面视图中加入标题和标头</p><p class="file"><code>app/views/users/show.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="x">&lt;/h1&gt;</span>
</pre></div>
</div>
<p>再次运行 RSpec，确认代码 7.9 中的测试是否可以通过：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<p>使用 Factory Girl 后，明显可以察觉测试变慢了，这不是 Factory Girl 导致的，而是有意为之，并不是 bug。变慢的原因在于 <a href="chapter6.html#section-6-3-1">6.3.1 节</a>中用来加密密码的 BCrypt，其加密算法设计如此，因为慢速加密的密码很难破解。慢速加密的过程会延长测试的运行时间，不过我们可以做个简单的设置改变这种情况。<code>bcrypt-ruby</code> 使用耗时因子（cost factor）设定加密过程的耗时，耗时因子的默认值倾向于安全性而不是速度，在生产环境这种设置很好，但测试时的关注点却有所不同：测试追求的是速度，而不用在意测试数据库中用户的密码强度。我们可以在“测试环境”配置文件 <code>config/environments/test.rb</code> 中加入一行代码来解决速度慢的问题：把耗时因子的默认值修改为最小值，提升加密的速度，如代码 7.11 所示。即使测试量很少，修改设置之后速度的提升也是很明显的，所以我建议每个读者都在 <code>test.rb</code> 文件中加入代码 7.11 的内容。</p>

<div class="codeblock has-caption" id="codeblock-7-11"><p class="caption"><span>代码 7.11：</span>为测试环境重新设置 BCrypt 耗时因子</p><p class="file"><code>config/environments/test.rb</code></p><div class="highlight type-ruby"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Speed up tests by lowering bcrypt's cost function.</span>
  <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div>
<h3 id='section-7-1-4'><span>7.1.4</span> 添加 Gravatar 头像和侧边栏</h3>


<p>上一小节创建了一个略显简陋的用户资料页面，这一小节要再添加一些内容：用户头像和侧边栏。构建视图时，我们关注的是显示的内容，而不是页面底层的结构，所以我们暂时不测试视图，等遇到容易出错的页面结构时，例如 <a href="chapter9.html#section-9-3-3">9.3.3 节</a>中的分页导航，再使用 TDD 理念。</p>

<p>首先，我们要在用户资料页面中添加一个“全球通用识别”的头像，这个头像也称作 Gravatar<sup class="footnote" id="fnref-7-6"><a href="#fn-7-6" rel="footnote">6</a></sup>，由 Tom Preston-Werner（GitHub 的联合创始人）开发，后被 Automattic（开发 WordPress 的公司）收购。Gravatar 是一个免费服务，用户只需上传图片并将其关联到 Email 地址上即可。使用 Gravatar 可以简单的在网站中加入用户头像，开发者不必再分心去处理图片上传、剪裁和存储，只要使用用户的 Email 地址构成头像的 URL 地址，关联的头像就可以显示出来了。<sup class="footnote" id="fnref-7-7"><a href="#fn-7-7" rel="footnote">7</a></sup></p>

<p>我们计划定义一个名为 <code>gravatar_for</code> 的方法，返回指定用户的 Gravatar 头像，如代码 7.12 所示。</p>

<div class="codeblock has-caption" id="codeblock-7-12"><p class="caption"><span>代码 7.12：</span>显示用户名字和 Gravatar 头像的用户资料页面视图</p><p class="file"><code>app/views/users/show.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;h1&gt;</span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;/h1&gt;</span>
</pre></div>
</div>
<p>现在看一下测试是不是失败的：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<p>因为还没定义 <code>gravatar_for</code> 方法，所以用户资料页面会显示错误提示。（测试视图最大的作用大概就是可以捕获这种错误，所以一定要掌握视图测试的量。）</p>

<p>默认情况下，所有帮助方法文件中定义的方法都可以直接用在任意的视图中，不过为了便于管理，我们会把 <code>gravatar_for</code> 放在 Users 控制器对应的帮助文件中。Gravatar 的首页中有介绍说，头像的 URL 地址要使用 MD5 加密的 Email 地址。在 Ruby 中，MD5 加密算法由 <code>Digest</code> 库的 <code>hexdigest</code> 方法实现：</p>

<div class="codeblock"><div class="highlight type-sh"><pre>&gt;&gt; <span class="nv">email</span> <span class="o">=</span> <span class="s2">"MHARTL@example.COM"</span>
&gt;&gt; Digest::MD5::hexdigest<span class="o">(</span>email.downcase<span class="o">)</span>
<span class="o">=</span>&gt; <span class="s2">"1fda4469bcbec3badf5418269ffc5968"</span>
</pre></div>
</div>
<p>Email 地址不区分大小写，而 MD5 加密算法却区分，所以，我们要先调用 <code>downcase</code> 方法把 Email 地址转换成小写形式，然后再传递给 <code>hexdigest</code> 方法。我们定义的 <code>gravatar_for</code> 方法如代码 7.13 所示。</p>

<div class="codeblock has-caption" id="codeblock-7-13"><p class="caption"><span>代码 7.13：</span>定义 <code>gravatar_for</code> 帮助方法</p><p class="file"><code>app/helpers/users_helper.rb</code></p><div class="highlight type-ruby"><pre><span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="c1"># Returns the Gravatar (http://gravatar.com/) for the given user.</span>
  <span class="k">def</span> <span class="nf">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">gravatar_id</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
    <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">"https://secure.gravatar.com/avatar/</span><span class="si">#{</span><span class="n">gravatar_id</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">,</span> <span class="ss">alt</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"gravatar"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p><code>gravatar_for</code> 方法的返回值是 Gravatar 头像的 <code>img</code> 元素，<code>img</code> 标签的 class 设为 <code>gravatar</code>，<code>alt</code> 属性值是用户的名字（对视觉障碍人士使用的屏幕阅读器很友好）。现在你可以验证一下测试是否可以通过：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<p>用户资料页面的效果如图 7.7 所示，页面中显示的头像是 Gravatar 的默认图片，因为 <code>user@example.com</code> 不是真的 Email 地址（example.com 这个域名是专门用来举例的）。</p>

<p>我们调用 <code>update_attributes</code> 方法（参见 <a href="chapter6.html#section-6-1-5">6.1.5 节</a>）更新一下数据库中的用户记录，然后就可以显示用户真正的头像了：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>rails console
&gt;&gt; <span class="nv">user</span> <span class="o">=</span> User.first
&gt;&gt; user.update_attributes<span class="o">(</span>name: <span class="s2">"Example User"</span>,
?&gt;                        email: <span class="s2">"example@railstutorial.org"</span>,
?&gt;                        password: <span class="s2">"foobar"</span>,
?&gt;                        password_confirmation: <span class="s2">"foobar"</span><span class="o">)</span>
<span class="o">=</span>&gt; <span class="nb">true</span>
</pre></div>
</div>
<p>上面的代码，把用户的 Email 地址设为 <code>example@railstutorial.org</code>，我已经把这个 Email 地址的头像设为了本书网站的 LOGO。修改后的结果如图 7.8 所示。</p>

<p>我们还要添加一个侧边栏，才能完整的实现图 7.1 中的构思。我们要使用 <code>aside</code> 标签定义侧边栏，<code>aside</code> 中的内容一般是对主体内容的补充，不过也可以自成一体。我们要把 <code>aside</code> 标签的 class 设为 <code>row span4</code>，这也是 Bootstrap 会用到的。在用户资料页面中添加侧边栏用到的代码如代码 7.14 所示。</p>

<div class="figure" id="figure-7-7">
  <img src="figures/profile_with_gravatar_bootstrap_4_0.png" alt="profile with gravatar bootstrap 40" /><p class="caption"><span>图 7.7：</span>显示默认 Gravatar 头像的用户资料页面 <a href="http://localhost:3000/users/1">/users/1</a></p>
</div>
<div class="codeblock has-caption" id="codeblock-7-14"><p class="caption"><span>代码 7.14：</span>为用户资料页面添加侧边栏</p><p class="file"><code>app/views/users/show.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;div class="row"&gt;</span>
<span class="x">  &lt;aside class="span4"&gt;</span>
<span class="x">    &lt;section&gt;</span>
<span class="x">      &lt;h1&gt;</span>
<span class="x">        </span><span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">        </span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      &lt;/h1&gt;</span>
<span class="x">    &lt;/section&gt;</span>
<span class="x">  &lt;/aside&gt;</span>
<span class="x">&lt;/div&gt;</span>
</pre></div>
</div>
<p>添加了 HTML 结构和 CSS class 后，我们再用 SCSS 为资料页面定义样式，如代码 7.15 所示。（注意：因为 asset pipeline 使用了 Sass 预处理器，所以样式中才可以使用嵌套。）最终的效果如图 7.9 所示。</p>

<div class="codeblock has-caption" id="codeblock-7-15"><p class="caption"><span>代码 7.15：</span>用户资料页面的样式，包括侧边栏的样式</p><p class="file"><code>app/assets/stylesheets/custom.css.scss</code></p><div class="highlight type-scss"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">sidebar</span> <span class="o">*/</span>

<span class="nt">aside</span> <span class="p">{</span>
  <span class="nt">section</span> <span class="p">{</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:first-child</span> <span class="p">{</span>
      <span class="na">border</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="na">padding-top</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">span</span> <span class="p">{</span>
      <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
      <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">3</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">h1</span> <span class="p">{</span>
      <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.4</span><span class="kt">em</span><span class="p">;</span>
      <span class="na">text-align</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
      <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">3</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">margin-top</span><span class="o">:</span> <span class="mi">0</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<h2 id='section-7-2'><span>7.2</span> 注册表单</h2>


<p>用户资料页面已经可以访问了，但内容还不完整。下面我们要为网站创建一个注册表单。如图 5.9 和图 7.10 所示，“注册”页面还没有什么内容，无法注册新用户。本节会实现如图 7.11 所示的注册表单，添加注册功能。</p>

<p>因为我们要实现通过网页创建用户的功能，现在就把 <a href="chapter6.html#section-6-3-5">6.3.5 节</a>在控制台中创建的用户删除吧。最简单的方法是使用 <code>db:reset</code> 命令：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake db:reset
</pre></div>
</div>
<p>还原数据库后，在有些系统中还要重新准备测试数据库：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div>
</div>
<div class="figure" id="figure-7-8">
  <img src="figures/profile_custom_gravatar_bootstrap_4_0.png" alt="profile custom gravatar bootstrap 40" /><p class="caption"><span>图 7.8：</span>显示用户真实头像的用户资料页面 <a href="http://localhost:3000/users/1">/users/1</a></p>
</div>
<p>在某些系统中还要重启 Web 服务器，还原数据库的操作才能生效。<sup class="footnote" id="fnref-7-8"><a href="#fn-7-8" rel="footnote">8</a></sup></p>

<h3 id='section-7-2-1'><span>7.2.1</span> 测试用户注册功能</h3>


<p>在 Web 框架没有完全支持测试之前，测试是件很痛苦的事，也很容易出错。例如，手动测试“注册”页面时，我们要在浏览器中访问这个页面，然后分别提交不合法的和合法的数据，检查在这两种情况下应用程序的表现是否正常。而且，每次修改程序后，都要重复上述的操作。使用 RSpec 和 Capybara 之后，以前需要手动进行的测试，现在可以编写测试用例自动执行了。</p>

<p>前面的章节已经介绍过 Capybara 访问网页时使用的很直观的句法，其中用的最多的就是访问某个页面的 <code>visit</code> 方法。Capybara 的功能可不仅限于此，它还可以填写如图 7.11 所示的表单字段，然后点击提交按钮，句法如下：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">fill_in</span> <span class="s2">"Name"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s2">"Example User"</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">click_button</span> <span class="s2">"Create my account"</span>
</pre></div>
</div>
<p>现在我们要分别提交不合法的和合法的注册数据，验证注册功能是否可以正常使用。我们要用到的测试相对高级一些，所以会慢慢分析。如果你想查看最终的测试代码（以及测试文件的位置），可以直接跳到代码 7.16。先来测试没有正确填写信息的注册表单，我们访问“注册”页面，什么也不填，直接点击注册按钮（调用 <code>click_button</code> 方法），这个操作模拟的就是提交不合法数据的情况：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">click_button</span> <span class="s2">"Create my account"</span>
</pre></div>
</div>
<div class="figure" id="figure-7-9">
  <img src="figures/user_show_sidebar_css_bootstrap.png" alt="user show sidebar css bootstrap" /><p class="caption"><span>图 7.9：</span>添加侧边栏并定义了样式之后的用户资料页面 <a href="http://localhost:3000/users/1">/users/1</a></p>
</div>
<p>上面的代码，等同于手动访问注册页面，然后提交空白的不合法注册信息。相对的，我们要调用 <code>fill_in</code> 方法填写合法信息，以此来模拟提交合法数据的情况：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">fill_in</span> <span class="s2">"Name"</span><span class="p">,</span>         <span class="ss">with</span><span class="p">:</span> <span class="s2">"Example User"</span>
<span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>        <span class="ss">with</span><span class="p">:</span> <span class="s2">"user@example.com"</span>
<span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span>     <span class="ss">with</span><span class="p">:</span> <span class="s2">"foobar"</span>
<span class="n">fill_in</span> <span class="s2">"Confirmation"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s2">"foobar"</span>
<span class="n">click_button</span> <span class="s2">"Create my account"</span>
</pre></div>
</div>
<p>我们测试的最终目的，是要检测点击“Create my account”按钮之后，程序的表现是否正常，即当提交合法的数据时，创建新用户；当提交不合法的数据时，不创建新用户。检测是否创建了新用户，我们要看用户的数量是否发生了变化，在测试中，我们使用每个 Active Record 对象都可以响应的 <code>count</code> 方法来获取对象的数量，以用户为例，即：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>rails console
&gt;&gt; User.count
<span class="o">=</span>&gt; 0
</pre></div>
</div>
<div class="figure" id="figure-7-10">
  <img src="figures/new_signup_page_bootstrap.png" alt="new signup page bootstrap" /><p class="caption"><span>图 7.10：</span>“注册”页面现在的样子 <a href="http://localhost:3000/signup">/signup</a></p>
</div>
<p>现在 <code>User.count</code> 的返回值是 0，因为本节开头我们还原了数据库。提交不合法数据时，我们希望用户的数量是不变的；提交合法数据时，我们希望用户的数量增加 1 个。在 RSpec 中，上面的设想要结合 <code>expect</code> 和 <code>to</code>，或者和 <code>not_to</code> 方法来表述。我们先从不合法的数据开始，因为这种情况比较简单。我们先访问“注册”页面，然后点击提交按钮，希望用户的数量不变：</p>

<div class="codeblock"><div class="highlight type-sh"><pre>visit signup_path
expect <span class="o">{</span> click_button <span class="s2">"Create my account"</span> <span class="o">}</span>.not_to change<span class="o">(</span>User, :count<span class="o">)</span>
</pre></div>
</div>
<p>注意，通过花括号我们可以看出，<code>expect</code> 把 <code>click_button</code> 包含在一个块中（参见 <a href="chapter4.html#section-4-3-2">4.3.2 节</a>），这是为 <code>change</code> 方法做的特殊处理。<code>change</code> 方法可接受两个参数，第一个参数是对象名，第二个是 Symbol。<code>change</code> 方法会在 <code>expect</code> 块中的代码执行前后，分别计算在第一个参数上调用第二参数代表的方法返回的结果。也就是说，如下的代码</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Create my account"</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>
<p>会在执行</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">click_button</span> <span class="s2">"Create my account"</span>
</pre></div>
</div>
<p>前后，两次计算</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="no">User</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>
<p>的结果。</p>

<div class="figure" id="figure-7-11">
  <img src="figures/signup_mockup_bootstrap.png" alt="signup mockup bootstrap" /><p class="caption"><span>图 7.11：</span>“注册”页面的构思图</p>
</div>
<p>本例，我们用 <code>not_to</code> 方法表示不愿看到用户数量发生变化。把点击按钮的代码放入块中，相当于把</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">initial</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="n">click_button</span> <span class="s2">"Create my account"</span>
<span class="n">final</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="n">expect</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="n">final</span>
</pre></div>
</div>
<p>替换成简单的一行代码</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Create my account"</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>
<p>这样读起来更顺口，代码也更简洁。（注意，<code>eq</code> 是 RSpec 提供的方法，用来测试是否相等。）</p>

<p>提交合法数据的情况和上述不合法数据的情况类似，不过用户数量不是不变，而是增加了 1 个：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">visit_signup</span> <span class="n">path</span>
<span class="n">fill_in</span> <span class="s2">"Name"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s2">"Example User"</span>
<span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s2">"user@example.com"</span>
<span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s2">"foobar"</span>
<span class="n">fill_in</span> <span class="s2">"Confirmation"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s2">"foobar"</span>
<span class="n">expect</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">"Create my account"</span>
<span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>这里使用了 <code>to</code> 方法，我们希望点击提交按钮后，这些合法的数据可以用来创建一个新用户。我们把上面两种情况放入一个 <code>describe</code> 块中，再把共用的代码放入 <code>before</code> 块中，最终得到的注册功能测试代码如代码 7.16 所示。我们还做了一项重构，用 <code>let</code> 方法定义了 <code>submit</code> 变量，表示注册按钮的文本。</p>

<div class="codeblock has-caption" id="codeblock-7-16"><p class="caption"><span>代码 7.16：</span>测试用户注册功能的代码</p><p class="file"><code>spec/requests/user_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"signup"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:submit</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"Create my account"</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"with invalid information"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s2">"should not create a user"</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">"Name"</span><span class="p">,</span>         <span class="ss">with</span><span class="p">:</span> <span class="s2">"Example User"</span>
        <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>        <span class="ss">with</span><span class="p">:</span> <span class="s2">"user@example.com"</span>
        <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span>     <span class="ss">with</span><span class="p">:</span> <span class="s2">"foobar"</span>
        <span class="n">fill_in</span> <span class="s2">"Confirmation"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s2">"foobar"</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"should create a user"</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>后续几节还会添加更多的测试，不过现在这个测试已经可以检测相当多的功能表现是否正常了。若要使这个测试通过，先得创建包含正确元素的注册页面，提交注册信息后页面要转向正确的地址，而且如果数据是合法的，还要创建一个新用户，并存入数据库中。</p>

<p>当然了，现在测试还是失败的：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<h3 id='section-7-2-2'><span>7.2.2</span> 使用 form_for</h3>


<p>我们已经为用户注册功能编写了适当的测试代码，接下来要创建用户注册表单了。在 Rails 中，创建表单可以使用 <code>form_for</code> 帮助方法，指定其参数为 Active Record 对象，然后使用对象的属性构建表单的字段。注册表单的视图如代码 7.17 所示。（熟悉 Rails 2.x 的读者要注意一下，这里 <code>form_for</code> 使用的是 <code>&lt;%=...%&gt;</code> 形式，而 Rails 2.x 使用的是 <code>&lt;%...%&gt;</code> 形式。）</p>

<div class="codeblock has-caption" id="codeblock-7-17"><p class="caption"><span>代码 7.17：</span>用户注册表单</p><p class="file"><code>app/views/users/new.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Sign up'</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;h1&gt;Sign up&lt;/h1&gt;</span>

<span class="x">&lt;div class="row"&gt;</span>
<span class="x">  &lt;div class="span6 offset3"&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirmation"</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Create my account"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;/div&gt;</span>
<span class="x">&lt;/div&gt;</span>
</pre></div>
</div>
<p>我们来分析一下这些代码。在上面的代码中，我们使用了关键词 <code>do</code>，说明 <code>form_for</code> 后面可以跟着块，而且可以传入一个块参数 <code>f</code>，代表这个表单：</p>

<div class="codeblock"><div class="highlight type-erb"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  .</span>
<span class="x">  .</span>
<span class="x">  .</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>我们一般无需了解 Rails 帮助方法的内部实现，但是对于 <code>form_for</code> 来说，我们要知道 <code>f</code> 对象的作用是什么：调用表单字段（例如，文本字段、单选按钮、密码字段）对应的方法时，生成的表单字段元素可以用来设定 <code>@user</code> 对象的属性。也就是说：</p>

<div class="codeblock"><div class="highlight type-erb"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>生成的 HTML 是一个有标号（label）的文本字段，可以用来设定 User 模型的 <code>name</code> 属性。（<a href="chapter7.html#section-7-2-3">7.2.3 节</a>会看到生成的 HTML）看过生成的 HTML 才能理解为什么字段可以设定属性。在此之前，还有个问题要解决，因为没有定义 <code>@user</code> 变量，页面无法显示。和其他未定义的实例变量一样，<code>@user</code> 的值现在是 <code>nil</code>。所以如果运行测试的话，会看到代码 7.6 中针对注册页面内容的测试是失败的：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb -e <span class="s2">"signup page"</span>
</pre></div>
</div>
<p>（上述命令中的 <code>-e</code> 参数指定只运行描述文本包含“signup page”字符串的测试用例。如果改成“signup”，则会运行代码 7.16 中的所有测试。）</p>

<p>要使这个测试通过，同时也让页面可以正常显示，我们要在 <code>new.html.erb</code> 视图对应的 <code>new</code> 动作中定义 <code>@user</code> 变量。<code>form_for</code> 方法的参数需要一个 User 对象，而且我们要创建新用户，所以我们可以使用 <code>User.new</code> 方法，如代码 7.18 所示。</p>

<div class="codeblock has-caption" id="codeblock-7-18"><p class="caption"><span>代码 7.18：</span>在 <code>new</code> 动作中定义 <code>@user</code> 变量</p><p class="file"><code>app/controllers/users_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>定义 <code>@user</code> 变量后，注册页面的测试就可以通过了：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb -e <span class="s2">"signup page"</span>
</pre></div>
</div>
<p>再添加代码 7.19 中的样式，表单的效果如图 7.12 所示。注意，我们再次用到了代码 7.2 中的 <code>box-sizing</code> 这个 mixin。</p>

<div class="codeblock has-caption" id="codeblock-7-19"><p class="caption"><span>代码 7.19：</span>注册表单的样式</p><p class="file"><code>app/assets/stylesheets/custom.css.scss</code></p><div class="highlight type-scss"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">forms</span> <span class="o">*/</span>

<span class="nt">input</span><span class="o">,</span> <span class="nt">textarea</span><span class="o">,</span> <span class="nt">select</span><span class="o">,</span> <span class="nc">.uneditable-input</span> <span class="p">{</span>
  <span class="na">border</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#bbb</span><span class="p">;</span>
  <span class="na">width</span><span class="o">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">@include</span><span class="nd"> box_sizing</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">input</span> <span class="p">{</span>
  <span class="na">height</span><span class="o">:</span> <span class="no">auto</span> <span class="nv">!important</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<h3 id='section-7-2-3'><span>7.2.3</span> 表单的 HTML</h3>


<p>如图 7.12 所示，“注册”页面现在可以正常显示了，说明代码 7.17 中的 <code>form_for</code> 方法生成了合法的 HTML。生成的表单 HTML（可以使用 Firebug 或浏览器的“查看源文件”菜单查看）如代码7.20 所示。某些细节现在无需关心，我们只解说最重要的结构。</p>

<div class="codeblock has-caption" id="codeblock-7-20"><p class="caption"><span>代码 7.20：</span>图 7.12 中表单的 HTML</p><div class="highlight type-html"><pre><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">"UTF-8"</span> <span class="na">action=</span><span class="s">"/users"</span> <span class="na">class=</span><span class="s">"new_user"</span>
      <span class="na">id=</span><span class="s">"new_user"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_name"</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_name"</span> <span class="na">name=</span><span class="s">"user[name]"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_email"</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_email"</span> <span class="na">name=</span><span class="s">"user[email]"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_password"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_password"</span> <span class="na">name=</span><span class="s">"user[password]"</span>
         <span class="na">type=</span><span class="s">"password"</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_password_confirmation"</span><span class="nt">&gt;</span>Confirmation<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_password_confirmation"</span>
         <span class="na">name=</span><span class="s">"user[password_confirmation]"</span> <span class="na">type=</span><span class="s">"password"</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"btn btn-large btn-primary"</span> <span class="na">name=</span><span class="s">"commit"</span> <span class="na">type=</span><span class="s">"submit"</span>
         <span class="na">value=</span><span class="s">"Create my account"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<div class="figure" id="figure-7-12">
  <img src="figures/signup_form_bootstrap.png" alt="signup form bootstrap" /><p class="caption"><span>图 7.12：</span>注册用户的表单 <a href="http://localhost:3000/signup">/signup</a></p>
</div>
<p>（上面的代码省略了“鉴别权标（authenticity token）”相关的 HTML。Rails 使用鉴别权标来防止跨站请求伪造（cross-site request forgery, CSRF）攻击。如果你对鉴别权标感兴趣，可以阅读一下 Stack Overflow 网站中的《<a href="http://stackoverflow.com/questions/941594/understand-rails-authenticity-token">Understand Rails Authenticity Token!</a>》一文，这篇文章介绍了鉴别权标的工作原理及重要意义。）</p>

<p>下面看一下表单的字段。比较代码 7.17 和代码 7.20 之后，我们可以看到，如下的 ERb 代码</p>

<div class="codeblock"><div class="highlight type-erb"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>生成的 HTML 是</p>

<div class="codeblock"><div class="highlight type-html"><pre><span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_name"</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_name"</span> <span class="na">name=</span><span class="s">"user[name]"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<div class="figure" id="figure-7-13">
  <img src="figures/filled_in_form_bootstrap.png" alt="filled in form bootstrap" /><p class="caption"><span>图 7.13：</span>填写了文本字段和密码字段的表单</p>
</div>
<p>下面的 ERb 代码</p>

<div class="codeblock"><div class="highlight type-erb"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>生成的 HTML 是</p>

<div class="codeblock"><div class="highlight type-html"><pre><span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_password"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_password"</span> <span class="na">name=</span><span class="s">"user[password]"</span> <span class="na">type=</span><span class="s">"password"</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<p>如图 7.13 所示，文本字段（<code>type="text"</code>）会直接显示填写的内容，而密码字段（<code>type="password"</code>）基于安全考虑会遮盖输入的内容。</p>

<p>在 <a href="chapter7.html#section-7-4">7.4 节</a>中我们会介绍，之所以可以创建用户，全赖于 <code>input</code> 元素的 <code>name</code> 属性：</p>

<div class="codeblock"><div class="highlight type-html"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_name"</span> <span class="na">name=</span><span class="s">"user[name]"</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
.
.
.
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_password"</span> <span class="na">name=</span><span class="s">"user[password]"</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<div class="figure" id="figure-7-14">
  <img src="figures/signup_failure_mockup_bootstrap.png" alt="signup failure mockup bootstrap" /><p class="caption"><span>图 7.14：</span>注册失败后的页面构思图</p>
</div>
<p>Rails 会以 <code>name</code> 属性的值为键，用户输入的内容为值，构成一个名为 <code>params</code> 的 Hash，用来创建用户。另外一个重要的标签是 <code>form</code>。我们使用 <code>@user</code> 对象来创建 <code>form</code>元素，因为每个 Ruby 对象都知道它所属的类（参见 <a href="chapter4.html#section-4-4-1">4.4.1 节</a>），所以 Rails 知道 <code>@user</code> 所属的类是 <code>User</code>；而且，<code>@user</code> 代表的是新创建的用户，Rails 知道要使用 <code>POST</code> 请求方法，这正是创建新对象所需的 HTTP 请求（参见<a href="chapter3.html#aside-3-3">旁注 3.3</a>）：</p>

<div class="codeblock"><div class="highlight type-html"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/users"</span> <span class="na">class=</span><span class="s">"new_user"</span> <span class="na">id=</span><span class="s">"new_user"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
</pre></div>
</div>
<p>先不看 <code>class</code> 和 <code>id</code> 属性，我们现在关注的是 <code>action="/users"</code> 和 <code>method="post"</code>。设定这两个属性后，Rails 就会向 /users 地址发送一个 <code>POST</code> 请求。接下来的两节会介绍这个请求产生的效果。</p>

<h2 id='section-7-3'><span>7.3</span> 注册失败</h2>


<p>虽然上一节大概的介绍了图 7.12 中表单的 HTML 结构（参见代码 7.20），不过注册失败时才能更好的理解这个表单的作用。本节，我们会在注册表单中填写一些不合法的数据，提交表单后，页面不会转向其他页面，而是返回“注册”页面，显示一些错误提示信息，页面的构思图如图7.14 所示。</p>

<h3 id='section-7-3-1'><span>7.3.1</span> 可正常使用的表单</h3>


<p>回顾一下 <a href="chapter7.html#section-7-1-2">7.1.2 节</a>中的内容，在 <code>routes.rb</code> 中设置 <code>resources :users</code> 之后（参见代码 7.3），Rails 应用程序就可以响应<a href="chapter7.html#table-7-1">表格 7.1</a>中符合 REST 架构的 URI 地址了。一般来说，发送到 /users 地址的 <code>POST</code> 请求是由 <code>create</code> 动作处理的。在 <code>create</code> 动作中，我们可以调用 <code>User.new</code> 方法，使用提交的数据创建一个新用户对象，尝试存入数据库，失败后再重新渲染“注册”页面，允许访客重新填写注册信息。我们先来看一下生成的 <code>form</code> 元素：</p>

<div class="codeblock"><div class="highlight type-html"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/users"</span> <span class="na">class=</span><span class="s">"new_user"</span> <span class="na">id=</span><span class="s">"new_user"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
</pre></div>
</div>
<p>在 <a href="chapter7.html#section-7-2-3">7.2.3 节</a>中介绍过，这个表单会向 /users 地址发送 <code>POST</code> 请求。</p>

<p>添加代码 7.21 之后，代码 7.16 中对不合法数据的测试就可以通过了。代码 7.21 中再次调用了 <code>render</code> 方法，第一使用时是为了插入局部视图（参见<a href="chapter5.html#section-5-1-3">5.1.3 节</a>），不过如你所见，在控制器的动作中也可以使用这个方法。同时，我们也借此代码介绍了 <code>if-else</code> 分支结构的用法：根据 <code>@user.save</code> 的返回值，分别处理用户存储成功和失败这两种情况（存储成功时返回值为 <code>true</code>，失败时返回值为 <code>false</code>）。</p>

<div class="codeblock has-caption" id="codeblock-7-21"><p class="caption"><span>代码 7.21：</span>处理存储失败的 <code>create</code> 动作（还不能处理存储成功的情况）</p><p class="file"><code>app/controllers/users_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>    <span class="c1"># Not the final implementation!</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="c1"># Handle a successful save.</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>留意代码 7.21 中的注释，这并不是最终的实现方式，但现在完全够用。最终版会在 <a href="chapter7.html#section-7-3-2">7.3.2 节</a>中实现。</p>

<p>我们要实际的操作一下，提交一些不合法的注册数据，这样才能更好的理解代码 7.21 的作用，结果如图 7.15 所示，底部完整的调试信息如图 7.16 所示。</p>

<div class="figure" id="figure-7-15">
  <img src="figures/signup_failure_rails_4.png" alt="signup failure rails 4" /><p class="caption"><span>图 7.15：</span>注册失败</p>
</div>
<p>下面我们来分析一下调试信息中请求参数 Hash 的 <code>user</code> 部分（如图 7.16），以便对 Rails 处理表单的过程有个更清晰地认识：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="s2">"user"</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s2">"name"</span> <span class="o">=&gt;</span> <span class="s2">"Foo Bar"</span><span class="p">,</span>
            <span class="s2">"email"</span> <span class="o">=&gt;</span> <span class="s2">"foo@invalid"</span><span class="p">,</span>
            <span class="s2">"password"</span> <span class="o">=&gt;</span> <span class="s2">"[FILTERED]"</span><span class="p">,</span>
            <span class="s2">"password_confirmation"</span> <span class="o">=&gt;</span> <span class="s2">"[FILTERED]"</span>
          <span class="p">}</span>
</pre></div>
</div>
<p>在 <a href="chapter7.html#section-7-1-2">7.1.2 节</a>中就说过，<code>params</code> Hash 中包含了每次请求的信息，例如向 /users/1 发送的请求，<code>params[:id]</code> 的值就是用户的 id，即 1。提交表单发送 <code>POST</code> 请求时，<code>params</code> 则是一个嵌套的 Hash。嵌套 Hash 在 <a href="chapter4.html#section-4-3-3">4.3.3 节</a>中使用控制台介绍 <code>params</code> 时用过。上面的调试信息说明，提交表单后，Rails 会构建一个名为 <code>user</code> 的 Hash，其键是 <code>input</code> 标签的 <code>name</code> 属性值（参见代码 7.17），键对应的值是用户填写的字段文本。例如，</p>

<div class="codeblock"><div class="highlight type-html"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_email"</span> <span class="na">name=</span><span class="s">"user[email]"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<div class="figure" id="figure-7-16">
  <img src="figures/signup_failure_rails_4_debug.png" alt="signup failure rails4 debug" /><p class="caption"><span>图 7.16：</span>注册失败时的调试信息</p>
</div>
<p>该字段 <code>name</code> 属性的值是 <code>user[email]</code>，它代表的就是 <code>user</code> Hash 的 <code>email</code> 元素。</p>

<p>虽然调试信息中的键是字符串形式，不过却以 Symbol 形式传递给 Users 控制器。<code>params[:user]</code> 这个嵌套的 Hash，实际上就是 <code>User.new</code> 方法创建用户所需的参数值。（我们在 <a href="chapter4.html#section-4-4-5">4.4.5 节</a>中介绍过 <code>User.new</code> 的用法，代码 7.21 再次用到了这个方法。）也就是说，如下的代码</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
<p>基本上等同于</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Foo Bar"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"foo@invalid"</span><span class="p">,</span>
                 <span class="ss">password</span><span class="p">:</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="n">password_confirmation</span><span class="p">:</span> <span class="s2">"bar"</span><span class="p">)</span>
</pre></div>
</div>
<p>在 Rails 之前的版本中，使用</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
<p>就行了，但默认情况下这种用法并不安全，需要采用谨慎的处理过程避免恶意用户篡改程序的数据库。在 Rails 4.0 中，这行代码会抛出异常（如图 7.15 和图 7.16 所示），这样就安全了。保险起见，我们可以看一下测试是否是失败的：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
-e <span class="s2">"signup with invalid information"</span>
</pre></div>
</div>
<h3 id='section-7-3-2'><span>7.3.2</span> 健壮参数</h3>


<p>我们在 <a href="chapter4.html#section-4-4-5">4.4.5 节</a>中提到过 mass assignment，使用一个 Hash 初始化 Ruby 变量，例如下面这行代码</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>    <span class="c1"># Not the final implementation!</span>
</pre></div>
</div>
<p>上面这行代码中的注释来自代码 7.21，说明这不是最终的实现方式。因为初始化整个 <code>params</code> Hash 是十分危险的，一旦初始化就会把用户提交的所有数据传递给 <code>User.new</code> 方法。假设除了前述的属性，User 模型还包含 <code>admin</code> 属性，用来标识网站的管理员。（我们会在 <a href="chapter9.html#section-9-4-1">9.4.1 节</a>加入这个属性。）要把这个属性设为 <code>true</code>，就要在 <code>params[:user]</code> 中包含 <code>admin='1'</code>，这个过程可以轻易的使用 <code>curl</code> 这种命令行 HTTP 客户端实现。结果是，把整个 <code>params</code> 传递给 <code>User.new</code> 网站的任一用户都可以在请求中包含 <code>admin='1'</code> 来获取管理员权限。</p>

<p>在 Rails 的之前版本中可以在模型层中使用 <code>attr_accessible</code> 方法解决这个问题，但在 Rails 4.0 中推荐的方法是在控制器层使用一种叫做“健壮参数”（strong parameter）的技术。这个技术可以指定需要哪些请求参数，允许传入哪些请求参数。而且，如果按照上面的方式传入整个 <code>params</code> Hash，程序会抛出异常，所以现在的 Rails 程序默认情况下已经堵住 mass assignment 漏洞了。</p>

<p>本例，我们需要 <code>params</code> Hash 包含 <code>:user</code> 元素，而且只允许传入 <code>name</code>、<code>email</code>、<code>password</code> 和 <code>password_confirmation</code> 属性。所需代码如下：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">)</span>
</pre></div>
</div>
<p>这行代码会返回一个 <code>params</code> Hash，只包含允许使用的属性，而且如果没有指定 <code>:user</code> 元素会抛出异常。</p>

<p>为了使用方便，可以定义一个名为 <code>user_params</code> 的辅助方法，返回所需的 Hash。这个方法只会在 Users 控制器内部使用，不需要暴露给用户，所以我们可以使用 Ruby 中的 <code>private</code> 方法把这个方法设为私有作用域，如代码 7.22 所示。（我们会在 <a href="chapter8.html#section-8-2-1">8.2.1 节</a>中更详细的介绍 <code>private</code>。）</p>

<div class="codeblock has-caption" id="codeblock-7-22"><p class="caption"><span>代码 7.22：</span>在 <code>create</code> 动作中使用健壮参数</p><p class="file"><code>app/controller/users_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="c1"># Handle a successful save.</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>添加了上述代码后，针对不合法数据的测试应该可以通过了：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
-e <span class="s2">"signup with invalid information"</span>
</pre></div>
</div>
<h3 id='section-7-3-3'><span>7.3.3</span> 注册时的错误提示信息</h3>


<p>处理注册失败的最后一步，我们要加入一个错误提示信息，说明注册失败的原因。默认情况下 Rails 会显示这样的信息，基于 User 模型的数据验证机制实现。举个例子，我们试着用不合法的 Email 地址和长度较短的密码创建用户看看会发生什么：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>rails console
&gt;&gt; <span class="nv">user</span> <span class="o">=</span> User.new<span class="o">(</span>name: <span class="s2">"Foo Bar"</span>, email: <span class="s2">"foo@invalid"</span>,
?&gt;                 password: <span class="s2">"dude"</span>, password_confirmation: <span class="s2">"dude"</span><span class="o">)</span>
&gt;&gt; user.save
<span class="o">=</span>&gt; <span class="nb">false</span>
&gt;&gt; user.errors.full_messages
<span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Email is invalid"</span>, <span class="s2">"Password is too short (minimum is 6 characters)"</span><span class="o">]</span>
</pre></div>
</div>
<p>如上所示，<code>errors.full_message</code> 对象是一个错误信息组成的数组。和上面的控制台对话类似，代码 7.21 中的代码也无法保存用户，会生成一个附属在 <code>@user</code> 对象上的错误信息数组。如果要在注册页面显示这些错误，我们需要渲染一个错误信息局部视图，如代码 7.23 所示。（最好先为这些错误信息编写测试，我们会把这个任务留作练习，详情参见 <a href="chapter7.html#section-7-6">7.6 节</a>。）注意，这个局部视图只是暂时使用，我们会在 <a href="chapter10.html#section-10-3-3">10.3.2 节</a>中编写最终版本。</p>

<div class="codeblock has-caption" id="codeblock-7-23"><p class="caption"><span>代码 7.23：</span>在注册表单前显示的错误提示信息</p><p class="file"><code>app/views/users/new.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Sign up'</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;h1&gt;Sign up&lt;/h1&gt;</span>

<span class="x">&lt;div class="row"&gt;</span>
<span class="x">  &lt;div class="span6 offset3"&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      .</span>
<span class="x">      .</span>
<span class="x">      .</span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;/div&gt;</span>
<span class="x">&lt;/div&gt;</span>
</pre></div>
</div>
<p>注意，在上面的代码中渲染的局部视图名为 <code>shared/error_messages</code>，这里用到了 Rails 的一个约定：如果局部视图要在多个控制器中使用，则把它存放在专门的 <code>shared</code> 目录下。（这个约定 <a href="chapter9.html#section-9-1-1">9.1.1 节</a>还会再介绍）我们除了要新建 <code>_error_messages.html.erb</code> 文件之外，还要新建 <code>app/views/shared</code> 文件夹。错误提示信息局部视图的内容如代码 7.24 所示。</p>

<div class="codeblock has-caption" id="codeblock-7-24"><p class="caption"><span>代码 7.24：</span>显示表单错误提示信息的局部视图</p><p class="file"><code>app/views/shared/_error_messages.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;div id="error_explanation"&gt;</span>
<span class="x">    &lt;div class="alert alert-error"&gt;</span>
<span class="x">      The form contains </span><span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x">.</span>
<span class="x">    &lt;/div&gt;</span>
<span class="x">    &lt;ul&gt;</span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      &lt;li&gt;* </span><span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="x">&lt;/li&gt;</span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    &lt;/ul&gt;</span>
<span class="x">  &lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>这个局部视图的代码使用了几个之前没用过的 Rails/Ruby 结构，还有两个新方法。第一个新方法是 <code>count</code>，它的返回值是错误信息的数量：</p>

<div class="codeblock"><div class="highlight type-sh"><pre>&gt;&gt; user.errors.count
<span class="o">=</span>&gt; 2
</pre></div>
</div>
<p>第二个新方法是 <code>any?</code>，它和 <code>empty?</code> 的作用相反：</p>

<div class="codeblock"><div class="highlight type-sh"><pre>&gt;&gt; user.errors.empty?
<span class="o">=</span>&gt; <span class="nb">false</span>
&gt;&gt; user.errors.any?
<span class="o">=</span>&gt; <span class="nb">true</span>
</pre></div>
</div>
<p>第一次使用 <code>empty?</code> 方法是在 <a href="chapter4.html#section-4-2-3">4.2.3 节</a>，用在字符串上；从上面的代码可以看出，<code>empty?</code> 也可用在 Rails 错误信息对象上，如果对象为空就返回 <code>true</code>，否则返回 <code>false</code>。<code>any?</code> 方法就是取反 <code>empty?</code> 的返回值，如果对象中有内容就返回 <code>true</code>，没内容则返回 <code>false</code>。（顺便说一下，<code>count</code>、<code>empty?</code> 和 <code>any?</code> 都可以用在 Ruby 数组上，在 <a href="chapter10.html#section-10-2">10.2 节</a>中会好好地介绍这三个方法。）</p>

<div class="figure" id="figure-7-17">
  <img src="figures/signup_error_messages_bootstrap.png" alt="signup error messages bootstrap" /><p class="caption"><span>图 7.17：</span>注册失败时显示的错误提示信息</p>
</div>
<p>还有一个比较新的方法是 <code>pluralize</code>，在控制台中默认不可用，不过我们可以引入 <code>ActionView::Helpers::TextHelper</code> 模块加载这个方法：<sup class="footnote" id="fnref-7-9"><a href="#fn-7-9" rel="footnote">9</a></sup></p>

<div class="codeblock"><div class="highlight type-sh"><pre>&gt;&gt; include ActionView::Helpers::TextHelper
&gt;&gt; pluralize<span class="o">(</span>1, <span class="s2">"error"</span><span class="o">)</span>
<span class="o">=</span>&gt; <span class="s2">"1 error"</span>
&gt;&gt; pluralize<span class="o">(</span>5, <span class="s2">"error"</span><span class="o">)</span>
<span class="o">=</span>&gt; <span class="s2">"5 errors"</span>
</pre></div>
</div>
<p>如上所示，<code>pluralize</code> 方法的第一个参数是整数，返回值是这个数字和第二个参数文本组合在一起正确的单复数形式。<code>pluralize</code> 方法是由功能强大的转置器（inflector）实现的，转置器知道怎么处理大多数单词的单复数变换，甚至是一些不规则的变换方式：</p>

<div class="codeblock"><div class="highlight type-sh"><pre>&gt;&gt; pluralize<span class="o">(</span>2, <span class="s2">"woman"</span><span class="o">)</span>
<span class="o">=</span>&gt; <span class="s2">"2 women"</span>
&gt;&gt; pluralize<span class="o">(</span>3, <span class="s2">"erratum"</span><span class="o">)</span>
<span class="o">=</span>&gt; <span class="s2">"3 errata"</span>
</pre></div>
</div>
<p>所以，使用 <code>pluralize</code> 方法后，如下的代码</p>

<div class="codeblock"><div class="highlight type-erb"><pre><span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>返回值就是 <code>"0 errors"</code>、<code>"1 error"</code> 或 <code>"2 errors"</code>等，单复数形式取决于错误的数量。这样就可以避免类似 <code>"1 errors"</code> 这种低级的错误了（这是网络中常见的错误之一）。注意，代码 7.24 中还为一个 <code>div</code> 标签指定了 <code>error_explanation</code> id，可用来样式化错误提示信息。（在 <a href="chapter5.html#section-5-1-2">5.1.2 节</a>中介绍过，CSS 中以 <code>#</code> 开头的规则是用来给 id 添加样式的。）出错时，Rails 还会自动把有错误的字段包含在一个 class 为 <code>field_with_errors</code> 的 <code>div</code> 元素中。我们可以利用这个 id 和 class 为错误提示信息添加样式，所需的 SCSS 如代码 7.24 所示。代码 7.25 中使用 Sass 的 <code>@extend</code> 函数引入了 <code>control-group</code> 和 <code>error</code> 两个样式规则集合。添加样式后，如果提交失败，错误信息和出错的字段就会显示为红色，如图 7.17 所示。错误信息的文本是基于模型数据验证自动生成的，所以如果你修改了验证规则（例如，Email 地址的格式，密码的最小长度），错误信息就会自动变化，符合修改后的规则。</p>

<div class="codeblock has-caption" id="codeblock-7-25"><p class="caption"><span>代码 7.25：</span>错误提示信息的样式</p><p class="file"><code>app/assets/stylesheets/custom.css.scss</code></p><div class="highlight type-scss"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">forms</span> <span class="o">*/</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nn">#error_explanation</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#f00</span><span class="p">;</span>
  <span class="nt">ul</span> <span class="p">{</span>
    <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
    <span class="na">margin</span><span class="o">:</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">18</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.field_with_errors</span> <span class="p">{</span>
  <span class="k">@extend</span> <span class="nc">.control-group</span><span class="o">;</span>
  <span class="o">@</span><span class="nt">extend</span> <span class="nc">.error</span><span class="o">;</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>我们可以通过下面的方法模拟代码 7.16 中针对不合法数据的测试过程，来看一下本节编程的效果：在浏览器中，访问“注册”页面，什么也不填，直接点击“Create my account”按钮。结果如图 7.18 所示。既然“注册”页面可以正常使用了，相应的测试也应该可以通过了。</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
&gt; -e <span class="s2">"signup with invalid information"</span>
</pre></div>
</div>
<div class="figure" id="figure-7-18">
  <img src="figures/blank_signup_password_digest_bootstrap_4_0.png" alt="blank signup password digest bootstrap 40" /><p class="caption"><span>图 7.18：</span>访问“注册”页面后直接点击“Create my account”按钮的效果</p>
</div>
<h2 id='section-7-4'><span>7.4</span> 注册成功</h2>


<p>上一节已经处理了提交不合法数据的情况，本节我们要完成注册表单的功能，如果提交的数据合法，就把用户存入数据库。我们先尝试保存用户，如果保存成功，用户的数据就会存入数据库中，然后网页会转向刚注册用户的资料页面，页面中会显示一个欢迎信息，构思图如图 7.19 所示。如果保存用户失败了，就交由上一节实现的功能处理。</p>

<h3 id='section-7-4-1'><span>7.4.1</span> 完整的注册表单</h3>


<p>要完成注册表单的功能，我们要把代码 7.21 中的注释部分换成相应的处理代码。现在，对提交合法数据的测试还是失败的：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
&gt; -e <span class="s2">"signup with valid information"</span>
</pre></div>
</div>
<p>测试之所以会失败，是因为 Rails 处理动作的默认方式是渲染视图，可是 <code>create</code> 动作还没有（也不应该有）对应的视图。相反的，我们要转向其他的页面，最合理的转向页面是刚创建用户的资料页面。检测是否转向正确页面的测试会留作练习（参见 <a href="chapter7.html#section-7-6">7.6 节</a>），<code>create</code> 动作的代码如代码 7.26 所示。</p>

<div class="figure" id="figure-7-19">
  <img src="figures/signup_success_mockup_bootstrap.png" alt="signup success mockup bootstrap" /><p class="caption"><span>图 7.19：</span>注册成功后显示的页面构思图</p>
</div>
<div class="codeblock has-caption" id="codeblock-7-26"><p class="caption"><span>代码 7.26：</span><code>create</code> 动作的代码，处理了保存和转向操作</p><p class="file"><code>app/controllers/users_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>注意，转向地址我们直接写了 <code>@user</code>，而没用 <code>user_path</code>，Rails 会自动转向到用户的资料页面。</p>

<p>加入代码 7.26 后，注册表单就可以正常使用了，你可以运行测试验证一下：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<h3 id='section-7-4-2'><span>7.4.2</span> Flash 消息</h3>


<p>验证合法数据是否能够正确提交之前，我们还要加入一个 Web 应用程序大都会实现的功能：在转向后的页面中显示一个消息（这里我们要显示的是一个欢迎新用户的消息），如果访问了其他页面或者刷新了页面，这个消息便会消失。在 Rails 中这种功能是通过 <code>flash</code> 变量实现的，<code>flash</code> 就像闪存一样，只是暂时存储的数据。<code>flash</code> 变量的值其实是一个 Hash，你可能还记得，<a href="chapter4.html#section-4-3-3">4.3.3 节</a>中我们在控制台中遍历了一个名为 <code>flash</code> 的 Hash：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>rails console
&gt;&gt; <span class="nv">flash</span> <span class="o">=</span> <span class="o">{</span> success: <span class="s2">"It worked!"</span>, error: <span class="s2">"It failed."</span> <span class="o">}</span>
<span class="o">=</span>&gt; <span class="o">{</span>:success<span class="o">=</span>&gt;<span class="s2">"It worked!"</span>, error: <span class="s2">"It failed."</span><span class="o">}</span>
&gt;&gt; flash.each <span class="k">do</span> <span class="p">|</span>key, value<span class="p">|</span>
?&gt; puts <span class="s2">"#{key}"</span>
?&gt; puts <span class="s2">"#{value}"</span>
&gt;&gt; end
success
It worked!
error
It failed.
</pre></div>
</div>
<p>我们可以把显示 Flash 消息的代码加入应用程序的布局，这样整个网站在需要的时候就会显示消息了，如代码 7.27 所示。（代码 7.27 混合了 HTML 和 ERb 代码，有点乱，<a href="chapter7.html#section-7-6">7.6 节</a>中的练习会进行重构。）</p>

<div class="codeblock has-caption" id="codeblock-7-27"><p class="caption"><span>代码 7.27：</span>把 <code>flash</code> 消息相关的代码加入网站的布局中</p><p class="file"><code>app/views/layouts/application.html.erb</code></p><div class="highlight type-erb"><pre><span class="x">&lt;!DOCTYPE html&gt;</span>
<span class="x">&lt;html&gt;</span>
<span class="x">  .</span>
<span class="x">  .</span>
<span class="x">  .</span>
<span class="x">  &lt;body&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'layouts/header'</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    &lt;div class="container"&gt;</span>
<span class="x">      </span><span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">        &lt;div class="alert alert-</span><span class="cp">&lt;%=</span> <span class="n">key</span> <span class="cp">%&gt;</span><span class="x">"&gt;</span><span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span><span class="x">&lt;/div&gt;</span>
<span class="x">      </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'layouts/footer'</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    &lt;/div&gt;</span>
<span class="x">    .</span>
<span class="x">    .</span>
<span class="x">    .</span>
<span class="x">  &lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span>
</pre></div>
</div>
<p>代码 7.27 会为每一个 Flash 消息插入一个 <code>div</code> 标签，并且把 CSS class 指定为消息的类型。例如，如果 <code>flash[:success] = "Welcome to the Sample App!"</code>，那么下面的代码</p>

<div class="codeblock"><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;div class="alert alert-</span><span class="cp">&lt;%=</span> <span class="n">key</span> <span class="cp">%&gt;</span><span class="x">"&gt;</span><span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span><span class="x">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>生成的 HTML 如下</p>

<div class="codeblock"><div class="highlight type-html"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-success"</span><span class="nt">&gt;</span>Welcome to the Sample App!<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p>（注意，键 <code>:success</code> 是 Symbol，在插入模板之前，ERb 会自动将其转换成字符串 <code>"success"</code>。）我们遍历了所有可能出现的 Flash 消息，这样当消息存在时才能显示。在 <a href="chapter8.html#section-8-1-5">8.1.5 节</a> 中会使用 <code>flash[:error]</code> 显示登录失败消息。<sup class="footnote" id="fnref-7-10"><a href="#fn-7-10" rel="footnote">10</a></sup></p>

<p>检测页面中是否显示了正确的 Flash 消息的测试留作练习（参见 <a href="chapter7.html#section-7-6">7.6 节</a>）。在 <code>create</code> 动作中给 <code>flash[:success]</code> 赋值一个欢迎信息后（如代码 7.28 所示），这个测试就可以通过了。</p>

<div class="codeblock has-caption" id="codeblock-7-28"><p class="caption"><span>代码 7.28：</span>注册成功后显示 Flash 信息</p><p class="file"><code>app/controllers/users_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Welcome to the Sample App!"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<h3 id='section-7-4-3'><span>7.4.3</span> 首次注册</h3>


<p>现在我们可以注册一下看看到目前为止所实现的功能，用户的名字使用“Rails Tutorial”，Email 地址使用“example@railstutorial.org”。注册成功后，页面中显示了一个友好的欢迎信息，信息的样式是由 <a href="chapter5.html#section-5-1-2">5.1.2 节</a>中加入的 Bootstrap 框架提供的 <code>.success</code> class 实现的，如图 7.20 所示。（如果你无法注册，提示 Email 地址已经使用，请确保你运行了 <a href="chapter7.html#section-7-2">7.2 节</a>中的 <code>rake db:reset</code> 命令。）然后刷新页面，Flash 消息就会消失了，如图 7.21 所示。</p>

<p>我们还可以检查一下数据库，确保真的创建了新用户：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>rails console
&gt;&gt; User.find_by<span class="o">(</span>email: <span class="s2">"example@railstutorial.org"</span><span class="o">)</span>
<span class="o">=</span>&gt; <span class="c">#&lt;User id: 1, name: "Rails Tutorial", email: "example@railstutorial.org",</span>
created_at: <span class="s2">"2013-03-12 05:51:34"</span>, updated_at: <span class="s2">"2013-03-12 05:51:34"</span>,
password_digest: <span class="s2">"$2a$10$A58/j7wwh3aAffGkMAO9Q.jjh3jshd.6akhDKtchAz/R..."</span>&gt;
</pre></div>
</div>
<h3 id='section-7-4-4'><span>7.4.4</span> 部署到生产环境，并开启 SSL</h3>


<p>创建了 User 模型、实现了注册功能之后，现在可以把示例程序部署到生产环境中了。（如果你没有按照<a href="chapter3.html">第 3 章</a>章头介绍中的内容设置生产环境的话，现在最好回过头去设置一下。）部署的时候我们还会开启对安全套接层（Secure Sockets Layer, SSl）<sup class="footnote" id="fnref-7-11"><a href="#fn-7-11" rel="footnote">11</a></sup>协议的支持，确保注册过程的安全。其实我们会全站都开启 SSL，这样用户的登录（参见<a href="chapter8.html">第 8 章</a>）也会很安全了，而且还可以避免会话劫持（session hijacking）的发生（参见 <a href="chapter8.html#section-8-2-1">8.2.1 节</a>）。</p>

<p>在部署之前，你应该把本章实现的功能合并到 <code>master</code> 分支：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>git add .
<span class="nv">$ </span>git commit -m <span class="s2">"Finish user signup"</span>
<span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge sign-up
</pre></div>
</div>
<div class="figure" id="figure-7-20">
  <img src="figures/signup_flash_bootstrap.png" alt="signup flash bootstrap" /><p class="caption"><span>图 7.20：</span>注册成功后显示的页面，页面中有一个 Flash 消息</p>
</div>
<p>然后我们要设置一下，强制在生产环境中使用 SSL，这里我们要编辑的文件是 <code>config/environments/production.rb</code>，添加的设置如代码 7.29 所示。</p>

<div class="codeblock has-caption" id="codeblock-7-29"><p class="caption"><span>代码 7.29：</span>设置程序在生产环境中开启 SSL</p><p class="file"><code>config/environments/production.rb</code></p><div class="highlight type-ruby"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Force all access to the app over SSL, use Strict-Transport-Security,</span>
  <span class="c1"># and use secure cookies.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">force_ssl</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="figure" id="figure-7-21">
  <img src="figures/signup_flash_reloaded_bootstrap.png" alt="signup flash reloaded bootstrap" /><p class="caption"><span>图 7.21：</span>刷新页面后 Flash 消息就不见了</p>
</div>
<p>我们要把这次修改提交到 Git 仓库中，然后再推送到 Heroku，所做的设置才能生效：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>git commit -a -m <span class="s2">"Add SSL in production"</span>
<span class="nv">$ </span>git push heroku
</pre></div>
</div>
<p>然后，我们还要在生产环境中运行数据库迁移，告知 Heroku 我们建立了 User 模型：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>heroku run rake db:migrate
</pre></div>
</div>
<p>（执行这个命令后，你可能会得到一些功能废弃的警告提示，现在可以直接忽视这些警告。）</p>

<p>最后一步，我们要在远程服务器上架设 SSL。在生产环境中架设对 SSL 的支持很麻烦，也很容易出错，而且还要为域名购买 SSL 签名证书。幸好，使用 Heroku 提供的二级域名可以直接使用 Heroku 的 SSL 签名证书，这算是 Heroku 平台的一个特性。如果你要为自己的域名（例如 <code>example.com</code>）开启 SSL，就无法享受这个便利的服务了，还要自行克服一些设置上的麻烦，具体的步骤在 <a href="http://devcenter.heroku.com/articles/ssl">Heroku 关于 SSL 的文档</a>中有说明。</p>

<p>以上所有工作得到的最终结果是，在生产服务器上可以正常使用注册表单了，如图 7.22 所示：</p>

<div class="codeblock"><div class="highlight type-sh"><pre><span class="nv">$ </span>heroku open
</pre></div>
</div>
<p>注意，在图 7.22 中，通常显示为 <code>http://</code> 的地方现在显示的是 <code>https://</code>，就是这个额外的“s”，证明我们正在使用 SSL。</p>

<p>现在你可以打开注册页面注册一个新用户了。如果遇到问题，运行 <code>heroku logs</code>，尝试使用 Heroku 的日志文件排错。</p>

<div class="figure" id="figure-7-22">
  <img src="figures/signup_in_production_bootstrap.png" alt="signup in production bootstrap" /><p class="caption"><span>图 7.22：</span>线上正常运作的注册页面</p>
</div>
<h2 id='section-7-5'><span>7.5</span> 小结</h2>


<p>实现注册功能对示例程序来说算是取得了很大的进展。虽然现在还没实现真正有用的功能，不过我们却为后续功能的开发奠定了坚实的基础。<a href="chapter8.html">第 8 章</a>，我们会实现用户登录、退出功能，完成整个身份验证机制。<a href="chapter9.html">第 8 章</a>，我们会实现更新用户个人信息的功能。我们还会实现管理员删除用户的功能，这样才算是完整的实现了<a href="chapter7.html#table-7-1">表格 7.1</a> 中所列 Users 资源相关的 REST 动作。最后，我们还会在各动作中实现权限验证功能，提升网站的安全。</p>

<h2 id='section-7-6'><span>7.6</span> 练习</h2>


<ol><li>
    <p>以代码 7.30 为蓝本，验证一下在 <a href="chapter7.html#section-7-1-4">7.1.4 节</a>中定义的 <code>gravatar_for</code> 帮助方法是否可以接受名为 <code>size</code> 的可选参数，允许在视图中使用类似 <code>gravatar_for user, size: 40</code> 这样的形式。</p>
  </li>
  <li>
    <p>编写测试检测代码 7.23 中实现的错误提示信息。可以参照代码 7.31。</p>
  </li>
  <li>
    <p>采取先编写测试的方式，或者等到程序出错后再补救，验证一下代码 7.32 中的测试可以确保 <code>create</code> 动作中保存用户之后顺利的转到了用户资料页面。代码 7.32 中用到了 Capybara 提供的 <code>have_selector</code> 方法，这个方法可以测试 HTML 标签（通过 CSS class 指定）是否出现在页面中。</p>
  </li>
  <li>
    <p>我们前面说过，代码 7.27 中 Flash 消息相关的代码有点乱，我们要换用代码 7.33 中的代码，运行测试看一下使用 <code>content_tag</code> 帮助方法之后效果是否一样。</p>
  </li>
</ol><div class="codeblock has-caption" id="codeblock-7-30"><p class="caption"><span>代码 7.30：</span>重新定义 <code>gravatar_for</code> 方法，允许接受可选的 <code>size</code> 参数</p><p class="file"><code>app/helpers/users_helper.rb</code></p><div class="highlight type-ruby"><pre><span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="c1"># Returns the Gravatar (http://gravatar.com/) for the given user.</span>
  <span class="k">def</span> <span class="nf">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span> <span class="p">})</span>
    <span class="n">gravatar_id</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:size</span><span class="o">]</span>
    <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">"https://secure.gravatar.com/avatar/</span><span class="si">#{</span><span class="n">gravatar_id</span><span class="si">}</span><span class="s2">.png?s=</span><span class="si">#{</span><span class="n">size</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">,</span> <span class="ss">alt</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"gravatar"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="codeblock has-caption" id="codeblock-7-31"><p class="caption"><span>代码 7.31：</span>错误提示信息测试的参考</p><p class="file"><code>spec/requests/user_pages_spec.rb</code></p><div class="highlight type-ruby"><pre>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"signup page"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"with invalid information"</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">"after submission"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Sign up'</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'error'</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
</pre></div>
</div>
<div class="codeblock has-caption" id="codeblock-7-32"><p class="caption"><span>代码 7.32：</span>对 <code>create</code> 动作中保存用户操作的测试</p><p class="file"><code>spec/requests/user_pages_spec.rb</code></p><div class="highlight type-ruby"><pre>    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">"after saving the user"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s1">'user@example.com'</span><span class="p">)</span> <span class="p">}</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-success'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'Welcome'</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
</pre></div>
</div>
<div class="codeblock has-caption" id="codeblock-7-33"><p class="caption"><span>代码 7.33：</span>使用 <code>content_for</code> 编写的 Flash 消息视图代码</p><p class="file"><code>app/views/layouts/application.html.erb</code></p><div class="highlight type-erb"><pre><span class="x">&lt;!DOCTYPE html&gt;</span>
<span class="x">  &lt;html&gt;</span>
<span class="x">  .</span>
<span class="x">  .</span>
<span class="x">  .</span>
<span class="x">  </span><span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">content_tag</span><span class="p">(</span><span class="ss">:div</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"alert alert-</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  .</span>
<span class="x">  .</span>
<span class="x">  .</span>
<span class="x">&lt;/html&gt;</span>
</pre></div>
</div>
<div class="footnotes">
  <ol><li id="fn-7-1">
      <p><a href="http://gomockingbird.com/">Mockingbird</a> 不支持插入额外的图片，图 7.1 中的图片是我使用 <a href="http://www.adobe.com/products/fireworks/">Adobe Fireworks</a> 加上的。<a href="#fnref-7-1" rel="reference">↩</a></p>
    </li>
    <li id="fn-7-2">
      <p>图中的河马原图在此 <a href="http://www.flickr.com/photos/43803060@N00/24308857/">http://www.flickr.com/photos/43803060@N00/24308857/</a><a href="#fnref-7-2" rel="reference">↩</a></p>
    </li>
    <li id="fn-7-3">
      <p>Rails 的调试信息是 <a href="http://www.yaml.org/">YAML</a>（YAML Ain’t Markup Language）格式的，这种格式对机器和人类都很友好。<a href="#fnref-7-3" rel="reference">↩</a></p>
    </li>
    <li id="fn-7-4">
      <p>你还可以自己定义其他的环境，详细方法可以参照 Railscasts 的《<a href="http://railscasts.com/episodes/72-adding-an-environment">Adding an Environment</a>》。<a href="#fnref-7-4" rel="reference">↩</a></p>
    </li>
    <li id="fn-7-5">
      <p>这句话的意思是，路由已经设置好了，但相应的页面还无法正常访问。例如，/users/1/edit 已经映射到 Users 控制器的 <code>edit</code> 动作上了，但是 <code>edit</code> 动作还不存在，所以访问这个地址就会显示一个错误页面。<a href="#fnref-7-5" rel="reference">↩</a></p>
    </li>
    <li id="fn-7-6">
      <p>在印度教中，avatar 是神的化身，可以是一个人，也可以是一种动物。由此引申到其他领域，特别是在虚拟世界中，avatar 就代表一个人。你可能看过《<a href="http://movie.douban.com/subject/1652587/">阿凡达</a>》这部电影了，所以你可能也已经知道 avatar 的意思了。<a href="#fnref-7-6" rel="reference">↩</a></p>
    </li>
    <li id="fn-7-7">
      <p>如果你的应用程序需要处理图片及其他文件的上传，我推荐你使用 <a href="https://github.com/thoughtbot/paperclip">Paperclip</a> 或 <a href="https://github.com/jnicklas/carrierwave">CarrierWave</a>。<a href="#fnref-7-7" rel="reference">↩</a></p>
    </li>
    <li id="fn-7-8">
      <p>有点搞不懂是吧，其实我也不知道原因。<a href="#fnref-7-8" rel="reference">↩</a></p>
    </li>
    <li id="fn-7-9">
      <p>我之所以知道要引入 <code>ActionView::Helpers::TextHelper</code> 模块，是因为我在 <a href="http://api.rubyonrails.org/v4.0.0/classes/ActionView/Helpers/TextH elper.html#method-i-pluralize">Rails API</a> 中查了 <code>pluralize</code> 的文档。<a href="#fnref-7-9" rel="reference">↩</a></p>
    </li>
    <li id="fn-7-10">
      <p>其实我们真正想用的是 <code>flash.now</code>，<code>flash</code> 和 <code>flash.now</code> 之间还是有细微差别的，后续会介绍。<a href="#fnref-7-10" rel="reference">↩</a></p>
    </li>
    <li id="fn-7-11">
      <p>严格来说，SSL 现在的称呼是 TLS（Transport Layer Security，安全传输层协议），不过人们已经习惯了 SSL 这个名字。<a href="#fnref-7-11" rel="reference">↩</a></p>
    </li>
  </ol></div>
  	</div>
</div>

			
				
				<div class="navigation">
					
						<a class="prev_page" href="/chapter6.html">&laquo; 第 6 章用户模型</a>
					
					
						<a class="next_page" href="/chapter8.html">第 8 章登录和退出 &raquo;</a>
					
				</div>
				
			
		</div>
		<div class="footer">
        	<p>&copy;2013 <a href="http://about.ac" title="Andor Chen 的个人网站">Andor Chen</a> 保留部分权力。在线阅读版本基于<a href="http://creativecommons.org/licenses/by-sa/3.0/" title="Creative Commons Attribution-ShareAlike 3.0 Unported License" target="_blank">“CC 3.0 BY-SA 协议”</a>发布</p>
		</div>
	</div>
</body>
</html>
