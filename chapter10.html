<!doctype html>
<html lang="zh_CN">
<head>
	<meta charset="utf-8" />
	<title>第 10 章 用户的微博</title>
    <meta name="author" content="Andor Chen" />
    <link rel="stylesheet" href="assets/styles/style.css" />
    <script type="text/javascript" src="http://cdn.staticfile.org/jquery/1.8.2/jquery.min.js"></script>
    <script type="text/javascript" src="assets/js/global.js"></script>
</head>

<body>
	<div class="wrapper">
		<div class="header">
            <h1 class="logo"><a class="ir" href="http://railstutorial-china.org/rails4">Ruby on Rails 教程</a></h1>
            <p class="subtitle">Ruby on Rails Tutorial 原书第 2 版（涵盖 Rails 4）</p>
        </div>
        <div class="content">
			
<div class="item chapter">
	<h1 id="chapter-10"><span>第 10 章</span> 用户的微博</h1>
	<ol class="toc">          <li class="level-2">
            <a href="#section-10-1">10.1 Microposts 模型</a>
          </li>
          <li class="level-3">
            <a href="#section-10-1-1">10.1.1 基本模型</a>
          </li>
          <li class="level-3">
            <a href="#section-10-1-2">10.1.2 第一个数据验证</a>
          </li>
          <li class="level-3">
            <a href="#section-10-1-3">10.1.3 用户和微博之间的关联</a>
          </li>
          <li class="level-3">
            <a href="#section-10-1-4">10.1.4 改进 Micropost 模型</a>
          </li>
          <li class="level-3">
            <a href="#section-10-1-5">10.1.5 验证微博内容</a>
          </li>
          <li class="level-2">
            <a href="#section-10-2">10.2 显示微博</a>
          </li>
          <li class="level-3">
            <a href="#section-10-2-1">10.2.1 充实用户资料页面</a>
          </li>
          <li class="level-3">
            <a href="#section-10-2-2">10.2.2 示例微博</a>
          </li>
          <li class="level-2">
            <a href="#section-10-3">10.3 微博相关的操作</a>
          </li>
          <li class="level-3">
            <a href="#section-10-3-1">10.3.1 访问限制</a>
          </li>
          <li class="level-3">
            <a href="#section-10-3-2">10.3.2 创建微博</a>
          </li>
          <li class="level-3">
            <a href="#section-10-3-3">10.3.3 临时的动态列表</a>
          </li>
          <li class="level-3">
            <a href="#section-10-3-4">10.3.4 删除微博</a>
          </li>
          <li class="level-2">
            <a href="#section-10-4">10.4 小结</a>
          </li>
          <li class="level-2">
            <a href="#section-10-5">10.5 练习</a>
          </li>
</ol>
  	<div class="main">
  		<p>我们在<a href="chapter9.html">第 9 章</a>中已经实现了一个完整且符合 REST 架构的资源：用户，本章我们要再实现一个资源：用户微博（micropost）。<sup class="footnote" id="fnref-10-1"><a href="#fn-10-1" rel="footnote">1</a></sup>微博是由用户发布的一种简短消息，我们在<a href="chapter2.html">第 2 章</a>中实现了微博的雏形。 本章我们会在 <a href="chapter2.html#section-2-3">2.3 节</a>的基础上，实现一个功能完善的 Microposts 资源。首先，我们要创建微博所需的数据模型，通过  <code>has_many</code> 和 <code>belongs_to</code> 方法把微博和用户关联起来，再建立处理和显示微博所需的表单及局部视图。在 <a href="chapter11.html">第 11 章</a>，还要加入关注其他用户的功能，其时，我们这个山寨版 Twitter 才算完成。</p>

<p>如果你使用 Git 做版本控制的话，和之前一样，我建议你新建一个分支：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>git checkout -b user-microposts
</pre></div>
</div>
<h2 id='section-10-1'><span>10.1</span> Microposts 模型</h2>


<p>实现 Microposts 资源的第一步是创建微博所需的数据模型，在模型中设定微博的基本属性。和 <a href="chapter2.html#section-2-3">2.3 节</a> 创建的模型类似，我们要实现的 Micropost 模型要包含数据验证，以及和 User 模型的关联。除此之外，我们还会做充分的测试，指定默认的排序方式，自动删除已注销用户的微博。</p>

<h3 id='section-10-1-1'><span>10.1.1</span> 基本模型</h3>


<p>Micropost 模型只需要两个属性：一个是 <code>content</code>，用来保存微博的内容；<sup class="footnote" id="fnref-10-2"><a href="#fn-10-2" rel="footnote">2</a></sup>另一个是 <code>user_id</code>，把微博和用户关联起来。我们要使用 <code>generate model</code> 命令生成所需的模型，这一点和创建用户模型时是一样的（参见代码 6.1）：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>rails generate model Micropost content:string user_id:integer
</pre></div>
</div>
<p>这个命令有可能会生成一个微博预构件，你应该把它删掉，因为后面我们会自己编写所需的预构件（参见<a href="chapter10.html#section-10-1-4">10.1.4 节</a>）：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>rm -f spec/factories/microposts.rb
</pre></div>
</div>
<p>上述命令会生成一个迁移文件，在数据库中生成一个名为 <code>microposts</code> 的表（参见代码 10.1）。读者朋友可以和生成 <code>users</code> 表的迁移文件对照一下（参见代码 6.2）。</p>

<div class="codeblock has-caption" id="codeblock-10-1"><p class="caption"><span>代码 10.1：</span>创建微博模型的迁移文件（注意：为 <code>user_id</code> 和 <code>created_at</code> 列加入了索引）</p><p class="file"><code>db/migrate/[timestamp]_create_microposts.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">CreateMicroposts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="p">:</span><span class="n">microposts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:content</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:user_id</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
    <span class="n">add_index</span> <span class="p">:</span><span class="n">microposts</span><span class="p">,</span> <span class="p">[</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>注意，因为我们设想要按照发布时间的倒序查询某个用户所有的微博，所以在上述代码中为 <code>user_id</code> 和 <code>created_at</code> 列加入了索引：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">add_index</span> <span class="p">:</span><span class="n">microposts</span><span class="p">,</span> <span class="p">[</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="p">]</span>
</pre></div>
</div>
<p>我们把 <code>user_id</code> 和 <code>created_at</code> 放在一个数组中，告诉 Rails 我们要创建的是“多键索引（multiple key index）”，Active Record 便会同时使用这两个键。还要注意 <code>t.timestamps</code> 这行，我们在 <a href="chapter6.html#section-6-1-1">6.1.1 节</a>中介绍过，它会自动创建 <code>created_at</code> 和 <code>updated_at</code> 两个属性。在 <a href="chapter10.html#section-10-1-4">10.1.4 节</a> 和 <a href="chapter10.html#section-10-2-1">10.2.1 节</a> 中才会用到 <code>created_at</code>。</p>

<p>我们先参照 User 模型的测试（参照代码 6.5），为 Micropost 模型编写一些基本的测试。我们要测试微博对象是否可以响应 <code>content</code> 和 <code>user_id</code> 方法，如代码 10.2 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-2"><p class="caption"><span>代码 10.2：</span>Micropost 模型测试（初始版）</p><p class="file"><code>spec/models/micropost_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="c1"># This code is not idiomatically correct.</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">content: </span><span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>
<p>若要这个测试通过，我们先要执行数据库迁移，再准备好“测试数据库”：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div>
</div>
<p>执行上面两个命令之后，会生成 Micropost 模型，结构如图 10.1 所示。</p>

<div class="figure" id="figure-10-1">
  <img src="figures/micropost_model.png" alt="micropost_model" />
  <p class="caption"><span>图 10.1：</span>Micropost 数据模型</p>
</div>
<p>然后确认测试是否可以通过：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/models/micropost_spec.rb
</pre></div>
</div>
<p>测试虽然可以通过，不过你可能注意到代码 10.2 中的这几行代码了：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="k">do</span>
  <span class="c1"># This code is not idiomatically correct.</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">content: </span><span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>就像其中的注释所说，<code>before</code> 块中的代码并不完全正确。你可以想一下为什么，我们会在 <a href="chapter10.html#section-10-1-3">10.1.3 节</a>中告诉你答案。</p>

<h3 id='section-10-1-2'><span>10.1.2</span> 第一个数据验证</h3>


<p>Micropost 模型必须要有一个属性表明用户的 ID，这样才能知道是哪个用户发布的微博。要加入这个属性，最好的方法是使用 Active Record 关联，会在 <a href="chapter10.html#section-10-1-3">10.1.3 节</a>实现。实现的过程需要一点重构，本节我们就编写一个测试捕获可能出现的错误。</p>

<p>测试如代码 10.3 所示，我们先把用户 ID 设为 <code>nil</code>，然后检测对应的微博是否不合法。（可以和代码 6.8 中针对 User 模型的测试对比一下。）</p>

<div class="codeblock has-caption" id="codeblock-10-3"><p class="caption"><span>代码 10.3：</span>测试微博能否通过验证</p><p class="file"><code>spec/models/micropost_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="c1"># This code is not idiomatically correct.</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">content: </span><span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"when user_id is not present"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="p">.</span><span class="nf">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>这段代码测试了微博是否能够通过验证，以及是否指定了 <code>user_id</code> 的值。要想让上述测试通过，我们要按照代码 10.4 所示，加入一个简单的存在性验证。</p>

<div class="codeblock has-caption" id="codeblock-10-4"><p class="caption"><span>代码 10.4：</span>对微博 <code>user_id</code> 属性的验证</p><p class="file"><code>app/models/micropost.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="p">:</span><span class="n">user_id</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div>
<h3 id='section-10-1-3'><span>10.1.3</span> 用户和微博之间的关联</h3>


<p>在为 Web 程序构建数据模型时，最基本的考虑要素是要能够在不同的模型之间建立关联。在我们这个程序中，每篇微博都关联着一个用户，而每个用户一般都会关联多篇微博。用户和微博之间的关系在 <a href="chapter2.html#section-2-3-3">2.3.3 节</a>中简单的介绍过，二者之间的关系如图 10.2 和图 10.3 所示。在实现这种关联的时候，我们会编写针对 Micropost 模型的测试，还会编写针对 User 模型的测试。</p>

<div class="figure" id="figure-10-2">
  <img src="figures/micropost_belongs_to_user.png" alt="micropost_belongs_to_user" />
  <p class="caption"><span>图 10.2：</span>微博和用户之间的“属于（<code>belongs_to</code>）”关系</p>
</div>
<div class="figure" id="figure-10-3">
  <img src="figures/user_has_many_microposts.png" alt="user_has_many_microposts" />
  <p class="caption"><span>图 10.3：</span>用户和微博之间的“拥有多个（<code>has_many</code>）”关系</p>
</div>
<p>使用本小节介绍的 <code>belongs_to</code> 和 <code>has_many</code> 之后，Rails 会自动创建如<a href="chapter10.html#table-10-1">表格 10.1</a> 所示的方法。</p>

<div class="table has-caption" id="table-10-1"><p class="caption"><span>表格 10.1：</span>用户和微博关联后所得方法的简介</p><table>
  <thead>
    <tr>
      <th>方法</th>
      <th>作用</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>micropost.user</code></td>
      <td>返回该微博对应的用户对象</td>
    </tr>
    <tr>
      <td><code>user.microposts</code></td>
      <td>返回该用户的所有微博数组</td>
    </tr>
    <tr>
      <td><code>user.microposts.create(arg)</code></td>
      <td>创建一篇微博（<code>user_id = user.id</code>）</td>
    </tr>
    <tr>
      <td><code>user.microposts.create!(arg)</code></td>
      <td>创建一篇微博（失败时抛出异常）</td>
    </tr>
    <tr>
      <td><code>user.microposts.build(arg)</code></td>
      <td>生成一个新的微博对象（user_id = user.id）</td>
    </tr>
  </tbody>
</table>
</div>
<p>注意，从表格 10.1 可知，相较于以下的方法</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="no">Micropost</span><span class="p">.</span><span class="nf">create</span>
<span class="no">Micropost</span><span class="p">.</span><span class="nf">create!</span>
<span class="no">Micropost</span><span class="p">.</span><span class="nf">new</span>
</pre></div>
</div>
<p>我们得到了</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">create</span>
<span class="n">user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">create!</span>
<span class="n">user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">build</span>
</pre></div>
</div>
<p>后者才是创建微博的正确方式，即通过相关联的用户对象创建。通过这种方式创建的微博，其 <code>user_id</code> 属性会自动设为正确的值。所以，我们可以把代码 10.3 中的下述代码</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="k">do</span>
  <span class="c1"># This code is not idiomatically correct.</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">content: </span><span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>修改为</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">content: </span><span class="s2">"Lorem ipsum"</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
<p>只要正确定义了用户和微博之间的关联关系，<code>@micropost</code> 变量的 <code>user_id</code> 属性就会自动设为相对应用户的 id。</p>

<p>如<a href="chapter10.html#table-10-1">表格 10.1</a> 所示，用户和微博建立关联之后，还会生成 <code>micropost.user</code> 方法，返回该微博的用户对象。对此，我们可以使用 <code>it</code> 和 <code>its</code> 做个测试：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">its</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">eq</span> <span class="n">user</span> <span class="p">}</span>
</pre></div>
</div>
<p>以上对 Micropost 模型的测试结合在一起后如代码 10.5 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-5"><p class="caption"><span>代码 10.5：</span>测试微博和用户之间的关联</p><p class="file"><code>spec/models/micropost_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">content: </span><span class="s2">"Lorem ipsum"</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">its</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">eq</span> <span class="n">user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"when user_id is not present"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="p">.</span><span class="nf">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>在用户和微博关联关系的 User 模型一边，我们会在 <a href="chapter10.html#section-10-1-4">10.1.4 节</a>做详细的测试，现在我们只是简单的测试下是否可以响应 <code>microposts</code> 方法，如代码 10.6 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-6"><p class="caption"><span>代码 10.6：</span>测试用户对象是否可以响应 <code>microposts</code> 方法</p><p class="file"><code>spec/models/user_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"user@example.com"</span><span class="p">,</span>
                     <span class="ss">password: </span><span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation: </span><span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:microposts</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>写好了上面的测试，实现用户和微博之间关联就简单了：只需分别加入下面这两行代码，代码 10.5 和代码 10.6 中的测试就可以通过了：<code>belongs_to :user</code>（如代码 10.7 所示）和 <code>has_many :microposts</code>（如代码 10.8 所示）。</p>

<div class="codeblock has-caption" id="codeblock-10-7"><p class="caption"><span>代码 10.7：</span>微博“属于（<code>belongs_to</code>）”用户</p><p class="file"><code>app/models/micropost.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="p">:</span><span class="n">user</span>
  <span class="n">validates</span> <span class="p">:</span><span class="n">user_id</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="codeblock has-caption" id="codeblock-10-8"><p class="caption"><span>代码 10.8：</span>用户“拥有多篇（<code>has_many</code>）”微博</p><p class="file"><code>app/models/user.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="p">:</span><span class="n">microposts</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>现在，你应该结合<a href="chapter10.html#table-10-1">表格 10.1</a>和代码 10.5、代码 10.6，确保你理解了关联的基本知识点。你还应该检查一下测试是否可以通过：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/models
</pre></div>
</div>
<h3 id='section-10-1-4'><span>10.1.4</span> 改进 Micropost 模型</h3>


<p>代码 10.6 中的代码并没有深入测试通过 <code>has_many</code> 实现的关联，仅仅检测了是否可以响应 <code>microposts</code> 方法。本小节，我们会为 Micropost 模型加入排序方法和依属关系，还会测试 <code>user.microposts</code> 方法的返回结果是否为数组。</p>

<p>我们需要在 User 模型的测试中生成一些微博，所以现在我们先要创建一个生成微博的预构件。在所创建的预构件中我们要找到一种方法把微博和用户关联起来，幸运的是，在 FactoryGirl 中实现关联是很容易的，如代码 10.9 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-9"><p class="caption"><span>代码 10.9：</span>完整的预构件文件，包含了创建微博的新预构件</p><p class="file"><code>spec/factories.rb</code></p><div class="highlight type-ruby"><pre><span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="p">:</span><span class="n">user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com"</span><span class="p">}</span>
    <span class="n">password</span> <span class="s2">"foobar"</span>
    <span class="n">password_confirmation</span> <span class="s2">"foobar"</span>

    <span class="n">factory</span> <span class="p">:</span><span class="n">admin</span> <span class="k">do</span>
      <span class="n">admin</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">factory</span> <span class="p">:</span><span class="n">micropost</span> <span class="k">do</span>
    <span class="n">content</span> <span class="s2">"Lorem ipsum"</span>
    <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>在 FactoryGirl 中我们只需要在创建微博的预构件中包含一个用户对象就可以实现所需的关联了：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">factory</span> <span class="p">:</span><span class="n">micropost</span> <span class="k">do</span>
  <span class="n">content</span> <span class="s2">"Lorem ipsum"</span>
  <span class="n">user</span>
<span class="k">end</span>
</pre></div>
</div>
<p>在下一节中会介绍，我们可以使用下面的方法生成一篇微博：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user: </span><span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">day</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
</pre></div>
</div>
<h4 id='section-10-1-4-1'><span></span>默认作用域</h4>


<p>默认情况下，使用 <code>user.microposts</code> 从数据库中读取用户的微博不能保证微博的次序，但是按照博客和 Twitter 的习惯，我们希望微博按照创建时间倒序排列，也就是最新创建的微博在最前面。要测试微博的次序，我们要先创建两篇微博：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user: </span><span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">day</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
<span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user: </span><span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">hour</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
</pre></div>
</div>
<p>我们把第二篇微博的创建时间设的晚一些，即 <code>1.hour.ago</code>（利用了<a href="chapter8.html#aside-8-1">旁注 8.1</a>中介绍的帮助函数），第一篇微博的创建时间要早一些，是 <code>1.day.ago</code>。请注意一下使用 FactoryGirl 创建微博是多么方便：我们不仅可以直接指定微博所属的用户（FactoryGirl 会逃过 <code>attr_accessible</code> 限制），还可以设定通常情况下不能自由设定的 <code>created_at</code> 属性（因为在 Active Record 做了限制）。（再次说明一下，<code>created_at</code> 和 <code>updated_at</code> 两个属性是“魔法”列，会被自动设为相应的创建时间戳和更新时间戳，即使手动指定了值也会被覆盖。）</p>

<p>大多数数据库适配器（包括 SQLite 的适配器）读取的微博都是按照 ID 来排序的，因此代码 10.10 中的测试肯定不会通过。在这段测试代码中没有使用 <code>let</code>，而用了 <code>let!</code>（读作“let bang”），因为 <code>let</code> 方法指定的变量是“惰性”的，只有当后续有引用时才会被创建。而我们希望这两个微博变量立即被创建，这样才能保证两篇微博时间戳的顺序是正确的，也保证了 <code>@user.microposts</code> 数组不是空的。所以我们才用了 <code>let!</code> 方法，强制相应的变量立即被创建。</p>

<div class="codeblock has-caption" id="codeblock-10-10"><p class="caption"><span>代码 10.10：</span>测试用户微博的次序</p><p class="file"><code>spec/models/user_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">describe</span> <span class="s2">"micropost associations"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user: </span><span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">day</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user: </span><span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">hour</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the right microposts in the right order"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">to_a</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="p">[</span><span class="n">newer_micropost</span><span class="p">,</span> <span class="n">older_micropost</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>这个测试中最关键的一行是：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">to_a</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="p">[</span><span class="n">newer_micropost</span><span class="p">,</span> <span class="n">older_micropost</span><span class="p">]</span>
</pre></div>
</div>
<p>这行代码表明所创建的微博应该按照创建时间倒序排列，即最新创建的微博排在最前面。这个测试注定是无法通过的，因为微博默认是按照 ID 排序的，即 <code>[older_micropost, newer_micropost]</code>。这个测试同时也验证了 <code>has_many</code> 关联最基本的效果是否正确，即检测 <code>user.microposts</code> 返回的结果是否是数组。其中用到的 <code>to_a</code> 方法，在 <a href="chapter4.html#section-4-3-1">4.3.1 节</a>中介绍过，会把 <code>@user.microposts</code> 从初始状态（Active Record 的“集合代理（collection proxy）”）转换成一个数组，以便和我们手动编写的数组比较。</p>

<p>要让这个测试通过，我们要使用 Rails 中的 <code>default_scope</code> 方法，还要设定它的 <code>:order</code> 参数，如代码 10.11 所示。（这是我们第一次接触作用域的概念，在<a href="chapter11.html">第 11 章</a>中会介绍作用域更一般的用法。）</p>

<div class="codeblock has-caption" id="codeblock-10-11"><p class="caption"><span>代码 10.11：</span>通过 <code>default_scope</code> 设定微博的排序</p><p class="file"><code>app/models/micropost.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="p">:</span><span class="n">user</span>
  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">'created_at DESC'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="p">:</span><span class="n">user_id</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div>
<p>我们通过 <code>microposts.created_at DESC</code> 设定了所需的排序，其中 <code>DESC</code> 在 SQL 中是“倒序”的意思，即按照由新到旧这种顺序排序。</p>

<p>从 Rails 4.0 开始，所有的作用域都需要通过匿名函数的方式定义，函数的返回值为所需的条件。这么做主要的好处是，作用域的条件不用立即计算，只在需要时才执行（所以叫做“惰性计算”）。本例所用的匿名函数是</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">'created_at DESC'</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
<p>这种对象叫 Proc 或 lambda，以 <code>-&gt;</code> 开头，后面跟着一个代码块，调用 <code>call</code> 方法时才执行块中的代码。我们可以在控制台中看一下：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">&gt;&gt; </span>-&gt; <span class="o">{</span> puts <span class="s2">"foo"</span> <span class="o">}</span>
<span class="gp">=&gt; </span><span class="c">#&lt;Proc:0x007fab938d0108@(irb):1 (lambda)&gt;</span>
<span class="gp">&gt;&gt; </span>-&gt; <span class="o">{</span> puts <span class="s2">"foo"</span> <span class="o">}</span>.call
foo
<span class="gp">=&gt; </span>nil
</pre></div>
</div>
<p>（Proc 属于 Ruby 语言的高级功能，所以如果没有立刻理解也不用担心。）</p>

<h4 id='section-10-1-4-2'><span></span>依属关系：destroy</h4>


<p>除了设定恰当的排序外，我们还要对微博模型做另一项改进。我们在 <a href="chapter9.html#section-9-4">9.4 节</a>中介绍过，管理员是有权限删除用户的。那么，在删除用户的同时，就有必要把该用户发布的微博也删除。对此我们可以编写一个测试，检测当用户被删除后，其发布的微博是否还在数据库中。</p>

<p>为了能够正确的测试微博是否被删除了，我们先要把用户的一篇微博赋值给一个局部变量，然后再删除这个用户。对此，一种比较直观的实现方式如下所示：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">to_a</span>
<span class="vi">@user</span><span class="p">.</span><span class="nf">destroy</span>
<span class="n">expect</span><span class="p">(</span><span class="n">microposts</span><span class="p">).</span><span class="nf">not_to</span> <span class="n">be_empty</span>
<span class="n">microposts</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
  <span class="c1"># Make sure the micropost doesn't appear in the database.</span>
<span class="k">end</span>
</pre></div>
</div>
<p>我们调用了 <code>to_a</code> 方法，高效地复制了一份微薄列表。我们还加入了下面这行</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">expect</span><span class="p">(</span><span class="n">microposts</span><span class="p">).</span><span class="nf">not_to</span> <span class="n">be_empty</span>
</pre></div>
</div>
<p>这是一份双保险，避免不小心漏掉了 <code>to_a</code>。如果没有 <code>to_a</code> 的话，一旦删除了用户就会删掉 <code>microposts</code> 变量中的该用户的微博，那么</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">microposts</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
  <span class="c1"># Make sure the micropost doesn't appear in the database.</span>
<span class="k">end</span>
</pre></div>
</div>
<p>就什么也测试不了，因为 <code>microposts</code> 是空的。</p>

<p>我们可以通过下面的代码确认微博不在数据库中：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">microposts</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
  <span class="n">expect</span><span class="p">(</span><span class="no">Micropost</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">id: </span><span class="n">micropost</span><span class="p">.</span><span class="nf">id</span><span class="p">)).</span><span class="nf">to</span> <span class="n">be_empty</span>
<span class="k">end</span>
</pre></div>
</div>
<p>这里我们用的是 <code>Micropost.where</code>，而不是 <code>Micropost.find</code>，因为如果没有查询到记录 <code>where</code> 会返回一个空值对象，而 <code>find</code> 会抛出异常。测试空值对象要更容易。如果你好奇想知道如何测试异常，可以使用下面的代码：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">expect</span> <span class="k">do</span>
  <span class="no">Micropost</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">micropost</span><span class="p">)</span>
<span class="k">end</span><span class="p">.</span><span class="nf">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span><span class="p">)</span>
</pre></div>
</div>
<p>完整的测试代码如代码 10.12 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-12"><p class="caption"><span>代码 10.12：</span>测试用户删除后，所发布的微博是否也被删除了</p><p class="file"><code>spec/models/user_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">describe</span> <span class="s2">"micropost associations"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user: </span><span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">day</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user: </span><span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">hour</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="p">.</span>
    <span class="nf">.</span>
    <span class="p">.</span>
    <span class="nf">it</span> <span class="s2">"should destroy associated microposts"</span> <span class="k">do</span>
      <span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">to_a</span>
      <span class="vi">@user</span><span class="p">.</span><span class="nf">destroy</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">microposts</span><span class="p">).</span><span class="nf">not_to</span> <span class="n">be_empty</span>
      <span class="n">microposts</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
        <span class="n">expect</span><span class="p">(</span><span class="no">Micropost</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">id: </span><span class="n">micropost</span><span class="p">.</span><span class="nf">id</span><span class="p">)).</span><span class="nf">to</span> <span class="n">be_empty</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>要让代码 10.12 中的测试通过，我们甚至不需要加入一行完整的代码，只需在 <code>has_many</code> 方法中设定一个参数即可，如代码 10.13 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-13"><p class="caption"><span>代码 10.13：</span>保证用户的微博在删除用户的同时也会被删除</p><p class="file"><code>app/models/user.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="p">:</span><span class="n">microposts</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>上面代码中有这么一行：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">has_many</span> <span class="p">:</span><span class="n">microposts</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
</pre></div>
</div>
<p>其中的 <code>dependent: :destroy</code> 设定程序在用户被删除的时候，其所属的微博也要被删除。这么一来，如果管理员删除了用户，数据库中就不会出现无主的微博了。</p>

<p>至此，用户和微博之间的关联就设置好了，所有的测试应该都可以通过了：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<h3 id='section-10-1-5'><span>10.1.5</span> 验证微博内容</h3>


<p>在结束讨论 Micropost 模型之前，我们还要为微博的内容加上数据验证（参照 <a href="chapter2.html#section-2-3-2">2.3.2 节</a>）。和 <code>user_id</code> 一样，<code>content</code> 属性不能为空，而且还要限制内容的长度不能多于 140 个字符，这才是真正的“微”博。我们要编写的测试和 <a href="chapter6.html#section-6-2">6.2 节</a>中对用户模型的验证测试类似，如代码 10.14 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-14"><p class="caption"><span>代码 10.14：</span>测试 Micropost 模型的数据验证</p><p class="file"><code>spec/models/micropost_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">content: </span><span class="s2">"Lorem ipsum"</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">describe</span> <span class="s2">"when user_id is not present"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="p">.</span><span class="nf">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"with blank content"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="p">.</span><span class="nf">content</span> <span class="o">=</span> <span class="s2">" "</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"with content that is too long"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="p">.</span><span class="nf">content</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">141</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>和 <a href="chapter6.html#section-6-2">6.2 节</a>一样，在代码 10.14 中我们用到了字符串乘积来测试微博内容长度的验证：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>rails console
<span class="gp">&gt;&gt; </span><span class="s2">"a"</span> <span class="k">*</span> 10
<span class="gp">=&gt; </span><span class="s2">"aaaaaaaaaa"</span>
<span class="gp">&gt;&gt; </span><span class="s2">"a"</span> <span class="k">*</span> 141
<span class="gp">=&gt; </span><span class="s2">"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"</span>
</pre></div>
</div>
<p>我们需要在程序中加入下面这行代码：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">validates</span> <span class="p">:</span><span class="n">content</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span> <span class="ss">maximum: </span><span class="mi">140</span> <span class="p">}</span>
</pre></div>
</div>
<p>Micropost 模型的最终代码如代码 10.15 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-15"><p class="caption"><span>代码 10.15：</span>Micropost 模型的数据验证</p><p class="file"><code>app/models/micropost.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="p">:</span><span class="n">user</span>
  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">'created_at DESC'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="p">:</span><span class="n">content</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span> <span class="ss">maximum: </span><span class="mi">140</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="p">:</span><span class="n">user_id</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div>
<h2 id='section-10-2'><span>10.2</span> 显示微博</h2>


<p>尽管我们还没实现直接在网页中发布微博的功能（将在 <a href="chapter10.html#section-10-3-2">10.3.2 节</a>实现），不过我们还是有办法显示微博，并对显示的内容进行测试。我们将按照 Twitter 的方式，用户的微博不在 <code>index</code> 页面中显示，而在 <code>show</code> 页面中，构思图如图 10.4 所示。我们会先创建一些很简单的 ERb 代码，在用户的资料页面显示微博，然后要在 <a href="chapter9.html#section-9-3-2">9.3.2 节</a>中实现的数据生成器中加入生成微博的代码，这样我们才有内容可以显示。</p>

<p>和 <a href="chapter8.html#section-8-2-1">8.2.1 节</a>中对登录机制的介绍类似，<a href="chapter10.html#section-10-2-1">10.2.1 节</a>也会经常将一些元素推送到<a href="http://en.wikipedia.org/wiki/Stack\_\(data_structure\)">堆栈</a>里，然后再一个一个的从栈尾取出来。如果理解起来有点困难，多点耐心，你的付出会在 <a href="chapter10.html#section-10-2-2">10.2.2 节</a>得到回报。</p>

<h3 id='section-10-2-1'><span>10.2.1</span> 充实用户资料页面</h3>


<p>我们先在用户的 request spec 中加入对显示微博的测试。我们采用的方法是，先通过预构件创建几篇微博，然后检查用户资料页面是否显示了这几篇微博，同时我们还要验证是否显示了如图 10.4 中所示的总的微博数量。</p>

<p>我们可以使用 <code>let</code> 方法创建微博，不过如代码 10.10 所示，我们希望用户和微博的关联立即生效，这样微博才能显示在用户的资料页面中。所以，我们要使用 <code>let!</code> 方法：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">let!</span><span class="p">(</span><span class="ss">:m1</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user: </span><span class="n">user</span><span class="p">,</span> <span class="ss">content: </span><span class="s2">"Foo"</span><span class="p">)</span> <span class="p">}</span>
<span class="n">let!</span><span class="p">(</span><span class="ss">:m2</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user: </span><span class="n">user</span><span class="p">,</span> <span class="ss">content: </span><span class="s2">"Bar"</span><span class="p">)</span> <span class="p">}</span>

<span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
<div class="figure" id="figure-10-4">
  <img src="figures/user_microposts_mockup_bootstrap.png" alt="user microposts mockup bootstrap" />
  <p class="caption"><span>图 10.4：</span>显示了微博的资料页面构思图</p>
</div>
<p>按照上面这种方式定义了微博后，我们就可以使用代码 10.16 中的代码测试用户资料页面中是否显示了这些微博。</p>

<div class="codeblock has-caption" id="codeblock-10-16"><p class="caption"><span>代码 10.16：</span>检测用户资料页面是否显示了微博的测试</p><p class="file"><code>spec/requests/user_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">describe</span> <span class="s2">"profile page"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:m1</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user: </span><span class="n">user</span><span class="p">,</span> <span class="ss">content: </span><span class="s2">"Foo"</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:m2</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user: </span><span class="n">user</span><span class="p">,</span> <span class="ss">content: </span><span class="s2">"Bar"</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"microposts"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">m1</span><span class="p">.</span><span class="nf">content</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">m2</span><span class="p">.</span><span class="nf">content</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">count</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>注意，我们可以在关联关系的方法上调用 <code>count</code> 方法：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">count</span>
</pre></div>
</div>
<p>这个 <code>count</code> 方法是很聪明的，可以直接在数据库层统计数量。也就是说，<code>count</code> 的计数过程不是把微博从数据库中取出来，然后再在所得的数组上调用 <code>length</code> 方法，如果这样做的话，微博数量一旦很多的话，效率就会很低。其实，<code>count</code> 方法会直接在数据库层中统计用户的微博数量。如果统计数量仍然是程序的性能瓶颈的话，你可以使用“<a href="http://railscasts.com/episodes/23-counter-cache-column">计数缓存</a>”进一步提速。</p>

<p>在加入代码 10.18 之前，代码 10.16 中的测试是无法通过的，不过现在我们可以先在用户的资料页面中加入一些微博，如代码 10.17 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-17"><p class="caption"><span>代码 10.17：</span>在用户资料页面中加入微博</p><p class="file"><code>app/views/users/show.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  .
  .
  .
  <span class="nt">&lt;aside&gt;</span>
    .
    .
    .
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span8"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">any?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Microposts (<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span>)<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">"microposts"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ol&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p>微博列表稍后分析，现在先看看其他部分。在这段代码中，<code>if @user.microposts.any?</code>（在代码 7.24 中见过类似的用法）的作用是，如果用户没有发布微博的话，就不会显示后面的列表。</p>

<p>还要注意一下，在代码 10.17 中我们也加入了微博的分页显示功能：</p>

<div class="codeblock"><div class="highlight type-erb"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div>
</div>
<p>如果和用户索引页面中对应的代码（参见代码 9.33）比较的话，会发现，之前所用的代码是：</p>

<div class="codeblock"><div class="highlight type-erb"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div>
<p>之前之所以可以直接调用，是因为在 Users 控制器中，<code>will_paginate</code> 默认程序中存在一个名为 <code>@users</code> 的变量（在 <a href="chapter9.html#section-9-3-3">9.3.3 节</a>中介绍过，该变量的值必须是 <code>AvtiveRecord::Relation</code> 的实例）。现在，虽然我们还在 Users 控制器中，但是我们要对<strong>微博</strong>分页，所以 <code>will_paginate</code> 方法要指定 <code>@microposts</code> 变量作为参数。当然了，我们还要在 <code>show</code> 动作中定义 <code>@microposts</code> 变量（参见代码 10.19）。</p>

<p>接着，还显示了当前微博的数量：</p>

<div class="codeblock"><div class="highlight type-erb"><pre><span class="nt">&lt;h3&gt;</span>Microposts (<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span>)<span class="nt">&lt;/h3&gt;</span>
</pre></div>
</div>
<p>前面介绍过，<code>@user.microposts.count</code> 的作用和 <code>User.count</code> 类似，不过统计的微博数量却是建立在用户和微博的关联关系上的。</p>

<p>最后，我们来看一下显示微博的列表：</p>

<div class="codeblock"><div class="highlight type-erb"><pre><span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">"microposts"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ol&gt;</span>
</pre></div>
</div>
<p>这段代码使用了一个有序列表标签 <code>ol</code>，显示一个微博列表，不过关键的部分是通过一个微博局部视图实现的。在 <a href="chapter9.html#section-9-3-4">9.3.4 节</a>中介绍过，如下的代码</p>

<div class="codeblock"><div class="highlight type-erb"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
</pre></div>
</div>
<p>会使用名为 <code>_user.html.erb</code> 的局部视图渲染 <code>@users</code> 变量中的每一个用户。因此，如下的代码</p>

<div class="codeblock"><div class="highlight type-erb"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div>
</div>
<p>会对微博做同样的渲染操作。所以，我们要创建名为 <code>_micropost.html.erb</code> 的局部视图（存放在微博对应的视图文件夹中），如代码 10.18 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-18"><p class="caption"><span>代码 10.18：</span>显示单篇微博的局部视图</p><p class="file"><code>app/views/microposts/_micropost.html.erb</code></p><div class="highlight type-erb"><pre><span class="nt">&lt;li&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="p">.</span><span class="nf">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"timestamp"</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="p">.</span><span class="nf">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div>
<p>这段代码使用了 <code>time_ago_in_words</code> 帮助方法，会在 <a href="chapter10.html#section-10-2-2">10.2.2 节</a>中介绍。</p>

<div class="figure" id="figure-10-5">
  <img src="figures/user_profile_no_microposts_bootstrap.png" alt="user profile no microposts bootstrap" />
  <p class="caption"><span>图 10.5：</span>添加了显示微博代码后的用户资料页面，不过还没有微博可显示</p>
</div>
<p>至此，尽管定义了所需的全部视图，但是代码 10.16 中的测试仍旧无法通过，提示未定义 <code>@microposts</code> 变量。加入代码 10.19 中的代码后，测试就可以通过了。</p>

<div class="codeblock has-caption" id="codeblock-10-19"><p class="caption"><span>代码 10.19：</span>在 Users 控制器的 <code>show</code> 动作中加入 <code>@microposts</code> 实例变量</p><p class="file"><code>app/controllers/users_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">paginate</span><span class="p">(</span><span class="ss">page: </span><span class="n">params</span><span class="p">[</span><span class="ss">:page</span><span class="p">])</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>请注意一下 <code>paginate</code> 方法是多么的智能，它甚至可以通过关联关系，在 <code>microposts</code> 数据表中取出每个分页中要显示的微博。</p>

<p>现在，我们可以查看一下刚编好的用户资料页面了，如图 10.5 所示，可能会出乎你的意料，这也是理所当然的，因为我们还没有发布微博呢。下面我们就来发布微博。</p>

<h3 id='section-10-2-2'><span>10.2.2</span> 示例微博</h3>


<p>在 <a href="chapter10.html#section-10-2-1">10.2.1 节</a>中为了显示微博，创建了几个视图，但是结果有点不给力。为了改变这个悲剧，我们要在 <a href="chapter9.html#section-9-3-2">9.3.2 节</a>中用到的示例数据生成器中加入生成微博数据的代码。如果给所有的用户都生成一些微博的话要用很长的时间，所以我们暂且只给前六个用户<sup class="footnote" id="fnref-10-3"><a href="#fn-10-3" rel="footnote">3</a></sup>生成微博数据，这要用到 <code>User.all</code> 方法的 <code>:limit</code> 选项：<sup class="footnote" id="fnref-10-4"><a href="#fn-10-4" rel="footnote">4</a></sup></p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">all</span><span class="p">(</span><span class="ss">limit: </span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
<p>我们要为每个用户生成 50 篇微博（这个数量大于单页显示的 30 篇限制），使用 Faker gem 中简便的 <code>Lorem.sentence</code> 方法生成每篇微博的内容。（<code>Faker::Lorem.sentence</code> 生成的是 lorem ipsum 示例文字，我们在<a href="chapter6.html">第 6 章</a>中介绍过，lorem ipsum 背后有一段<a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean">有趣的故事</a>。）代码 10.20 中显示的是修改后的示例数据生成器。</p>

<div class="codeblock has-caption" id="codeblock-10-20"><p class="caption"><span>代码 10.20：</span>在示例数据生成器中加入生成微博的代码</p><p class="file"><code>lib/tasks/sample_data.rake</code></p><div class="highlight type-ruby"><pre><span class="n">namespace</span> <span class="p">:</span><span class="n">db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">"Fill database with sample data"</span>
  <span class="n">task</span> <span class="ss">populate: :environment</span> <span class="k">do</span>
    <span class="p">.</span>
    <span class="nf">.</span>
    <span class="p">.</span>
    <span class="nf">users</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">all</span><span class="p">(</span><span class="ss">limit: </span><span class="mi">6</span><span class="p">)</span>
    <span class="mi">50</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span>
      <span class="n">content</span> <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Lorem</span><span class="p">.</span><span class="nf">sentence</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
      <span class="n">users</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">content: </span><span class="n">content</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>当然，如果要生成示例数据，我们要执行 <code>db:populate</code> 命令：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$ </span>bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div>
</div>
<p>然后，我们就能看到 <a href="chapter10.html#section-10-2-1">10.2.1 节</a>中劳动的果实了，在用户资料页面显示了生成的微博。<sup class="footnote" id="fnref-10-5"><a href="#fn-10-5" rel="footnote">5</a></sup>初步结果如图 10.6 所示。</p>

<div class="figure" id="figure-10-6">
  <img src="figures/user_profile_microposts_no_styling_bootstrap.png" alt="user profile microposts no styling bootstrap" />
  <p class="caption"><span>图 10.6：</span>用户资料页面（<a href="http://localhost/users/1">/users/1</a>）中显示的尚未样式化的微博列表</p>
</div>
<p>图 10.6 中显示的微博列表还没有加入样式，那我们就加入一些样式（参见代码 10.21）<sup class="footnote" id="fnref-10-6"><a href="#fn-10-6" rel="footnote">6</a></sup>，再看一下页面显示的效果。图 10.7 显示的是第一个用户（当前登录用户）的资料页面，图 10.8 显示的是另一个用户的资料页面，图 10.9 显示的是第一个用户资料页面的第 2 页，页面底部还显示了分页链接。注意观察这三幅图，我们可以看到微博后面显示了距离发布的时间（例如，“Posted 1 minute ago.”），这个效果是通过代码 10.18 中的 <code>time_ago_in_words</code> 方法实现的。过一会再刷新页面，你会发现这些文字依据当前时间自动更新了。</p>

<div class="figure" id="figure-10-7">
  <img src="figures/user_profile_with_microposts_bootstrap.png" alt="user profile with microposts bootstrap" />
  <p class="caption"><span>图 10.7：</span>显示了微博的用户资料页面（<a href="http://localhost:3000/users/1">/users/1</a>）</p>
</div>
<div class="codeblock has-caption" id="codeblock-10-21"><p class="caption"><span>代码 10.21：</span>微博列表的样式（包含了本章用到的所有样式）</p><p class="file"><code>app/assets/stylesheets/custom.css.scss</code></p><div class="highlight type-scss"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">microposts</span> <span class="o">*/</span>

<span class="nc">.microposts</span> <span class="p">{</span>
  <span class="nl">list-style</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
  <span class="nl">margin</span><span class="p">:</span> <span class="m">10px</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span><span class="p">;</span>

  <span class="nt">li</span> <span class="p">{</span>
    <span class="nl">padding</span><span class="p">:</span> <span class="m">10px</span> <span class="m">0</span><span class="p">;</span>
    <span class="nl">border-top</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="mh">#e8e8e8</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nc">.content</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.timestamp</span> <span class="p">{</span>
  <span class="nl">color</span><span class="p">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="nl">float</span><span class="p">:</span> <span class="nb">left</span><span class="p">;</span>
  <span class="nl">margin-right</span><span class="p">:</span> <span class="m">10px</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">aside</span> <span class="p">{</span>
  <span class="nt">textarea</span> <span class="p">{</span>
    <span class="nl">height</span><span class="p">:</span> <span class="m">100px</span><span class="p">;</span>
    <span class="nl">margin-bottom</span><span class="p">:</span> <span class="m">5px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="figure" id="figure-10-8">
  <img src="figures/other_profile_with_microposts_bootstrap.png" alt="other profile with microposts bootstrap" />
  <p class="caption"><span>图 10.8：</span>另一个用户的资料页面，也显示了微博列表（<a href="http://localhost:3000/users/5">/users/5</a>）</p>
</div>
<div class="figure" id="figure-10-9">
  <img src="figures/user_profile_microposts_page_2_rails_3_bootstrap.png" alt="user profile microposts page 2 rails3 bootstrap" />
  <p class="caption"><span>图 10.9：</span>微博分页链接（<a href="http://localhost:3000/users/1?page=2">/users/1?page=2</a>）</p>
</div>
<h2 id='section-10-3'><span>10.3</span> 微博相关的操作</h2>


<p>微博的数据模型构建好了，也编写了相关的视图文件，接下来我们的开发重点是，通过网页发布微博。在实现的过程中，我们会第三次用到表单来创建资源，这一次创建的是 Microposts 资源<sup class="footnote" id="fnref-10-7"><a href="#fn-10-7" rel="footnote">7</a></sup>。本节，我们还会初步实现动态列表（status feed），在<a href="chapter11.html">第 11 章</a>再完善。最后，和 Users 资源类似，我们还要实现在网页中删除微博的功能。</p>

<p>上述功能的实现和之前的惯例有一点是不一样的地方，需要特别注意，那就是，Microposts 资源相关的页面不是通过 Microposts 控制器实现的，而是依赖于 Users 和 StaticPages 控制器。这也就意味着，Microposts 资源的路由设置是很简单的，如代码 10.22 所示。代码 10.22 中的代码所代表的符合 REST 结构的路由如<a href="chapter10.html#table-10-2">表格 10.2</a> 所示，表中的路由只是<a href="chapter2.html#table-2-3">表格 2.3</a> 的一部分。不过，路由虽然简化了，但预示着实现的过程需要更高级的技术，而不会减小代码的复杂度。从<a href="chapter2.html">第 2 章</a>起我们就十分依赖脚手架，不过现在我们将舍弃脚手架的大部分功能。</p>

<div class="codeblock has-caption" id="codeblock-10-22"><p class="caption"><span>代码 10.22：</span>Microposts 资源的路由设置</p><p class="file"><code>config/routes.rb</code></p><div class="highlight type-ruby"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="p">:</span><span class="n">users</span>
  <span class="n">resources</span> <span class="p">:</span><span class="n">sessions</span><span class="p">,</span>   <span class="ss">only: </span><span class="p">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">]</span>
  <span class="n">resources</span> <span class="p">:</span><span class="n">microposts</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">]</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<div class="table has-caption" id="table-10-2"><p class="caption"><span>表格 10.2：</span>代码 10.25 设置的 Microposts 资源路由</p><table>
  <thead>
    <tr>
      <th>HTTP 请求</th>
      <th>URL</th>
      <th>动作</th>
      <th>作用</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>POST</td>
      <td>/microposts</td>
      <td><code>create</code></td>
      <td>创建新微博</td>
    </tr>
    <tr>
      <td>DELETE</td>
      <td>/microposts/1</td>
      <td><code>destroy</code></td>
      <td>删除 id 为 1 的微博</td>
    </tr>
  </tbody>
</table>
</div>
<h3 id='section-10-3-1'><span>10.3.1</span> 访问限制</h3>


<p>开发 Microposts 资源的第一步，我们要在 Microposts 控制器中实现访问限制。我们要实现的效果很简单：若要访问 <code>create</code> 和 <code>destroy</code> 动作就要先登录。针对访问限制的 RSpec 测试如代码 10.23 所示。（在 <a href="chapter10.html#section-10-3-4">10.3.4 节</a>中，我们还会测试并加入第三层保护措施，确保只有微博的发布者才能删除该微博。）</p>

<div class="codeblock has-caption" id="codeblock-10-23"><p class="caption"><span>代码 10.23：</span>限制访问 Microposts 资源的测试</p><p class="file"><code>spec/requests/authentication_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="p">.</span>
      <span class="nf">.</span>
      <span class="p">.</span>
      <span class="nf">describe</span> <span class="s2">"in the Microposts controller"</span> <span class="k">do</span>

        <span class="n">describe</span> <span class="s2">"submitting to the create action"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">post</span> <span class="n">microposts_path</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"submitting to the destroy action"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">micropost_path</span><span class="p">(</span><span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">))</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="p">.</span>
      <span class="nf">.</span>
      <span class="p">.</span>
    <span class="nf">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>上述代码没有使用即将实现的网页界面，而是直接在 Microposts 控制器层面操作：如果向 /microposts 发送 POST 请求（<code>POST microposts_path</code> 访问的是 <code>create</code> 动作），或者向 /microposts/1 发送 DELETE 请求（<code>delete micropost_path(micropost)</code> 访问的是 <code>destroy</code> 动作），则会转向登录页面——我们在代码 9.13 中就用过这种方法。</p>

<p>我们要先对程序的代码做点重构，然后再加入程序中，让代码 10.23 中的测试通过。在 <a href="chapter9.html#section-9-2-1">9.2.1 节</a>中，我们定义了一个名为 <code>signed_in_user</code> 的事前过滤器（参见代码 9.12），确保访问相关的动作之前用户要先登录。那时，我们只需要在 Users 控制器中使用这个事前过滤器，但是现在我们在 Microposts 控制器中也要用到，那么我们就把它移到 Sessions 的帮助方法中，如代码 10.24 所示。<sup class="footnote" id="fnref-10-8"><a href="#fn-10-8" rel="footnote">8</a></sup></p>

<div class="codeblock has-caption" id="codeblock-10-24"><p class="caption"><span>代码 10.24：</span>把 <code>signed_in_user</code> 方法移到 Sessions 帮助方法中</p><p class="file"><code>app/helpers/sessions_helper.rb</code></p><div class="highlight type-ruby"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">signed_in_user</span>
    <span class="k">unless</span> <span class="n">signed_in?</span>
      <span class="n">store_location</span>
      <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice: </span><span class="s2">"Please sign in."</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>为了避免代码重复，同时还要把 <code>signed_in_user</code> 从 Users 控制器中删掉。</p>

<p>加入了代码 10.24 之后，我们就可以在 Microposts 控制器中使用 <code>signed_in_user</code> 方法了，因此我们就可以使用代码 10.25 中的事前过滤器来限制访问 <code>create</code> 和 <code>destroy</code> 动作了。（因为我们没有使用命令行生成 Microposts 控制器文件，因此需要手动创建。）</p>

<div class="codeblock has-caption" id="codeblock-10-25"><p class="caption"><span>代码 10.25：</span>在 Microposts 控制器中加入访问限制功能</p><p class="file"><code>app/controllers/microposts_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>注意，我们没有明确指定事前过滤器要限制的动作有哪几个，因为默认情况下仅有的两个动作都会被限制。如果我们要加入第三个动作，例如 <code>index</code> 动作，未登录的用户可以访问，那么我们就要明确的指定要限制的动作了：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">signed_in_user</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">index</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>现在，测试应该可以通过了：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb
</pre></div>
</div>
<h3 id='section-10-3-2'><span>10.3.2</span> 创建微博</h3>


<p>在<a href="chapter7.html">第 7 章</a>中，我们实现了用户注册功能，方法是使用 HTML 表单向 Users 控制器的 <code>create</code> 动作发送 POST 请求。创建微博的功能实现起来是类似的，最大的不同点在于，表单不是放在单独的页面 /microposts/new 中，而是在网站的首页（模仿 Twitter，在根地址 <a href="http://localhost:3000">/</a>），构思图如图 10.10 所示。</p>

<p>上一次接触首页时，是图 5.6 那个样子，在页面中部有个“Sign up now!”链接按钮。因为创建微博的表单只对登录后的用户有用，所以本节的目标之一就是根据用户的登录状态显示不同的首页内容，如代码 10.28 所示，不过在此之前，我们可以先编写测试。和用户资源一样，我们要使用集成测试：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>rails generate integration_test micropost_page
</pre></div>
</div>
<div class="figure" id="figure-10-10">
  <img src="figures/home_page_with_micropost_form_mockup_bootstrap.png" alt="home page with micropost form mockup bootstrap" />
  <p class="caption"><span>图 10.10：</span>包含创建微博表单的首页构思图</p>
</div>
<p>对创建微博功能的测试和对创建用户功能的测试（参见代码 7.16）类似，如代码 10.26 所示：</p>

<div class="codeblock has-caption" id="codeblock-10-26"><p class="caption"><span>代码 10.26：</span>对创建微博功能的测试</p><p class="file"><code>spec/requests/micropost_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Micropost pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"micropost creation"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"with invalid information"</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">"should not create a micropost"</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Post"</span> <span class="p">}.</span><span class="nf">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">"error messages"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Post"</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'error'</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>

      <span class="n">before</span> <span class="p">{</span> <span class="n">fill_in</span> <span class="s1">'micropost_content'</span><span class="p">,</span> <span class="ss">with: </span><span class="s2">"Lorem ipsum"</span> <span class="p">}</span>
      <span class="n">it</span> <span class="s2">"should create a micropost"</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Post"</span> <span class="p">}.</span><span class="nf">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">).</span><span class="nf">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>下面我们来编写 Microposts 控制器 <code>create</code> 动作的代码，和 Users 控制器的有点类似（参见代码 7.26），主要的区别是，创建微博时，要使用用户和微博的关联关系来构建微博对象，如代码 10.27 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-27"><p class="caption"><span>代码 10.27：</span>Microposts 控制器的 <code>create</code> 动作</p><p class="file"><code>app/controllers/microposts_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">micropost_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">flash</span><span class="p">[</span><span class="ss">:success</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Micropost created!"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'static_pages/home'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">micropost_params</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>我们使用代码 10.28 来构建创建微博所需的表单，这个视图会根据用户的登录状态显示不同的 HTML 内容。</p>

<div class="codeblock has-caption" id="codeblock-10-28"><p class="caption"><span>代码 10.28：</span>在首页中加入创建微博所需的表单</p><p class="file"><code>app/views/static_pages/home.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"span4"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/user_info'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/micropost_form'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"center hero-unit"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Welcome to the Sample App<span class="nt">&lt;/h1&gt;</span>

    <span class="nt">&lt;h2&gt;</span>
      This is the home page for the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      sample application.
    <span class="nt">&lt;/h2&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span><span class="p">,</span>
                                <span class="ss">class: </span><span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">"rails.png"</span><span class="p">,</span> <span class="ss">alt: </span><span class="s2">"Rails"</span><span class="p">),</span> <span class="s1">'http://rubyonrails.org/'</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>
<p>上述代码中 <code>if-else</code> 条件语句的各分支包含的代码太多，有点乱，在练习中（<a href="chapter10.html#section-10-5">10.5 节</a>）我们会进行优化，把分支中的代码放入局部视图中。不过代码 10.28 中用到的局部视图不会留作练习，现在就来创建：用户信息侧边栏局部视图如代码 10.29 所示，创建微博的表单局部视图如代码 10.30 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-29"><p class="caption"><span>代码 10.29：</span>用户信息侧边栏局部视图</p><p class="file"><code>app/views/shared/_user_info.html.erb</code></p><div class="highlight type-erb"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">current_user</span><span class="p">,</span> <span class="ss">size: </span><span class="mi">52</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;span&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"view my profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">count</span><span class="p">,</span> <span class="s2">"micropost"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/span&gt;</span>
</pre></div>
</div>
<p>和代码 9.24 一样，代码 10.29 使用了代码 7.30 中定义的 <code>gravatar_for</code> 帮助方法。</p>

<p>注意，和用户资料页面的侧边栏类似（参见代码 10.20），代码 10.29 中的用户信息也显示了用户发布的微博数量。不过显示上有细微的差别，在用户资料页面的侧边栏中，“Microposts” 是作为标签使用的，所以“Microposts (1)”这样的用法是合理的。而在本例中，如果说“1 microposts”的话就有点不合语法了，所以我们调用了 <code>pluralize</code> 方法，显示成“1 micropost”，“2 microposts”等。</p>

<p>下面我们来编写创建微博表单的局部视图，如代码 10.30 所示，和代码 7.17 中的注册表单是类似的。</p>

<div class="codeblock has-caption" id="codeblock-10-30"><p class="caption"><span>代码 10.30：</span>创建微博表单局部视图</p><p class="file"><code>app/views/shared/_micropost_form.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object: </span><span class="n">f</span><span class="p">.</span><span class="nf">object</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_area</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">placeholder: </span><span class="s2">"Compose new micropost..."</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Post"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>
<p>如果要代码 10.30 中的表单可用，我们还要做两件事。第一，（和之前一样）我们要通过关联关系定义 <code>@micropost</code> 变量：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">build</span>
</pre></div>
</div>
<p>写入控制器后如代码 10.31 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-31"><p class="caption"><span>代码 10.31：</span>在 <code>home</code> 动作中定义 <code>@micropost</code> 实例变量</p><p class="file"><code>app/controllers/static_pages_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">build</span> <span class="k">if</span> <span class="n">signed_in?</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>代码 10.31 中的代码有一个好处，如果我们忘记加入要求用户登录的限制，相应的测试会失败。</p>

<p>我们要做的第二件事是，重写错误提示信息局部视图，让 <code>&lt;%= render 'shared/error_messages', object: f.object %&gt;</code> 这行代码能正确运行。你可能还记得，在代码 7.23 中，错误提示信息的局部视图代码直接引用了 <code>@user</code> 变量，但现在我们提供的变量却是 <code>@micropost</code>。因此，我们要编写一个新的错误提示信息局部视图，不管传入的是什么变量，都能正常使用。幸好，表单的块变量 <code>f</code> 可以通过 <code>f.object</code> 获取当前的对象，因此，在 <code>form_for(@user) do |f|</code> 中，<code>f.object</code> 的返回值是 <code>@user</code>；在 <code>form_for(@micropost) do |f|</code> 中，<code>f.object</code> 的返回值是 <code>@micropost</code>。</p>

<p>我们要通过一个 Hash 把对象传入局部视图，其值是该对象，键是局部视图中所需的变量名称，如下面的代码所示：</p>

<div class="codeblock"><div class="highlight type-erb"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object: </span><span class="n">f</span><span class="p">.</span><span class="nf">object</span> <span class="cp">%&gt;</span>
</pre></div>
</div>
<p>换句话说，<code>object: f.object</code> 会创建一个名为 <code>object</code> 的变量，供 <code>error_messages</code> 局部视图使用。利用这个对象，我们就可以编写不同的错误提示信息，如代码 10.32 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-32"><p class="caption"><span>代码 10.32：</span>修改代码 7.23 中的错误提示信息局部视图，如果传入其他对象也可以使用</p><p class="file"><code>app/views/shared/_error_messages.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">object</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"error_explanation"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-error"</span><span class="nt">&gt;</span>
      The form contains <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">object</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">count</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">)</span> <span class="cp">%&gt;</span>.
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="n">object</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">full_messages</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span>* <span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>
<p>现在，代码 10.26 中的测试应该可以通过了：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/requests/micropost_pages_spec.rb
</pre></div>
</div>
<p>不过，Users 资源相关视图的 request spec 测试却失败了，因为注册和编辑用户的表单使用的仍是旧的错误提示信息局部视图。要想修正这个错误，就要换用新的局部视图，如代码 10.33 和代码 10.34 所示。（注意：如果你加入了 <a href="chapter9.html#section-9-6">9.6 节</a>练习中的代码 9.49 和代码 9.50，那么要修改的代码有点不一样，需要做适当的修改。）</p>

<div class="codeblock has-caption" id="codeblock-10-33"><p class="caption"><span>代码 10.33：</span>修改用户注册表单的错误提示信息局部视图</p><p class="file"><code>app/views/users/new.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Sign up'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span6 offset3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object: </span><span class="n">f</span><span class="p">.</span><span class="nf">object</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<div class="figure" id="figure-10-11">
  <img src="figures/home_with_form_bootstrap.png" alt="home with form bootstrap" />
  <p class="caption"><span>图 10.11：</span>显示有创建微博表单的首页（<a href="http://localhost:3000/">/</a>）</p>
</div>
<div class="codeblock has-caption" id="codeblock-10-34"><p class="caption"><span>代码 10.34：</span>修改编辑用户表单的错误提示信息局部视图</p><p class="file"><code>app/views/users/edit.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Edit user"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Update your profile<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span6 offset3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object: </span><span class="n">f</span><span class="p">.</span><span class="nf">object</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://gravatar.com/emails"</span><span class="nt">&gt;</span>change<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p>现在，所有的测试应该都可以通过了：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<p>而且，本节添加的所有 HTML 代码也都能正确渲染：图 10.11 中显示了创建微博的表单，图 10.12 中显示了有一个错误提示信息的表单。现在你可以自己发布一篇微博试一下一切是否都可以正常运行，不过最好还是在 <a href="chapter10.html#section-10-3-3">10.3.3 节</a>之后再试吧。</p>

<div class="figure" id="figure-10-12">
  <img src="figures/home_form_errors_bootstrap.png" alt="home form errors bootstrap" />
  <p class="caption"><span>图 10.12：</span>显示有错误提示信息的首页</p>
</div>
<h3 id='section-10-3-3'><span>10.3.3</span> 临时的动态列表</h3>


<p><a href="chapter10.html#section-10-3-2">10.3.2 节</a>遗留了一个功能没有实现：首页没有显示动态。如果你愿意的话，可以在图 10.11 所示的表单中发表一篇合法的微博，然后转到用户资料页面，验证一下这个表单是否可以正常使用。这样在页面之间来来回回是有点麻烦的，如果能在首页显示一个含有当前登入用户的微博列表就好了，构思图如图 10.13 所示。（在<a href="chapter11.html">第 11 章</a>中，我们会在这个微博列表中加入当前登入用户所关注用户的微博。）</p>

<div class="figure" id="figure-10-13">
  <img src="figures/proto_feed_mockup_bootstrap.png" alt="proto feed mockup bootstrap" />
  <p class="caption"><span>图 10.13：</span>显示有临时动态列表的首页构思图</p>
</div>
<p>因为每个用户都应该有一个动态列表，因此我们可以在 User 模型中定义一个名为 <code>feed</code> 的方法。等功能全部实现后，我们会测试微博列表中是否包含了所关注用户的微博，不过现在我们只需要测试 <code>feed</code> 方法的返回值是否只有当前登入用户的微博，而没有其他用户的微博。测试所需的代码如代码 10.35 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-35"><p class="caption"><span>代码 10.35：</span>对临时动态列表的测试</p><p class="file"><code>spec/models/user_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:microposts</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">describe</span> <span class="s2">"micropost associations"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user: </span><span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">day</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user: </span><span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">hour</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="p">.</span>
    <span class="nf">.</span>
    <span class="p">.</span>
    <span class="nf">describe</span> <span class="s2">"status"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:unfollowed_post</span><span class="p">)</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user: </span><span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
      <span class="k">end</span>

      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">newer_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">older_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">unfollowed_post</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

</pre></div>
</div>
<p>上述代码，在数组上调用了 <code>include?</code> 方法（基于 RSpec 对布尔值方法的约定），该方法的作用是检查数组中是否包含指定的元素：<sup class="footnote" id="fnref-10-9"><a href="#fn-10-9" rel="footnote">9</a></sup></p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>rails console
<span class="gp">&gt;&gt; </span>a <span class="o">=</span> <span class="o">[</span>1, <span class="s2">"foo"</span>, :bar]
<span class="gp">&gt;&gt; </span>a.include?<span class="o">(</span><span class="s2">"foo"</span><span class="o">)</span>
<span class="gp">=&gt; </span><span class="nb">true</span>
<span class="gp">&gt;&gt; </span>a.include?<span class="o">(</span>:bar<span class="o">)</span>
<span class="gp">=&gt; </span><span class="nb">true</span>
<span class="gp">&gt;&gt; </span>a.include?<span class="o">(</span><span class="s2">"baz"</span><span class="o">)</span>
<span class="gp">=&gt; </span><span class="nb">false</span>
</pre></div>
</div>
<p>这段代码说明了 RSpec 对布尔值方法的约定是多么的灵活，虽然 <code>include</code> 是 Ruby 语言的关键字（用来引入模块，在代码 8.14 中有用到），但在当前语境中，RSpec 依然能正确的识别我们的意图是要测试数组是否包含了指定的元素。</p>

<p>在编写 <code>feed</code> 方法时，我们需要从数据库中取出所有 <code>user_id</code> 等于当前用户 id 的微博，要在 <code>Micropost</code> 对象上调用 <code>where</code> 方法，如代码 10.36 所示。<sup class="footnote" id="fnref-10-10"><a href="#fn-10-10" rel="footnote">10</a></sup></p>

<div class="codeblock has-caption" id="codeblock-10-36"><p class="caption"><span>代码 10.36：</span>动态列表的初步实现</p><p class="file"><code>app/models/user.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">feed</span>
    <span class="c1"># This is preliminary. See "Following users" for the full implementation.</span>
    <span class="no">Micropost</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"user_id = ?"</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p><code>Micropost.where("user_id = ?", id)</code> 中的问号可以确保 <code>id</code> 的值在传入底层的 SQL 查询语句之前做了适当的转义，避免“SQL 注入”这种严重的安全隐患。这里用到的 <code>id</code> 属性是个整数，没什么危险，不过在 SQL 语句中引入变量之前做转义是个好习惯。</p>

<p>细心的读者可能已经注意到了，现阶段代码 10.36 中的代码和下面的定义作用是一样的：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="k">def</span> <span class="nf">feed</span>
  <span class="n">microposts</span>
<span class="k">end</span>
</pre></div>
</div>
<p>我们之所以使用了代码 10.39 的版本，是因为它能更好的服务于<a href="chapter11.html">第 11 章</a>中实现的完整的动态列表。</p>

<p>要测试动态列表的显示，我们首先要创建一些微博，然后检测各微博在页面中是否均包含在列表元素 <code>li</code> 中，如代码 10.37 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-37"><p class="caption"><span>代码 10.37：</span>测试首页显示的微博列表</p><p class="file"><code>spec/requests/static_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>
    <span class="p">.</span>
    <span class="nf">.</span>
    <span class="p">.</span>
    <span class="nf">describe</span> <span class="s2">"for signed-in users"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user: </span><span class="n">user</span><span class="p">,</span> <span class="ss">content: </span><span class="s2">"Lorem ipsum"</span><span class="p">)</span>
        <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user: </span><span class="n">user</span><span class="p">,</span> <span class="ss">content: </span><span class="s2">"Dolor sit amet"</span><span class="p">)</span>
        <span class="n">sign_in</span> <span class="n">user</span>
        <span class="n">visit</span> <span class="n">root_path</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"should render the user's feed"</span> <span class="k">do</span>
        <span class="n">user</span><span class="p">.</span><span class="nf">feed</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
          <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">"li#</span><span class="si">#{</span><span class="n">item</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">text: </span><span class="n">item</span><span class="p">.</span><span class="nf">content</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>代码 10.37 假设所显示的每篇微博都有唯一的 CSS id，所以如下代码</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">"li#</span><span class="si">#{</span><span class="n">item</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">text: </span><span class="n">item</span><span class="p">.</span><span class="nf">content</span><span class="p">)</span>
</pre></div>
</div>
<p>会为每个微博生成一个匹配器。（注意，<code>li##{item.id}</code> 中的第一个 <code>#</code> 是 Capybara 中的对应 CSS id 的句法，而第二个 <code>#</code> 则代表 Ruby 字符串插值操作 <code>#{}</code> 的开始。）</p>

<p>要在示例程序中使用动态列表，我们可以在 <code>home</code> 动作中定义一个 <code>@feed_items</code> 实例变量，如代码 10.38 所示。然后再在首页（参见代码 10.41）中加入一个动态列表局部视图（参见代码 10.39）。（对分页的测试会留作练习，参见 <a href="chapter10.html#section-10-5">10.5 节</a>。）</p>

<div class="codeblock has-caption" id="codeblock-10-38"><p class="caption"><span>代码 10.38：</span>在 <code>home</code> 动作中加入一个实例变量</p><p class="file"><code>app/controllers/static_pages_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="k">if</span> <span class="n">signed_in?</span>
      <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">build</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">feed</span><span class="p">.</span><span class="nf">paginate</span><span class="p">(</span><span class="ss">page: </span><span class="n">params</span><span class="p">[</span><span class="ss">:page</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<div class="codeblock has-caption" id="codeblock-10-39"><p class="caption"><span>代码 10.39：</span>动态列表局部视图</p><p class="file"><code>app/views/shared/_feed.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@feed_items</span><span class="p">.</span><span class="nf">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">"microposts"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial: </span><span class="s1">'shared/feed_item'</span><span class="p">,</span> <span class="ss">collection: </span><span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/ol&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>
<p>动态列表局部视图使用如下代码，把列表项目的渲染支配给了 <code>feed_item</code> 局部视图：</p>

<div class="codeblock"><div class="highlight type-erb"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial: </span><span class="s1">'shared/feed_item'</span><span class="p">,</span> <span class="ss">collection: </span><span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
</pre></div>
</div>
<p>我们传入了一个名为 <code>:collection</code> 的参数，其值为 <code>@feed_items</code>，这样 <code>render</code> 方法就会在指定的局部视图中（本例中的 <code>feed_item</code>）使用这个集合中的数据渲染各项目。（之前，在渲染局部视图时，我们都省略了 <code>:partial</code> 参数，例如 <code>render 'shared/micropost'</code>，不过如果指定了 <code>:collection</code> 参数，这种省略的用法就是错误的。）列表项目局部视图的代码如代码 10.40 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-40"><p class="caption"><span>代码 10.40：</span>渲染单个动态列表项目的局部视图</p><p class="file"><code>app/views/shared/_feed_item.html.erb</code></p><div class="highlight type-erb"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">feed_item</span><span class="p">.</span><span class="nf">user</span><span class="p">),</span> <span class="n">feed_item</span><span class="p">.</span><span class="nf">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"user"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">feed_item</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">feed_item</span><span class="p">.</span><span class="nf">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="p">.</span><span class="nf">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"timestamp"</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">feed_item</span><span class="p">.</span><span class="nf">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div>
<p>代码 10.40 还使用如下的代码为每个动态项目指定了 CSS id：</p>

<div class="codeblock"><div class="highlight type-erb"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
</pre></div>
</div>
<p>这正是代码 10.37 中的测试所要检测的。</p>

<p>和之前一样，我们可以把动态列表局部视图加入首页来显示动态，如代码 10.41 所示。加入后的效果就是在首页显示了动态列表，和预期一样，如图 10.14 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-41"><p class="caption"><span>代码 10.41：</span>在首页中加入动态列表</p><p class="file"><code>app/views/static_pages/home.html.erb</code></p><div class="highlight type-erb"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
    .
    .
    .
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span8"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Micropost Feed<span class="nt">&lt;/h3&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/feed'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>
<div class="figure" id="figure-10-14">
  <img src="figures/home_with_proto_feed_bootstrap.png" alt="home with proto feed bootstrap" />
  <p class="caption"><span>图 10.14：</span>显示了临时动态列表的首页（<a href="http://localhost:3000/">/</a>）</p>
</div>
<p>现在，发布新微博的功能可以按照预期正常工作了，如图 10.15 所示。不过还有个小小不足：如果发布微博失败，首页还会需要一个名为 <code>@feed_items</code> 的实例变量，所以提交失败时网站就无法正常运行了（你也可以运行测试来验证一下）。最简单的解决方法是，如果提交失败就把 <code>@feed_items</code> 设为空数组，如代码 10.42 所示。<sup class="footnote" id="fnref-10-11"><a href="#fn-10-11" rel="footnote">11</a></sup></p>

<div class="figure" id="figure-10-15">
  <img src="figures/micropost_created_bootstrap.png" alt="micropost created bootstrap" />
  <p class="caption"><span>图 10.15：</span>发布新微博后的首页</p>
</div>
<div class="codeblock has-caption" id="codeblock-10-42"><p class="caption"><span>代码 10.42：</span>在 <code>create</code> 动作加入一个空的 <code>@feed_items</code> 实例变量</p><p class="file"><code>app/controllers/microposts_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">micropost_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">flash</span><span class="p">[</span><span class="ss">:success</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Micropost created!"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">render</span> <span class="s1">'static_pages/home'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
<span class="nf">end</span>
</pre></div>
</div>
<p>至此，临时的动态列表可以正常工作了，测试组件也可以通过了：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<h3 id='section-10-3-4'><span>10.3.4</span> 删除微博</h3>


<p>我们要为 Microposts 资源实现的最后一个功能是删除微博。和删除用户类似（参见 <a href="chapter9.html#section-9-4-2">9.4.2 节</a>），删除微博也是通过“delete”链接实现的，构思图如图 10.16 所示。删除用户要限制只有管理员才能进行，而删除微博的链接只对微博的发布者可用。</p>

<div class="figure" id="figure-10-16">
  <img src="figures/micropost_delete_links_mockup_bootstrap.png" alt="micropost delete links mockup bootstrap" />
  <p class="caption"><span>图 10.16：</span>显示有删除链接的临时动态列表构思图</p>
</div>
<p>第一步，我们要在微博局部视图（代码 10.21）中加入删除链接，同时还要在动态列表项目的局部视图（代码 10.40）中加入类似的链接，结果如代码 10.43 和代码 10.44 所示。（这两个局部视图基本上是一样的，消除代码重复会留作练习，参见 <a href="chapter10.html#section-10-5">10.5 节</a>。）</p>

<div class="codeblock has-caption" id="codeblock-10-43"><p class="caption"><span>代码 10.43：</span>在微博局部视图中加入删除链接</p><p class="file"><code>app/views/microposts/_micropost.html.erb</code></p><div class="highlight type-erb"><pre><span class="nt">&lt;li&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="p">.</span><span class="nf">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"timestamp"</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="p">.</span><span class="nf">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">micropost</span><span class="p">.</span><span class="nf">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="n">micropost</span><span class="p">,</span> <span class="ss">method: :delete</span><span class="p">,</span>
                                     <span class="ss">data: </span><span class="p">{</span> <span class="ss">confirm: </span><span class="s2">"You sure?"</span> <span class="p">},</span>
                                     <span class="ss">title: </span><span class="n">micropost</span><span class="p">.</span><span class="nf">content</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div>
<div class="codeblock has-caption" id="codeblock-10-44"><p class="caption"><span>代码 10.44：</span>在动态列表项目局部视图中加入删除链接</p><p class="file"><code>app/views/shared/_feed_item.html.erb</code></p><div class="highlight type-erb"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">feed_item</span><span class="p">.</span><span class="nf">user</span><span class="p">),</span> <span class="n">feed_item</span><span class="p">.</span><span class="nf">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"user"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">feed_item</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">feed_item</span><span class="p">.</span><span class="nf">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="p">.</span><span class="nf">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"timestamp"</span><span class="nt">&gt;</span>
      Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">feed_item</span><span class="p">.</span><span class="nf">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
    <span class="nt">&lt;/span&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">feed_item</span><span class="p">.</span><span class="nf">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="n">feed_item</span><span class="p">,</span> <span class="ss">method: :delete</span><span class="p">,</span>
                                     <span class="ss">data: </span><span class="p">{</span> <span class="ss">confirm: </span><span class="s2">"You sure?"</span> <span class="p">},</span>
                                     <span class="ss">title: </span><span class="n">feed_item</span><span class="p">.</span><span class="nf">content</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div>
<p>对删除微博的测试要用 Capybara 来点击“delete”链接，然后检测微博的数量是否减少了一个，如代码 10.45 所示。</p>

<div class="codeblock has-caption" id="codeblock-10-45"><p class="caption"><span>代码 10.45：</span>针对 Microposts 控制器 <code>destroy</code> 动作的测试</p><p class="file"><code>spec/requests/micropost_pages_spec.rb</code></p><div class="highlight type-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Micropost pages"</span> <span class="k">do</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">describe</span> <span class="s2">"micropost destruction"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user: </span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"as correct user"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

      <span class="n">it</span> <span class="s2">"should delete a micropost"</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">"delete"</span> <span class="p">}.</span><span class="nf">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">).</span><span class="nf">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>程序所需的代码还是和代码 9.46 中删除用户时类似，两种情况的主要不同之处是，删除微博不使用 <code>admin_user</code> 事前过滤器了，而是用 <code>correct_user</code> 事前过滤器，检查当前用户是否发布了指定 id 的微博，如代码 10.46 所示。图 10.17 显示的是删除了倒数第二个微博后的页面。</p>

<div class="codeblock has-caption" id="codeblock-10-46"><p class="caption"><span>代码 10.46：</span>Microposts 控制器的 <code>destroy</code> 动作</p><p class="file"><code>app/controllers/microposts_controller.rb</code></p><div class="highlight type-ruby"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">signed_in_user</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">]</span>
  <span class="n">before_action</span> <span class="p">:</span><span class="n">correct_user</span><span class="p">,</span>   <span class="ss">only: :destroy</span>
  <span class="p">.</span>
  <span class="nf">.</span>
  <span class="p">.</span>
  <span class="nf">def</span> <span class="n">destroy</span>
    <span class="vi">@micropost</span><span class="p">.</span><span class="nf">destroy</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">micropost_params</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">id: </span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span> <span class="k">if</span> <span class="vi">@micropost</span><span class="p">.</span><span class="nf">nil?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>注意，在 <code>correct_user</code> 事前过滤器中，我们是通过关联关系查寻微博的：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">current_user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">find_by_id</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
</pre></div>
</div>
<p>这行代码可以自行确保只在当前用户发布的微博中查询。这里，我们使用的是 <code>find_by</code>，而没用 <code>find</code>，因为如果没有找到微博 <code>find</code> 会抛出异常，而不会返回 <code>nil</code>。顺便说一下，如果你习惯处理 Ruby 异常，也可以按照下面的方式定义 <code>correct_user</code> 过滤器：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="k">def</span> <span class="nf">correct_user</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">microposts</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
<span class="k">rescue</span>
  <span class="n">redirect_to</span> <span class="n">root_url</span>
<span class="k">end</span>
</pre></div>
</div>
<p>你可能会说，我们也可以直接使用 <code>Micropost</code> 对象来实现 <code>correct_user</code> 过滤器，就像下面这样：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">id: </span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
<span class="n">redirect_to</span> <span class="n">root_url</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">.</span><span class="nf">user</span><span class="p">)</span>
</pre></div>
</div>
<p>这种实现方式基本上和代码 10.46 是一样的，不过，<a href="http://www.rubyfocus.biz/">Wolfram Arnold</a> 在《<a href="http://www.rubyfocus.biz/blog/2011/06/15/access_control_101_in_rails_and_the_citibank-hack.html">Access Control 101 in Rails and the Citibank Hack</a>》一文中解释过，安全起见，最好还是通过关联来查找。</p>

<div class="figure" id="figure-10-17">
  <img src="figures/home_post_delete_bootstrap.png" alt="home post delete bootstrap" />
  <p class="caption"><span>图 10.17：</span>删除了倒数第二篇微博后的首页</p>
</div>
<p>加入了本节的代码后，我们的 Micropost 模型以及用户界面就都完成了，测试组件也可以通过了：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>
<h2 id='section-10-4'><span>10.4</span> 小结</h2>


<p>加入了 Microposts 资源后，我们的示例程序基本上完成了。还没实现的部分是社交功能，让用户之间可以相互关注。在<a href="chapter11.html">第 11 章</a>中我们会学习如何实现这种关联关系，还要实现一个真正的动态列表。</p>

<p>如果你使用 Git 做版本控制的话，在继续之前，先提交改动，然后再合并到主分支：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>git add .
<span class="gp">$ </span>git commit -m <span class="s2">"Add user microposts"</span>
<span class="gp">$ </span>git checkout master
<span class="gp">$ </span>git merge user-microposts
<span class="gp">$ </span>git push
</pre></div>
</div>
<p>现在你也可以把程序推送到 Heroku 上。因为加入 <code>microposts</code> 表改动了数据模型，因此你需要在“生产数据库”中执行迁移操作：</p>

<div class="codeblock"><div class="highlight type-shell"><pre><span class="gp">$ </span>git push heroku
<span class="gp">$ </span>heroku pg:reset DATABASE
<span class="gp">$ </span>heroku run rake db:migrate
<span class="gp">$ </span>heroku run rake db:populate
</pre></div>
</div>
<h2 id='section-10-5'><span>10.5</span> 练习</h2>


<p>到目前为止，我们已经实现了很多功能，在现有功能的基础上我们还可以实现更多的功能，下面就是一些例子。</p>

<ol>
  <li>
    <p>添加测试，检测侧边栏中微博的数量是否正确显示了，要包含对单复数的检查。</p>
  </li>
  <li>
    <p>添加测试，检测微博的分页功能。</p>
  </li>
  <li>
    <p>重构首页的视图文件，把 <code>if-else</code> 语句的两个分支分别放到单独的局部视图中。</p>
  </li>
  <li>
    <p>编写一个测试，确保不是当前用户发布的微博下方不会显示删除链接。</p>
  </li>
  <li>
    <p>使用局部视图去掉代码 10.43 和代码 10.44 中的重复。</p>
  </li>
  <li>
    <p>现在，特别长的单词会撑破布局，如图 10.18 所示。使用代码 10.47 中定义的 <code>wrap</code> 帮助方法修正这个错误。注意，其中用到的 <code>raw</code> 方法是为了避免 Rails 转义 HTML 代码，<code>sanitize</code> 方法是为了防止跨站脚本攻击。这段代码还用到了看起来很奇怪但是很实用的三元操作符（ternary operator，参见<a href="chapter10.html#aside-10-1">旁注 10.1</a> 的说明）。</p>
  </li>
  <li>
    <p>（<strong>附加题</strong>）在首页中添加一段 JavaScript 代码，当在发布微博的表单中输入文字时，显示输入的内容与 140 个字符的差值。</p>
  </li>
</ol>

          <div class="aside box" id="aside-10-1">
  <h4><span>旁注 10.1：</span>三种人</h4>

  <p>世界上有三种人：一种喜欢用三元操作符，一种不喜欢，还有一种甚至不知道三元操作符是什么。（如果你不幸是第三种人的话，看过下面的说明就不再归属其中了。）</p>

  <p>在编写很多代码之后，你会发现最常用到的流程控制是类似下面这种：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="k">if</span> <span class="n">boolean?</span>
  <span class="n">do_one_thing</span>
<span class="k">else</span>
  <span class="n">do_something_else</span>
<span class="k">end</span>
</pre></div>
</div>
  <p>Ruby 和其他很多语言一样（包括 C/C++，Perl，PHP 和 Java），提供了一种更为简单的表达式来替换这种流程控制结构——三元操作符（之所以起了这个名字，是因为三元操作符涉及三个部分）：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">boolean?</span> <span class="p">?</span> <span class="n">do_one_thing</span> <span class="p">:</span> <span class="n">do_something_else</span>
</pre></div>
</div>
  <p>三元操作符甚至可以用来替代赋值操作：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="k">if</span> <span class="n">boolean?</span>
  <span class="n">var</span> <span class="o">=</span> <span class="n">foo</span>
<span class="k">else</span>
  <span class="n">var</span> <span class="o">=</span> <span class="n">bar</span>
<span class="k">end</span>
</pre></div>
</div>
  <p>可以改写成</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="n">var</span> <span class="o">=</span> <span class="n">boolean?</span> <span class="p">?</span> <span class="n">foo</span> <span class="p">:</span> <span class="n">bar</span>
</pre></div>
</div>
  <p>另外一个经常使用地方是在函数的返回值中：</p>

<div class="codeblock"><div class="highlight type-ruby"><pre><span class="k">def</span> <span class="nf">foo</span>
  <span class="n">do_stuff</span>
  <span class="n">boolean?</span> <span class="p">?</span> <span class="s2">"bar"</span> <span class="p">:</span> <span class="s2">"baz"</span>
<span class="k">end</span>
</pre></div>
</div>
  <p>因为 Ruby 函数的默认返回值是定义体中的最后一个表达式，所以 <code>foo</code> 方法的返回值会根据 <code>boolean?</code> 的结果而不同，不是 <code>"bar"</code> 就是 <code>"baz"</code>。代码 10.47 中就用到了这种结构。</p>
</div>


<div class="codeblock has-caption" id="codeblock-10-47"><p class="caption"><span>代码 10.47：</span>换行显示长单词的帮助方法</p><p class="file"><code>app/helpers/microposts_helper.rb</code></p><div class="highlight type-ruby"><pre><span class="k">module</span> <span class="nn">MicropostsHelper</span>

  <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">sanitize</span><span class="p">(</span><span class="n">raw</span><span class="p">(</span><span class="n">content</span><span class="p">.</span><span class="nf">split</span><span class="p">.</span><span class="nf">map</span><span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">wrap_long_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">}.</span><span class="nf">join</span><span class="p">(</span><span class="s1">' '</span><span class="p">)))</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">wrap_long_string</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">max_width</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
      <span class="n">zero_width_space</span> <span class="o">=</span> <span class="s2">"&amp;#8203;"</span>
      <span class="n">regex</span> <span class="o">=</span> <span class="sr">/.{1,</span><span class="si">#{</span><span class="n">max_width</span><span class="si">}</span><span class="sr">}/</span>
      <span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="nf">length</span> <span class="o">&lt;</span> <span class="n">max_width</span><span class="p">)</span> <span class="p">?</span> <span class="n">text</span> <span class="p">:</span>
                                  <span class="n">text</span><span class="p">.</span><span class="nf">scan</span><span class="p">(</span><span class="n">regex</span><span class="p">).</span><span class="nf">join</span><span class="p">(</span><span class="n">zero_width_space</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="figure" id="figure-10-18">
  <img src="figures/long_word_micropost_bootstrap.png" alt="long word micropost bootstrap" />
  <p class="caption"><span>图 10.18：</span>特别长的单词撑破了网站的布局</p>
</div>
<div class="footnotes">
  <ol>
    <li id="fn-10-1">
      <p>严格来说，我们在<a href="chapter8.html">第 8 章</a>中是把 session 当做资源来处理的，不过 session 不会像 Users 和 Microposts 资源那样被存入数据库。<a href="#fnref-10-1" rel="reference">↩</a></p>
    </li>
    <li id="fn-10-2">
      <p><code>content</code> 属性是字符串（<code>string</code>）类型，不过我们曾在 <a href="chapter2.html#section-2-1-2">2.1.2 节</a>中简要介绍过，较长的文本应该使用 <code>text</code> 类型。<a href="#fnref-10-2" rel="reference">↩</a></p>
    </li>
    <li id="fn-10-3">
      <p>例如自定义了头像的 5 个用户和 使用 Gravatar 默认头像的 1 个用户。<a href="#fnref-10-3" rel="reference">↩</a></p>
    </li>
    <li id="fn-10-4">
      <p>如果你对这个方法生成的 SQL 感兴趣，可以查看 <code>log/development.log</code> 文件。<a href="#fnref-10-4" rel="reference">↩</a></p>
    </li>
    <li id="fn-10-5">
      <p>Faker 中的 lorem ipsum 文本是被设计为随机生成的，所以你的示例微博可能和我的不一样。<a href="#fnref-10-5" rel="reference">↩</a></p>
    </li>
    <li id="fn-10-6">
      <p>为了行文方便，代码 10.21 实际上包含了本章用到的所有 CSS。<a href="#fnref-10-6" rel="reference">↩</a></p>
    </li>
    <li id="fn-10-7">
      <p>另外两个资源分别是 <a href="chapter7.html#section-7-2">7.2 节</a> 中的 Users 资源和 <a href="chapter8.html#section-8-1">8.1 节</a>中的 Sessions 资源。<a href="#fnref-10-7" rel="reference">↩</a></p>
    </li>
    <li id="fn-10-8">
      <p>我们在 <a href="chapter8.html#section-8-2-1">8.2.1 节</a>中介绍过，默认情况下帮助方法只能在视图中使用，因此要在控制器中使用 Sessions 帮助方法就要在 Application 控制器中加入代码 <code>include SessionHelper</code>。<a href="#fnref-10-8" rel="reference">↩</a></p>
    </li>
    <li id="fn-10-9">
      <p>我之所以在 <a href="chapter1.html#section-1-1-1">1.1.1 节</a>中推荐读者在读完本书后阅读一本纯介绍 Ruby 的书，就是为了学习使用类似 <code>include?</code> 这样的方法。<a href="#fnref-10-9" rel="reference">↩</a></p>
    </li>
    <li id="fn-10-10">
      <p>阅读 Rails 指南中的《<a href="http://guides.rubyonrails.org/active_record_querying.html">Active Record Query Interface</a>》一文，更深入的学习 <code>where</code> 等方法的用法。<a href="#fnref-10-10" rel="reference">↩</a></p>
    </li>
    <li id="fn-10-11">
      <p>很不幸，这样的话分页就不可用了。你可以加入分页，点击分页链接看一下是为什么。<a href="#fnref-10-11" rel="reference">↩</a></p>
    </li>
  </ol>
</div>

  	</div>
</div>

			
				
				<div class="navigation">
					
						<a class="prev_page" href="chapter9.html">&laquo; 第 9 章更新、显示和删除用户</a>
					
					
						<a class="next_page" href="chapter11.html">第 11 章关注用户 &raquo;</a>
					
				</div>
				
			
		</div>
		<div class="footer">
        	<p>&copy;2013 <a href="http://about.ac" title="Andor Chen 的个人网站">Andor Chen</a> 保留部分权力。在线阅读版本基于<a href="http://creativecommons.org/licenses/by-sa/3.0/" title="Creative Commons Attribution-ShareAlike 3.0 Unported License" target="_blank">“CC 3.0 BY-SA 协议”</a>发布</p>
		</div>
	</div>
</body>
</html>
